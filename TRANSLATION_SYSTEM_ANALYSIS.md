# ๐ ะะพะดัะพะฑะฝัะน ะฐะฝะฐะปะธะท ัะธััะตะผั ะฟะตัะตะฒะพะดะฐ ะณะปะฐะฒ ะฝะพะฒะตะปะปั

## ะะฑะทะพั

ะกะธััะตะผะฐ ะฐะฒัะพะผะฐัะธัะตัะบะพะณะพ ะฟะตัะตะฒะพะดะฐ ะบะธัะฐะนัะบะธั ะฒะตะฑ-ะฝะพะฒะตะปะป (ะถะฐะฝั ััะฝัั/ััะฝัะตะทะธ) ั ะบะธัะฐะนัะบะพะณะพ ะฝะฐ ััััะบะธะน ัะทัะบ ั ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ AI ะผะพะดะตะปะตะน (Gemini, OpenAI, Claude, Ollama, OpenRouter).

---

## ๐๏ธ ะััะธัะตะบัััะฐ ัะธััะตะผั ะฟะตัะตะฒะพะดะฐ

### 1๏ธโฃ ะัะฝะพะฒะฝัะต ะบะพะผะฟะพะฝะตะฝัั

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    WEB INTERFACE (Flask)                     โ
โ                   /api/chapters, /views.py                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              CELERY BACKGROUND TASKS (Redis)                 โ
โ           ะะฐัะฐะปะปะตะปัะฝะฐั ะพะฑัะฐะฑะพัะบะฐ ัะตัะตะท ThreadPool            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                   TRANSLATOR SERVICE                         โ
โ          ะะพะพัะดะธะฝะฐัะธั ะฟัะพัะตััะฐ ะฟะตัะตะฒะพะดะฐ + ะบะพะฝัะตะบัั            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              UNIVERSAL LLM TRANSLATOR                        โ
โ     ะฃะฝะธัะธัะธัะพะฒะฐะฝะฝัะน ะธะฝัะตััะตะนั + ัะพัะฐัะธั API ะบะปััะตะน          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                   AI ADAPTER SERVICE                         โ
โ        ะะดะฐะฟัะตัั ะดะปั Gemini, OpenAI, Claude, Ollama           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
                           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    AI MODEL PROVIDERS                        โ
โ         Gemini API, OpenAI API, Anthropic, Ollama            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ ะะพะปะฝัะน ะถะธะทะฝะตะฝะฝัะน ัะธะบะป ะฟะตัะตะฒะพะดะฐ ะณะปะฐะฒั

### ะคะฐะทะฐ 1: ะะฐััะธะฝะณ (ะะพะปััะตะฝะธะต ะพัะธะณะธะฝะฐะปัะฝะพะณะพ ัะตะบััะฐ)

**ะคะฐะนะป:** `web_app/app/celery_tasks.py` โ `parse_novel_chapters_task()` (ัััะพะบะธ 57-495)

#### ะัะพัะตัั:
1. **ะกะพะทะดะฐะฝะธะต ะฟะฐััะตัะฐ** ัะตัะตะท ัะฐะฑัะธะบั (`parsers/parser_factory.py`)
   - ะะฒัะพะพะฟัะตะดะตะปะตะฝะธะต ะธััะพัะฝะธะบะฐ ะฟะพ URL
   - ะะพะดะดะตัะถะบะฐ: czbooks.net, qidian.com, EPUB ัะฐะนะปั
   - ะะฐัััะพะนะบะฐ SOCKS5 ะฟัะพะบัะธ, cookies ะดะปั ะฐะฒัะพัะธะทะฐัะธะธ

2. **ะะพะปััะตะฝะธะต ัะฟะธัะบะฐ ะณะปะฐะฒ** (`parser.get_chapter_list()`)
   - ะะฐะณััะทะบะฐ ะพะณะปะฐะฒะปะตะฝะธั ะฝะพะฒะตะปะปั
   - ะะฑะฝะพะฒะปะตะฝะธะต `novel.total_chapters`

3. **ะะฐััะธะฝะณ ะบะพะฝัะตะฝัะฐ ะบะฐะถะดะพะน ะณะปะฐะฒั**:
   ```python
   for i, chapter_data in enumerate(chapters):
       # ะะฐะณััะทะบะฐ ะบะพะฝัะตะฝัะฐ ัะตัะตะท Selenium (ะดะปั czbooks) ะธะปะธ requests
       content = parser.get_chapter_content(chapter_data['url'])

       # ะัะธะผะตะฝะตะฝะธะต ัะตะบััะพะฒัั ัะธะปัััะพะฒ (ัะดะฐะปะตะฝะธะต ัะตะบะปะฐะผั, ะฟัะธะผะตัะฐะฝะธะน)
       if novel.config.get('filter_text'):
           content = apply_filters(content)

       # ะกะพััะฐะฝะตะฝะธะต ะฒ ะะ
       chapter = Chapter(
           novel_id=novel_id,
           chapter_number=i+1,
           original_text=content,      # โ ะะะขะะะกะะะ ะะะะะะะะ
           original_title=chapter_data['title'],
           status='parsed'
       )
       db.session.add(chapter)
   ```

4. **ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ**:
   - Cloudflare challenge โ ัะตัะตะฝะธะต ัะตัะตะท Qwen3-VL vision ะผะพะดะตะปั ะธะปะธ VNC
   - ะะพะฒัะพัะฝัะน ะฟะฐััะธะฝะณ ะฟัะพะฟััะตะฝะฝัั ะณะปะฐะฒ ั ัะฒะตะปะธัะตะฝะฝัะผ ัะฐะนะผะฐััะพะผ
   - ะะพะณะธัะพะฒะฐะฝะธะต ะฒัะตั ะดะตะนััะฒะธะน ัะตัะตะท `LogService`

**ะะตะทัะปััะฐั:** `chapter.original_text` ัะพะดะตัะถะธั ะบะธัะฐะนัะบะธะน ัะตะบัั, `status='parsed'`

---

### ะคะฐะทะฐ 2: ะะตัะตะฒะพะด (ะะธัะฐะนัะบะธะน โ ะัััะบะธะน)

**ะคะฐะนะป:** `web_app/app/services/translator_service.py` โ `translate_chapter()` (ัััะพะบะธ 738-1050)

#### ะจะฐะณ 2.1: ะะพะดะณะพัะพะฒะบะฐ ะบะพะฝัะตะบััะฐ

```python
# ะะฐะณััะทะบะฐ ัะฐะฑะปะพะฝะฐ ะฟัะพะผะฟัะฐ ะดะปั ะฝะพะฒะตะปะปั
prompt_template = chapter.novel.get_prompt_template()
# ะกะพะดะตัะถะธั:
# - translation_prompt: ะัะฝะพะฒะฝะพะน ะฟัะพะผะฟั ะดะปั ะฟะตัะตะฒะพะดะฐ
# - summary_prompt: ะัะพะผะฟั ะดะปั ะณะตะฝะตัะฐัะธะธ ัะตะทัะผะต
# - terms_extraction_prompt: ะัะพะผะฟั ะดะปั ะธะทะฒะปะตัะตะฝะธั ัะตัะผะธะฝะพะฒ

# ะกะพะทะดะฐะฝะธะต ะบะพะฝัะตะบััะฐ ะฟะตัะตะฒะพะดะฐ (TranslationContext)
context = TranslationContext(novel_id)
context_prompt = context.build_context_prompt()
```

**TranslationContext ะฒะบะปััะฐะตั** (ัััะพะบะธ 629-736):
- **ะะตะทัะผะต ะฟัะตะดัะดััะธั 5 ะณะปะฐะฒ** (`previous_summaries`) ะดะปั ะฟะพะฝะธะผะฐะฝะธั ััะถะตัะฐ
- **ะะปะพััะฐัะธะน ัะตัะผะธะฝะพะฒ** (`glossary`) ะฟะพ ะบะฐัะตะณะพัะธัะผ:
  - `characters`: ะะผะตะฝะฐ ะฟะตััะพะฝะฐะถะตะน
  - `locations`: ะะฐะทะฒะฐะฝะธั ะผะตัั
  - `terms`: ะขะตัะผะธะฝะพะปะพะณะธั ะถะฐะฝัะฐ (ะบัะปััะธะฒะฐัะธั, ัะตะบัั, ะธ ั.ะด.)
  - `techniques`: ะะพะตะฒัะต ัะตัะฝะธะบะธ
  - `artifacts`: ะััะตัะฐะบัั ะธ ัะพะบัะพะฒะธัะฐ

#### ะจะฐะณ 2.2: ะัะตะดะพะฑัะฐะฑะพัะบะฐ ัะตะบััะฐ

```python
# ะคัะฝะบัะธั preprocess_chapter_text() (ัััะพะบะธ 20-69)
text_to_translate = preprocess_text(chapter.original_text)

# ะงัะพ ะดะตะปะฐะตััั:
# 1. ะฃะดะฐะปะตะฝะธะต ะดะปะธะฝะฝัั ะฟะพะฒัะพัะตะฝะธะน ะทะฒัะบะพะฒัั ัััะตะบัะพะฒ
#    "Wooooooo" โ "Wooo..."
#    "Ahhhhhhh" โ "Ahhh..."
# 2. ะะฐะผะตะฝะฐ ะฟะพะฒัะพััััะธััั ัะธะผะฒะพะปะพะฒ (5+) ะฝะฐ ะบะพัะพัะบัั ะฒะตััะธั
#    ะญัะพ ะฟัะตะดะพัะฒัะฐัะฐะตั ะฟัะพะฑะปะตะผั ั ัะพะบะตะฝะธะทะฐัะธะตะน LLM
```

#### ะจะฐะณ 2.3: ะะฐะทะฑะธะตะฝะธะต ะฝะฐ ัะฐััะธ

```python
# ะะตัะพะด split_long_text() (ะฝะต ะฟะพะบะฐะทะฐะฝ ะฟะพะปะฝะพัััั)
text_parts = split_long_text(text_to_translate, force_small=False)

# ะะพะณะธะบะฐ ัะฐะทะฑะธะตะฝะธั:
# - ะัะปะธ ัะตะบัั < 15000 ัะธะผะฒะพะปะพะฒ โ ะพะดะฝะฐ ัะฐััั
# - ะัะปะธ 15000-30000 โ 2-3 ัะฐััะธ
# - ะัะปะธ > 30000 โ ัะฐะทะฑะธะฒะบะฐ ะฟะพ ะฟะฐัะฐะณัะฐัะฐะผ/ะฟัะตะดะปะพะถะตะฝะธัะผ
# - ultra_small=True โ ัะฐััะธ ะฟะพ ~100 ัะปะพะฒ (ะดะปั ะพะฑัะพะดะฐ ะฑะปะพะบะธัะพะฒะพะบ)
```

**ะัะธัะธะฝะฐ ัะฐะทะฑะธะตะฝะธั:**
- ะะณัะฐะฝะธัะตะฝะธั ัะพะบะตะฝะพะฒ LLM (ะพะฑััะฝะพ 128k-200k ะฒัะพะดะฝัั ัะพะบะตะฝะพะฒ)
- Gemini ะผะพะถะตั ะฑะปะพะบะธัะพะฒะฐัั ะดะปะธะฝะฝัะต ัะตะบััั ั "PROHIBITED_CONTENT"
- ะะตะปะบะธะต ัะฐััะธ ะฟัะพัะพะดัั ะผะพะดะตัะฐัะธั ััะฟะตัะฝะตะต

#### ะจะฐะณ 2.4: ะะตัะตะฒะพะด ะบะฐะถะดะพะน ัะฐััะธ ัะตัะตะท LLM

```python
for i, part in enumerate(text_parts):
    # ะะพะปััะตะฝะธะต ัะตะผะฟะตัะฐัััั ะธะท ะบะพะฝัะธะณะฐ ะฝะพะฒะตะปะปั
    temperature = novel.config.get('translation_temperature', 0.1)

    # ะะกะะะะะะ ะะะะะะก ะ LLM
    translated_part = translator.translate_text(
        text=part,                                    # ะงะฐััั ัะตะบััะฐ
        system_prompt=prompt_template.translation_prompt,  # ะัะพะผะฟั ะฟะตัะตะฒะพะดะฐ
        context=context_prompt,                       # ะะพะฝัะตะบัั (ะณะปะพััะฐัะธะน + ัะตะทัะผะต)
        chapter_id=chapter.id,
        temperature=temperature                       # ะัะตะฐัะธะฒะฝะพััั (0.1 = ัะพัะฝะพััั)
    )

    # ะะฑัะฐะฑะพัะบะฐ ะฑะปะพะบะธัะพะฒะบะธ ะบะพะฝัะตะฝัะฐ
    if translated_part == "CONTENT_BLOCKED_NEED_SPLIT":
        # ะะพะฟะพะปะฝะธัะตะปัะฝะพะต ัะฐะทะฑะธะตะฝะธะต ะฝะฐ ะผะธะฝะธ-ััะฐะณะผะตะฝัั
        sub_parts = split_into_sentences(part)
        for sub_part in sub_parts:
            sub_translation = translator.translate_text(...)
            translated_parts.append(sub_translation)
```

#### ะจะฐะณ 2.5: ะฆะตะฟะพัะบะฐ ะฒัะทะพะฒะพะฒ LLM

```
translate_text() (translator_service.py)
    โ
UniversalLLMTranslator.translate_text() (universal_llm_translator.py:450-459)
    โ
UniversalLLMTranslator.make_request() (ัััะพะบะธ 412-419)
    โ
UniversalLLMTranslator.make_request_async() (ัััะพะบะธ 98-410)
    โ
AIAdapterService.generate_content() (ai_adapter_service.py:86-115)
    โ
_call_gemini() / _call_openai() / _call_anthropic() / _call_ollama()
    โ
HTTP ะทะฐะฟัะพั ะบ API ะฟัะพะฒะฐะนะดะตัะฐ
```

#### ะจะฐะณ 2.6: ะะพัะฐัะธั API ะบะปััะตะน (Gemini)

**ะคะฐะนะป:** `universal_llm_translator.py` (ัััะพะบะธ 106-192)

```python
# ะะปั Gemini ั ะฝะตัะบะพะปัะบะธะผะธ ะบะปััะฐะผะธ
while attempts < max_attempts:
    # ะัะพะฟััะบะฐะตะผ ะฝะตัะฐะฑะพัะฐััะธะต ะบะปััะธ
    if current_key_index in failed_keys:
        switch_to_next_key()

    # ะกะพะทะดะฐะตะผ ะฒัะตะผะตะฝะฝัั ะผะพะดะตะปั ั ัะตะบััะธะผ ะบะปััะพะผ
    temp_model.api_key = current_key

    # ะัะฟัะฐะฒะปัะตะผ ะทะฐะฟัะพั
    result = await adapter.generate_content(...)

    if result['success']:
        return result['content']  # โ ะฃะกะะะฅ

    # ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ
    if 'Rate limit' in error:
        mark_key_as_failed()
        switch_to_next_key()

    attempts += 1

# ะัะปะธ ะฒัะต ะบะปััะธ failed
handle_full_cycle_failure():
    - ะะดะตะผ 30 ัะตะบัะฝะด
    - ะกะฑัะฐััะฒะฐะตะผ failed_keys
    - ะะพะฒัะพััะตะผ ะฟะพะฟััะบะธ
```

#### ะจะฐะณ 2.7: ะกะฟะตัะธะฐะปัะฝัะต ะพะฑัะฐะฑะพััะธะบะธ ะพัะธะฑะพะบ

**ะะปั Ollama** (ัะฝะธะฒะตััะฐะปัะฝัะน ะพะฑัะฐะฑะพััะธะบ ะฒ `universal_llm_translator.py`):

1. **Rate Limit (hourly)** (ัััะพะบะธ 320-397):
   - 4 ะฟะพะฟััะบะธ ั ะทะฐะดะตัะถะบะฐะผะธ: 1 ะผะธะฝ, 5 ะผะธะฝ, 15 ะผะธะฝ, 40 ะผะธะฝ
   - ะะพะณะธัะพะฒะฐะฝะธะต ะฒัะตะผะตะฝะธ ะพะถะธะดะฐะฝะธั ะบะฐะถะดัะต 60 ัะตะบัะฝะด

2. **Server Error 500 / Upstream 502/504 / Timeout** (ัััะพะบะธ 231-318):
   - 5 ะฟะพะฟััะพะบ ั ะทะฐะดะตัะถะบะฐะผะธ: 30 ัะตะบ, 2 ะผะธะฝ, 5 ะผะธะฝ, 10 ะผะธะฝ, 20 ะผะธะฝ
   - ะัะพะดะพะปะถะตะฝะธะต ัะพะปัะบะพ ะตัะปะธ ัะธะฟ ะพัะธะฑะบะธ ะฝะต ะธะทะผะตะฝะธะปัั

3. **Weekly/Daily Limits** (ัััะพะบะธ 215-229):
   - ะะตะผะตะดะปะตะฝะฝัะน ะฒััะพะด, ะฟะพะฒัะพัั ะฑะตััะผััะปะตะฝะฝั
   - ะะพะณะธัะพะฒะฐะฝะธะต ัะตะบะพะผะตะฝะดะฐัะธะน

**ะะปั Gemini:**
- PROHIBITED_CONTENT โ ะดะพะฑะฐะฒะปะตะฝะธะต "ะะะะะ: ะญัะพ ััะดะพะถะตััะฒะตะฝะฝะพะต ะฟัะพะธะทะฒะตะดะตะฝะธะต..."
- ะะพะฒัะพัะฝัะน ะทะฐะฟัะพั ั ะฟะพะผะตัะบะพะน ะพ ััะดะพะถะตััะฒะตะฝะฝะพะน ะปะธัะตัะฐัััะต

#### ะจะฐะณ 2.8: ะกะพััะฐะฝะตะฝะธะต ัะตะทัะปััะฐัะฐ

```python
# ะะฑัะตะดะธะฝะตะฝะธะต ะฟะตัะตะฒะตะดะตะฝะฝัั ัะฐััะตะน
full_translation = "\n\n".join(translated_parts)

# ะกะพะทะดะฐะฝะธะต ะทะฐะฟะธัะธ Translation
translation = Translation(
    chapter_id=chapter.id,
    translated_title=translate_title(chapter.original_title),
    translated_text=full_translation,    # โ ะะฃะกะกะะะ ะะะะะะะ
    translation_type='initial',          # ะขะธะฟ: initial (ะฝะต ะพััะตะดะฐะบัะธัะพะฒะฐะฝ)
    api_used=model.provider,             # gemini, ollama, openai
    model_used=model.model_id,           # gemini-2.0-flash-exp, qwen2.5:32b
    quality_score=None,                  # ะัะดะตั ะพัะตะฝะตะฝ ะฟะพะทะถะต
    translation_time=elapsed_time
)
db.session.add(translation)

# ะะฑะฝะพะฒะปะตะฝะธะต ััะฐัััะฐ ะณะปะฐะฒั
chapter.status = 'translated'
chapter.word_count_translated = len(full_translation)
db.session.commit()
```

**ะะตะทัะปััะฐั:** `chapter.status='translated'`, `chapter.current_translation` ัะพะดะตัะถะธั ััััะบะธะน ัะตะบัั

---

### ะคะฐะทะฐ 3: ะะตะดะฐะบัััะฐ (ะฃะปัััะตะฝะธะต ะบะฐัะตััะฒะฐ ะฟะตัะตะฒะพะดะฐ)

**ะคะฐะนะป:** `web_app/app/services/original_aware_editor_service.py` (ัััะพะบะธ 36-147)

#### ะะพัะตะผั ะฝัะถะฝะฐ ัะตะดะฐะบัััะฐ?

AI ะฟะตัะตะฒะพะด ะผะพะถะตั ัะพะดะตัะถะฐัั:
- โ ะะตัะพัะฝะพััะธ ะฒ ะฟะตัะตะดะฐัะต ัะผััะปะฐ ะพัะธะณะธะฝะฐะปะฐ
- โ ะะตัะพะพัะฒะตัััะฒะธั ัะตัะผะธะฝะพะปะพะณะธะธ ะณะปะพััะฐัะธั
- โ ะะตะตััะตััะฒะตะฝะฝัะต ะบะพะฝััััะบัะธะธ ััััะบะพะณะพ ัะทัะบะฐ
- โ ะัะพะฟััะตะฝะฝัะต ะดะตัะฐะปะธ ะธะท ะบะธัะฐะนัะบะพะณะพ ัะตะบััะฐ

#### ะญัะฐะฟั ัะตะดะฐะบัััั (ะธัะฟะพะปัะทัะตััั ะพัะธะณะธะฝะฐะปัะฝัะน ัะตะบัั!):

```python
def edit_chapter(chapter: Chapter) -> bool:
    # ะะฐะณััะทะบะฐ ะะะะะซะฅ ะดะฐะฝะฝัั
    original_text = chapter.original_text          # ะะธัะฐะนัะบะธะน ะพัะธะณะธะฝะฐะป
    translated_text = chapter.current_translation.translated_text  # ะัััะบะธะน ะฟะตัะตะฒะพะด
    glossary = load_prioritized_glossary(chapter.novel_id)

    # --- ะญะขะะ 1: ะะะะะะ ะะะงะะกะขะะ ะก ะะะะะะะะะะ ---
    strategy = analyze_with_original(original_text, translated_text, glossary)

    # ะัะตะฝะบะฐ:
    # - quality_score (0-10): ะะฑัะฐั ะพัะตะฝะบะฐ ะบะฐัะตััะฒะฐ
    # - missing_details: ะัะพะฟััะตะฝะฝัะต ะดะตัะฐะปะธ ะธะท ะพัะธะณะธะฝะฐะปะฐ
    # - needs_glossary_fix: ะัะถะฝะฐ ะปะธ ะบะพััะตะบัะธั ัะตัะผะธะฝะพะฒ
    # - needs_style: ะัะถะฝะพ ะปะธ ัะปัััะตะฝะธะต ััะธะปั
    # - needs_dialogue: ะัะถะฝะฐ ะปะธ ะฟะพะปะธัะพะฒะบะฐ ะดะธะฐะปะพะณะพะฒ
    # - needs_polish: ะัะถะฝะฐ ะปะธ ัะธะฝะฐะปัะฝะฐั ะฟะพะปะธัะพะฒะบะฐ

    # --- ะญะขะะ 2: ะะกะะะะะะะะะ ะะะกะะะขะะะขะกะขะะะ ---
    if strategy['needs_glossary_fix'] or missing_details:
        edited_text = fix_with_original(original_text, edited_text, glossary)
    # ะัะพะผะฟั: "ะัะฟัะฐะฒั ะฝะตัะพะพัะฒะตัััะฒะธั ั ะพัะธะณะธะฝะฐะปะพะผ, ะดะพะฑะฐะฒั ะฟัะพะฟััะตะฝะฝัะต ะดะตัะฐะปะธ"

    # --- ะญะขะะ 3: ะฃะะฃะงะจะะะะ ะกะขะะะฏ ---
    if strategy['needs_style']:
        edited_text = improve_style_with_original(original_text, edited_text, glossary)
    # ะัะพะผะฟั: "ะฃะปัััะธ ะปะธัะตัะฐัััะฝัะน ััะธะปั, ัะพััะฐะฝัั ัะพัะฝะพััั ะพัะธะณะธะฝะฐะปะฐ"

    # --- ะญะขะะ 4: ะะะะะะะะะ ะะะะะะะะ ---
    if strategy['needs_dialogue']:
        edited_text = polish_dialogues_with_original(original_text, edited_text, glossary)
    # ะัะพะผะฟั: "ะฃะปัััะธ ะดะธะฐะปะพะณะธ, ะฟัะพะฒะตัั ัะพะพัะฒะตัััะฒะธะต ะพัะธะณะธะฝะฐะปั"

    # --- ะญะขะะ 5: ะคะะะะะฌะะะฏ ะะะะะะะะะ ---
    if strategy['needs_polish']:
        edited_text = final_polish_with_original(original_text, edited_text, glossary)
    # ะัะพะผะฟั: "ะคะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ ะฒัะตั ะฐัะฟะตะบัะพะฒ"

    # ะะะะขะะงะะกะะะฏ ะะะะะะะะ
    if edited_text == translated_text:
        return False  # ะขะตะบัั ะฝะต ะธะทะผะตะฝะธะปัั = ะพัะธะฑะบะฐ ัะตะดะฐะบัััั

    # ะะฐะปะธะดะฐัะธั
    if not validate_with_original(original_text, edited_text, glossary):
        return False

    # ะกะพััะฐะฝะตะฝะธะต
    save_edited_translation(chapter, edited_text, quality_score + 3)
    chapter.status = 'edited'
    db.session.commit()
```

#### ะะตัะพะดั ัะตะดะฐะบัััั (ะฝะฐัะปะตะดัะตั ะพั GlossaryAwareEditorService):

1. **`analyze_with_original()`**: ะกัะฐะฒะฝะธะฒะฐะตั ะฟะตัะตะฒะพะด ั ะพัะธะณะธะฝะฐะปะพะผ, ะฒััะฒะปัะตั ะฟัะพะฑะปะตะผั
2. **`fix_with_original()`**: ะัะฟัะฐะฒะปัะตั ะพัะธะฑะบะธ ะฝะฐ ะพัะฝะพะฒะต ะพัะธะณะธะฝะฐะปัะฝะพะณะพ ัะตะบััะฐ
3. **`improve_style_with_original()`**: ะฃะปัััะฐะตั ััะธะปั, ัะพััะฐะฝัั ัะผััะป ะพัะธะณะธะฝะฐะปะฐ
4. **`polish_dialogues_with_original()`**: ะะพะปะธััะตั ะดะธะฐะปะพะณะธ ะฟะพ ะพัะธะณะธะฝะฐะปั
5. **`final_polish_with_original()`**: ะคะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ ะธ ะฟะพะปะธัะพะฒะบะฐ

**ะะปััะตะฒะฐั ะพัะพะฑะตะฝะฝะพััั:** ะะฐะถะดัะน ััะฐะฟ ัะตะดะฐะบัััั ะฟะพะปััะฐะตั **ะพัะธะณะธะฝะฐะปัะฝัะน ะบะธัะฐะนัะบะธะน ัะตะบัั**, ััะพ ะฟะพะทะฒะพะปัะตั LLM ะฟัะพะฒะตัััั ัะพัะฝะพััั ะฟะตัะตะฒะพะดะฐ, ััะฐะฒะฝะธะฒะฐั ั ะธััะพัะฝะธะบะพะผ.

#### ะกะพััะฐะฝะตะฝะธะต ัะตะทัะปััะฐัะฐ ัะตะดะฐะบัััั:

```python
edited_translation = Translation(
    chapter_id=chapter.id,
    translated_title=chapter.current_translation.translated_title,
    translated_text=edited_text,         # โ ะะขะะะะะะขะะะะะะะะซะ ะขะะะกะข
    translation_type='edited',           # ะขะธะฟ: edited
    api_used=model.provider,
    model_used=model.model_id,
    quality_score=improved_score,        # ะะพะฒััะตะฝะฝะฐั ะพัะตะฝะบะฐ
    translation_time=editing_time
)
db.session.add(edited_translation)

chapter.status = 'edited'
chapter.edited_text = edited_text        # ะัั ะดะปั ะฑััััะพะณะพ ะดะพัััะฟะฐ
db.session.commit()
```

**ะะตะทัะปััะฐั:** `chapter.status='edited'`, `chapter.edited_translation` ัะพะดะตัะถะธั ัะธะฝะฐะปัะฝัะน ัะตะบัั

---

## ๐๏ธ ะะฐัะฐะผะตััั ะธ ะฝะฐัััะพะนะบะธ ะฟะตัะตะฒะพะดะฐ

### ะะพะฝัะธะณััะฐัะธั Novel (ััะฐะฝะธััั ะฒ `novel.config` JSON):

```python
novel.config = {
    # --- ะะะะะะฌ ะ ะะะะะะะขะะซ ---
    'translation_model': 'gemini-2.0-flash-exp',  # ID ะผะพะดะตะปะธ ะธะท ai_models
    'translation_temperature': 0.1,               # ะัะตะฐัะธะฒะฝะพััั (0.0-1.0)
    'editing_temperature': 0.3,                   # ะขะตะผะฟะตัะฐัััะฐ ะดะปั ัะตะดะฐะบัััั

    # --- ะะะะะะะะะฌะะะกะขะฌ ---
    'editing_threads': 3,                         # ะะพัะพะบะธ ะดะปั ัะตะดะฐะบัััั (1-10)
    'alignment_threads': 3,                       # ะะพัะพะบะธ ะดะปั ะฒััะฐะฒะฝะธะฒะฐะฝะธั

    # --- ะคะะะฌะขะะซ ะขะะะกะขะ ---
    'filter_text': 'czbooks.net\nะัะพะดะพะปะถะตะฝะธะต ัะปะตะดัะตั...\n',  # ะฃะดะฐะปัะตะผัะต ะฟะฐััะตัะฝั
}
```

### ะะพะดะตะปั AIModel (ัะฐะฑะปะธัะฐ `ai_models`):

```python
ai_model = AIModel(
    name='Gemini 2.0 Flash Exp',
    provider='gemini',                    # gemini, openai, anthropic, ollama
    model_id='gemini-2.0-flash-exp',
    api_key='AIzaSy...',                  # ะะดะธะฝ ะบะปัั
    api_keys=['key1', 'key2', 'key3'],    # ะะปะธ ัะฟะธัะพะบ ะดะปั ัะพัะฐัะธะธ
    api_endpoint='https://generativelanguage.googleapis.com/v1beta',

    # ะะธะผะธัั
    max_input_tokens=1048576,             # 1M ัะพะบะตะฝะพะฒ
    max_output_tokens=8192,

    # ะะฐัะฐะผะตััั ะฟะพ ัะผะพะปัะฐะฝะธั
    default_temperature=0.1,
    supports_system_prompt=True,

    # ะะตัะฐะดะฐะฝะฝัะต
    is_active=True,
    is_default=False
)
```

### ะัะพะผะฟั-ัะฐะฑะปะพะฝ PromptTemplate:

```python
template = PromptTemplate(
    name='ะกัะฝััั ะฟะตัะตะฒะพะด v2',
    category='xianxia',

    # ะัะฝะพะฒะฝะพะน ะฟัะพะผะฟั ะดะปั ะฟะตัะตะฒะพะดะฐ
    translation_prompt='''
ะขั ะฟัะพัะตััะธะพะฝะฐะปัะฝัะน ะฟะตัะตะฒะพะดัะธะบ ะบะธัะฐะนัะบะธั ะฒะตะฑ-ะฝะพะฒะตะปะป ะถะฐะฝัะฐ ััะฝััั.

ะะะะะงะ: ะะตัะตะฒะตะดะธ ัะปะตะดัััะธะน ัะตะบัั ั ะบะธัะฐะนัะบะพะณะพ ะฝะฐ ััััะบะธะน ัะทัะบ.

ะขะะะะะะะะะฏ:
1. ะกะพััะฐะฝะธ ะฒัะต ะธะผะตะฝะฐ ะฟะตััะพะฝะฐะถะตะน ะธ ัะตัะผะธะฝั ะธะท ะณะปะพััะฐัะธั
2. ะะตัะตะฒะตะดะธ ะผะฐะบัะธะผะฐะปัะฝะพ ัะพัะฝะพ, ัะพััะฐะฝัั ะฐัะผะพััะตัั ะพัะธะณะธะฝะฐะปะฐ
3. ะัะฟะพะปัะทัะน ะตััะตััะฒะตะฝะฝัะน ััััะบะธะน ัะทัะบ
4. ะะต ะดะพะฑะฐะฒะปัะน ะบะพะผะผะตะฝัะฐัะธะธ, ะฟะตัะตะฒะพะดะธ ัะพะปัะบะพ ัะตะบัั
''',

    # ะัะพะผะฟัั ะดะปั ัะตะดะฐะบัััั
    editing_analysis_prompt='ะัะพะฐะฝะฐะปะธะทะธััะน ะบะฐัะตััะฒะพ ะฟะตัะตะฒะพะดะฐ...',
    editing_style_prompt='ะฃะปัััะธ ะปะธัะตัะฐัััะฝัะน ััะธะปั...',

    # ะะฐัะฐะผะตััั
    temperature=0.1,
    max_tokens=24000
)
```

---

## ๐ข ะัะตะฝะบะฐ ัะพะบะตะฝะพะฒ ะธ ะพะฟัะธะผะธะทะฐัะธั

### ะะดะฐะฟัะธะฒะฝะฐั ะพัะตะฝะบะฐ ัะพะบะตะฝะพะฒ (ai_adapter_service.py:41-84):

```python
def _estimate_tokens(text: str) -> int:
    # ะะพะดััะตั ัะธะฟะพะฒ ัะธะผะฒะพะปะพะฒ
    cyrillic_count = count_cyrillic(text)
    cjk_count = count_cjk(text)

    # ะัะฑะพั ะบะพัััะธัะธะตะฝัะฐ ะฝะฐ ะพัะฝะพะฒะต ัะทัะบะฐ
    if cjk_count / len(text) > 0.3:
        chars_per_token = 1.5         # ะะธัะฐะนัะบะธะน: ~1.5 ัะธะผะฒะพะปะฐ/ัะพะบะตะฝ
        language = "ะบะธัะฐะนัะบะธะน"
    elif cyrillic_count / len(text) > 0.3:
        chars_per_token = 2.5         # ะัััะบะธะน: ~2.5 ัะธะผะฒะพะปะฐ/ัะพะบะตะฝ
        language = "ััััะบะธะน"
    else:
        chars_per_token = 4.0         # ะะฝะณะปะธะนัะบะธะน: ~4 ัะธะผะฒะพะปะฐ/ัะพะบะตะฝ
        language = "ะฐะฝะณะปะธะนัะบะธะน/ะปะฐัะธะฝะธัะฐ"

    return int(len(text) / chars_per_token)
```

### ะะฐัะฐะผะตััั Ollama ะทะฐะฟัะพัะพะฒ (ai_adapter_service.py:303-326):

```python
# ะัะตะฝะบะฐ ัะพะบะตะฝะพะฒ ะฟัะพะผะฟัะฐ
prompt_tokens = _estimate_tokens(system_prompt + user_prompt)

# num_ctx = ะฟัะพะผะฟั + 20% ะฑััะตั (ะผะธะฝะธะผัะผ 2048)
num_ctx = max(2048, int(prompt_tokens * 1.2))

# num_predict = num_ctx ร 2 (ะฝะพ ะฝะต ะฑะพะปััะต max_output_tokens)
num_predict = min(num_ctx * 2, model.max_output_tokens)

# ะะพะณะธัะพะฒะฐะฝะธะต
LogService.log_info(f"[Novel:{novel_id}, Ch:{chapter_num}] Ollama ะทะฐะฟัะพั: "
                   f"{model.model_id} | Temperature: {temperature} | "
                   f"Num ctx: {num_ctx:,} | Num predict: {num_predict:,}")
```

---

## ๐ ะกัะฐัะธััะธะบะฐ ะธ ะผะตััะธะบะธ

### ะกะพััะฐะฝะตะฝะธะต ะธััะพัะธะธ ะฟัะพะผะฟัะพะฒ (PromptHistory):

```python
PromptHistory.save_prompt(
    chapter_id=chapter_id,
    prompt_type='translation',           # translation, editing, summary
    system_prompt=system_prompt,
    user_prompt=user_prompt,
    response=llm_response,
    api_key_index=key_index,
    model_used=model.model_id,
    temperature=temperature,
    tokens_used=usage['total_tokens'],
    finish_reason='STOP',                # STOP, MAX_TOKENS, ERROR
    execution_time=elapsed_time,
    success=True,
    error_message=None
)
```

### ะะตััะธะบะธ Translation:

```python
translation = Translation(
    chapter_id=chapter.id,
    translated_title='ะะปะฐะฒะฐ 1: ะะฐัะฐะปะพ ะฟััะธ',
    translated_text='...',
    translation_type='initial',          # initial, edited
    api_used='ollama',
    model_used='qwen2.5:32b',
    quality_score=8,                     # 0-10
    translation_time=45.3,               # ัะตะบัะฝะดั
    tokens_used=15420,
    created_at=datetime.utcnow()
)
```

---

## ๐ ะะปะพััะฐัะธะน ะธ ัะตัะผะธะฝะพะปะพะณะธั

### ะกัััะบัััะฐ ะณะปะพััะฐัะธั (GlossaryItem):

```python
glossary_item = GlossaryItem(
    novel_id=novel_id,
    english_term='Qi Condensation',      # ะะฝะณะปะธะนัะบะฐั ััะฐะฝัะปะธัะตัะฐัะธั/ะฟะตัะตะฒะพะด
    russian_term='ะะพะฝะดะตะฝัะฐัะธั ะฆะธ',      # ะัััะบะธะน ะฟะตัะตะฒะพะด
    category='terms',                    # characters, locations, terms, techniques, artifacts
    description='ะะตัะฒะฐั ัััะฟะตะฝั ะบัะปััะธะฒะฐัะธะธ',
    first_appearance_chapter=1,
    is_auto_generated=False,             # ะะฒัะพะผะฐัะธัะตัะบะธ ะธะทะฒะปะตัะตะฝ ะธะปะธ ะฒัััะฝัั ะดะพะฑะฐะฒะปะตะฝ
    is_active=True
)
```

### ะัะธะพัะธัะธะทะฐัะธั ัะตัะผะธะฝะพะฒ:

```python
def _load_prioritized_glossary(novel_id):
    # 1. ะกะฟะตัะธัะธัะฝัะต ัะตัะผะธะฝั ะญะขะะ ะฝะพะฒะตะปะปั
    novel_specific = GlossaryItem.query.filter_by(
        novel_id=novel_id,
        is_active=True
    ).all()

    # 2. ะะฑัะธะต ัะตัะผะธะฝั ะถะฐะฝัะฐ (novel_id=NULL ะธะปะธ ะพะฑัะธะน ะณะปะพััะฐัะธะน)
    general_terms = GlossaryItem.query.filter_by(
        novel_id=None,
        category='xianxia_common',
        is_active=True
    ).all()

    # ะัะธะพัะธัะตั: novel_specific > general_terms
    return merge_glossaries(novel_specific, general_terms)
```

---

## โก ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั ะธ ะพะฟัะธะผะธะทะฐัะธั

### ะะฐัะฐะปะปะตะปัะฝะฐั ะพะฑัะฐะฑะพัะบะฐ (Celery + ThreadPoolExecutor):

```python
# celery_tasks.py:edit_novel_chapters_task (ัััะพะบะธ 532-829)

@celery.task(bind=True, soft_time_limit=172800)  # 48 ัะฐัะพะฒ
def edit_novel_chapters_task(self, novel_id, chapter_ids, parallel_threads=3):
    # ะะพะปััะฐะตะผ ะฝะฐัััะพะนะบั ะธะท ะบะพะฝัะธะณะฐ ะฝะพะฒะตะปะปั
    parallel_threads = novel.config.get('editing_threads', 3)

    # Thread-safe ััะตััะธะบะธ
    counter_lock = Lock()
    success_count = 0
    processed_count = 0

    def edit_single_chapter(chapter_id):
        # ะะฐะถะดัะน ะฟะพัะพะบ ัะพะทะดะฐะตั ัะฒะพะน app_context ะดะปั ะธะทะพะปััะธะธ ะะ
        with app.app_context():
            chapter = Chapter.query.get(chapter_id)

            # ะะะฉะะขะ ะะข ะะฃะะะะะะะะะะฏ
            if chapter.status == 'edited':
                return False  # ะัะพะฟััะบะฐะตะผ

            # ะะตะดะฐะบัะธััะตะผ
            result = editor_service.edit_chapter(chapter)

            # Thread-safe ะพะฑะฝะพะฒะปะตะฝะธะต
            with counter_lock:
                success_count += 1
                novel.edited_chapters = success_count
                db.session.commit()

    # ะะฐัะฐะปะปะตะปัะฝะฐั ะพะฑัะฐะฑะพัะบะฐ ัะตัะตะท ThreadPool
    with ThreadPoolExecutor(max_workers=parallel_threads) as executor:
        futures = {executor.submit(edit_single_chapter, ch_id): ch_id
                   for ch_id in chapter_ids}

        for future in as_completed(futures):
            result = future.result()
            # ะะฑะฝะพะฒะปัะตะผ ะฟัะพะณัะตัั
            progress = (processed_count / total_chapters) * 100
            self.update_state(state='PROGRESS', meta={'progress': progress})
```

**ะะตะบะพะผะตะฝะดะฐัะธะธ:**
- `parallel_threads=3` ะพะฟัะธะผะฐะปัะฝะพ (ะฑะฐะปะฐะฝั ัะบะพัะพััั/ะฝะฐะณััะทะบะฐ)
- ะะตะฝััะต 2: ะผะตะดะปะตะฝะฝะพ
- ะะพะปััะต 5: ะฟะตัะตะณััะทะบะฐ AI API ะธ ะะ

### ะัะตะฝะบะฐ ะฒัะตะผะตะฝะธ:

ะะปั ะฝะพะฒะตะปะปั **1000 ะณะปะฐะฒ**:

| ะญัะฐะฟ | ะัะตะผั ะฝะฐ ะณะปะฐะฒั | ะะฑัะตะต ะฒัะตะผั |
|------|---------------|-------------|
| ะะฐััะธะฝะณ | 5-15 ัะตะบ | 1.5-4 ัะฐัะฐ |
| ะะตัะตะฒะพะด | 30-60 ัะตะบ | 8-17 ัะฐัะพะฒ |
| ะะตะดะฐะบัััะฐ | 40-80 ัะตะบ | 11-22 ัะฐัะฐ |
| **ะะขะะะ** | **~1.5-2.5 ะผะธะฝ** | **~24-48 ัะฐัะพะฒ** |

*ะก 3 ะฟะพัะพะบะฐะผะธ: ~8-16 ัะฐัะพะฒ (3x ััะบะพัะตะฝะธะต)*

---

## ๐ก๏ธ ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ ะธ ะฝะฐะดะตะถะฝะพััั

### ะะฝะพะณะพััะพะฒะฝะตะฒะฐั ัะธััะตะผะฐ ะฟะพะฒัะพัะพะฒ:

1. **ะฃัะพะฒะตะฝั API ะบะปััะตะน** (Gemini):
   - ะะพัะฐัะธั ะผะตะถะดั 3+ ะบะปััะฐะผะธ
   - ะะพะผะตัะฐะตั failed ะบะปััะธ
   - ะกะฑัะพั ะฟะพัะปะต 3 ะฟะพะปะฝัั ัะธะบะปะพะฒ (5 ะผะธะฝัั ะพะถะธะดะฐะฝะธั)

2. **ะฃัะพะฒะตะฝั ะฟัะพะฒะฐะนะดะตัะฐ** (Ollama):
   - Rate limit: 4 ะฟะพะฟััะบะธ (60+ ะผะธะฝัั ะพะถะธะดะฐะฝะธั)
   - Server error: 5 ะฟะพะฟััะพะบ (38+ ะผะธะฝัั ะพะถะธะดะฐะฝะธั)
   - Timeout: 2 ะฟะพะฟััะบะธ

3. **ะฃัะพะฒะตะฝั ะบะพะฝัะตะฝัะฐ**:
   - PROHIBITED_CONTENT โ ะดะพะฑะฐะฒะปะตะฝะธะต disclaimer ะพ ััะดะพะถะตััะฒะตะฝะฝะพะน ะปะธัะตัะฐัััะต
   - ะัะปะธ ะฝะต ะฟะพะผะพะณะปะพ โ ัะฐะทะฑะธะตะฝะธะต ะฝะฐ ะผะตะปะบะธะต ัะฐััะธ
   - ultra_small=True โ ัะฐััะธ ะฟะพ 100 ัะปะพะฒ

4. **ะฃัะพะฒะตะฝั ะทะฐะดะฐั** (Celery):
   - ะะฐัะธัะฐ ะพั ะดัะฑะปะธัะพะฒะฐะฝะธั (`chapter.status == 'edited'`)
   - Graceful shutdown ะฟัะธ ะพัะผะตะฝะต
   - ะกะพััะฐะฝะตะฝะธะต ะฟัะพะผะตะถััะพัะฝัั ัะตะทัะปััะฐัะพะฒ

### ะะพะณะธัะพะฒะฐะฝะธะต (LogService):

```python
# ะะพะฝัะตะบััะฝะพะต ะปะพะณะธัะพะฒะฐะฝะธะต
LogService.log_info(
    f"[Novel:{novel_id}, Ch:{chapter_number}] ะะตัะตะฒะพะด ัะฐััะธ 1/3",
    novel_id=novel_id,
    chapter_id=chapter_id
)

# ะฃัะพะฒะฝะธ ะปะพะณะธัะพะฒะฐะฝะธั
LogService.log_info()     # ะะฝัะพัะผะฐัะธั
LogService.log_warning()  # ะัะตะดัะฟัะตะถะดะตะฝะธั
LogService.log_error()    # ะัะธะฑะบะธ

# ะะพะณะธ ัะพััะฐะฝััััั:
# - ะ ะะ (ัะฐะฑะปะธัะฐ log_entries)
# - ะ ัะฐะนะป (logs/app.log ั ัะพัะฐัะธะตะน)
# - ะ ะบะพะฝัะพะปั (ะดะปั ัะฐะทัะฐะฑะพัะบะธ)
```

---

## ๐ ะะปััะตัะฝะฐัะธะฒะฝัะต ะฟัะพะฒะฐะนะดะตัั

### ะะพะดะดะตัะถะธะฒะฐะตะผัะต AI ะฟัะพะฒะฐะนะดะตัั:

| ะัะพะฒะฐะนะดะตั | ะะพะดะตะปะธ | ะัะพะฑะตะฝะฝะพััะธ |
|-----------|--------|-------------|
| **Gemini** | gemini-2.0-flash-exp, gemini-1.5-pro | โ ะะพัะฐัะธั ะบะปััะตะน<br>โ 1M ัะพะบะตะฝะพะฒ input<br>โ๏ธ ะะปะพะบะธััะตั ะบะพะฝัะตะฝั |
| **Ollama** | qwen2.5:32b, qwen3-vl:8b, llama3:70b | โ ะะพะบะฐะปัะฝะพ (ะฑะตัะฟะปะฐัะฝะพ)<br>โ ะะตั ะฑะปะพะบะธัะพะฒะพะบ<br>โ๏ธ ะะตะดะปะตะฝะฝะพ<br>โ๏ธ Rate limits |
| **OpenAI** | gpt-4-turbo, gpt-3.5-turbo | โ ะกัะฐะฑะธะปัะฝะพ<br>๐ฐ ะะพัะพะณะพ |
| **Anthropic** | claude-3-opus, claude-3-sonnet | โ ะะฐัะตััะฒะพ<br>๐ฐ ะะพัะพะณะพ |
| **OpenRouter** | ะัะฑัะต (meta-llama/llama-3.1-405b) | โ ะะดะธะฝัะน API<br>๐ฐ ะะพ ัะฐัะธัะฐะผ |

### ะะพะฝัะธะณััะฐัะธั ะดะปั ัะฐะทะฝัั ะฟัะพะฒะฐะนะดะตัะพะฒ:

```python
# Gemini (ัะตะบะพะผะตะฝะดัะตััั ะดะปั ัะบะพัะพััะธ)
novel.config['translation_model'] = 'gemini-2.0-flash-exp'
novel.config['translation_temperature'] = 0.1

# Ollama (ะดะปั ะฑะตัะฟะปะฐัะฝะพะณะพ ะธัะฟะพะปัะทะพะฒะฐะฝะธั)
novel.config['translation_model'] = 'qwen2.5:32b'
novel.config['translation_temperature'] = 0.5  # Ollama ะปัััะต ั 0.5

# OpenAI (ะดะปั ะผะฐะบัะธะผะฐะปัะฝะพะณะพ ะบะฐัะตััะฒะฐ)
novel.config['translation_model'] = 'gpt-4-turbo'
novel.config['translation_temperature'] = 0.1
```

---

## ๐ ะัะฒะพะดั

### ะัะตะธะผััะตััะฒะฐ ัะธััะตะผั:

1. โ **ะะฝะพะณะพััะฐะฟะฝะฐั ะพะฑัะฐะฑะพัะบะฐ**: ะะฐััะธะฝะณ โ ะะตัะตะฒะพะด โ ะะตะดะฐะบัััะฐ ั ะพัะธะณะธะฝะฐะปะพะผ
2. โ **ะฃะผะฝะฐั ัะพัะฐัะธั ะบะปััะตะน**: ะะฑัะพะด rate limits ัะตัะตะท ะฐะฒัะพะฟะตัะตะบะปััะตะฝะธะต
3. โ **ะะพะฝัะตะบััะฝัะน ะฟะตัะตะฒะพะด**: ะะปะพััะฐัะธะน + ัะตะทัะผะต ะฟัะตะดัะดััะธั ะณะปะฐะฒ
4. โ **ะัะพะฒะตัะบะฐ ั ะพัะธะณะธะฝะฐะปะพะผ**: ะะตะดะฐะบัััะฐ ัะฒะตััะตั ะฟะตัะตะฒะพะด ั ะบะธัะฐะนัะบะธะผ ัะตะบััะพะผ
5. โ **ะะฐัะฐะปะปะตะปัะฝะฐั ะพะฑัะฐะฑะพัะบะฐ**: ThreadPoolExecutor ะดะปั ัะบะพัะพััะธ
6. โ **ะะดะฐะฟัะธะฒะฝะพะต ัะฐะทะฑะธะตะฝะธะต**: ะะฑัะพะด ะฑะปะพะบะธัะพะฒะพะบ ะบะพะฝัะตะฝัะฐ
7. โ **ะัะปััะธะฟัะพะฒะฐะนะดะตั**: ะะพะดะดะตัะถะบะฐ 5 AI ะฟัะพะฒะฐะนะดะตัะพะฒ
8. โ **ะะพะปะฝะพะต ะปะพะณะธัะพะฒะฐะฝะธะต**: ะััะปะตะถะธะฒะฐะฝะธะต ะบะฐะถะดะพะณะพ ััะฐะฟะฐ
9. โ **ะััะพัะธั ะฟัะพะผะฟัะพะฒ**: ะัะปะฐะดะบะฐ ะธ ัะปัััะตะฝะธะต ะบะฐัะตััะฒะฐ

### ะฃะฝะธะบะฐะปัะฝัะต ะพัะพะฑะตะฝะฝะพััะธ:

- ๐ค **Cloudflare ัะตัะตะฝะธะต ัะตัะตะท Qwen3-VL**: ะะฒัะพะผะฐัะธัะตัะบะพะต ะฟัะพัะพะถะดะตะฝะธะต challenge
- ๐ **ะขะตัะผะธะฝะพะปะพะณะธัะตัะบะธะน ะณะปะพััะฐัะธะน**: ะะพะฝัะธััะตะฝัะฝะพััั ะฟะตัะตะฒะพะดะพะฒ
- ๐ **ะฃะผะฝะฐั ะพะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ**: ะัะพะณัะตััะธะฒะฝัะต ะทะฐะดะตัะถะบะธ ะดะปั rate limits
- ๐ฏ **Original-aware ัะตะดะฐะบัััะฐ**: ะัะฟะพะปัะทะพะฒะฐะฝะธะต ะพัะธะณะธะฝะฐะปัะฝะพะณะพ ัะตะบััะฐ ะดะปั ะฟัะพะฒะตัะบะธ ัะพัะฝะพััะธ
- โก **ะะดะฐะฟัะธะฒะฝะฐั ัะพะบะตะฝะธะทะฐัะธั**: ะะฐะทะฝัะต ะบะพัััะธัะธะตะฝัั ะดะปั ะบะธัะฐะนัะบะพะณะพ/ััััะบะพะณะพ/ะฐะฝะณะปะธะนัะบะพะณะพ

### ะะตะบะพะผะตะฝะดะฐัะธะธ ะฟะพ ะธัะฟะพะปัะทะพะฒะฐะฝะธั:

1. **ะะปั ะฑััััะพะณะพ ะฟะตัะตะฒะพะดะฐ**: Gemini 2.0 Flash + 3 API ะบะปััะฐ + 3 ะฟะพัะพะบะฐ
2. **ะะปั ะบะฐัะตััะฒะฐ**: OpenAI GPT-4 + ัะตะดะฐะบัััะฐ + ัะตะผะฟะตัะฐัััะฐ 0.1
3. **ะะปั ะฑะตัะฟะปะฐัะฝะพะณะพ**: Ollama qwen2.5:32b + ัะตะผะฟะตัะฐัััะฐ 0.5 + 2 ะฟะพัะพะบะฐ
4. **ะะปั ะพะฑัะพะดะฐ ะฑะปะพะบะธัะพะฒะพะบ**: ultra_small=True + fiction disclaimer

---

## ๐ ะะปััะตะฒัะต ัะฐะนะปั ะดะปั ะธะทััะตะฝะธั

| ะคะฐะนะป | ะะฟะธัะฐะฝะธะต |
|------|----------|
| `web_app/app/celery_tasks.py` | ะคะพะฝะพะฒัะต ะทะฐะดะฐัะธ: ะฟะฐััะธะฝะณ, ะฟะตัะตะฒะพะด, ัะตะดะฐะบัััะฐ |
| `web_app/app/services/translator_service.py` | ะะพะพัะดะธะฝะฐัะธั ะฟะตัะตะฒะพะดะฐ, ะบะพะฝัะตะบัั, ัะฐะทะฑะธะตะฝะธะต |
| `web_app/app/services/universal_llm_translator.py` | ะฃะฝะธะฒะตััะฐะปัะฝัะน ะฟะตัะตะฒะพะดัะธะบ ั ัะพัะฐัะธะตะน ะบะปััะตะน |
| `web_app/app/services/ai_adapter_service.py` | ะะดะฐะฟัะตัั ะดะปั AI ะฟัะพะฒะฐะนะดะตัะพะฒ |
| `web_app/app/services/original_aware_editor_service.py` | ะะตะดะฐะบัััะฐ ั ะพัะธะณะธะฝะฐะปัะฝัะผ ัะตะบััะพะผ |
| `web_app/app/services/glossary_service.py` | ะฃะฟัะฐะฒะปะตะฝะธะต ะณะปะพััะฐัะธะตะผ |
| `web_app/app/models/chapter.py` | ะะพะดะตะปั ะณะปะฐะฒั |
| `web_app/app/models/novel.py` | ะะพะดะตะปั ะฝะพะฒะตะปะปั ั ะบะพะฝัะธะณััะฐัะธะตะน |
| `web_app/app/models/prompt_template.py` | ะจะฐะฑะปะพะฝั ะฟัะพะผะฟัะพะฒ |
| `web_app/app/models/ai_model.py` | ะะพะดะตะปะธ AI ะฟัะพะฒะฐะนะดะตัะพะฒ |

---

**ะะฐัะฐ ะฐะฝะฐะปะธะทะฐ:** 2025-11-24
**ะะตััะธั ะฟัะพะตะบัะฐ:** ะขะตะบััะฐั (master branch)
