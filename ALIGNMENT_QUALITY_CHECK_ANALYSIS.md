# üìä –ú–µ—Ö–∞–Ω–∏–∑–º –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –±–∏–ª–∏–Ω–≥–≤–∞–ª—å–Ω–æ–≥–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ LLM

## üéØ –û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞** –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ —Å —Ä—É—Å—Å–∫–∏–º –ø–µ—Ä–µ–≤–æ–¥–æ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∫ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—é —á–µ—Ä–µ–∑ LLM.

---

## üîç –≠—Ç–∞–ø—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞

### 1Ô∏è‚É£ **–ü–∞—Ä—Å–∏–Ω–≥ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è JSON –æ—Ç–≤–µ—Ç–∞ LLM**

**–§–∞–π–ª:** `bilingual_alignment_service.py:251-270`

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:**
- –£–¥–∞–ª–µ–Ω–∏–µ Markdown –±–ª–æ–∫–æ–≤ –∏–∑ –æ—Ç–≤–µ—Ç–∞ LLM
- –ü–∞—Ä—Å–∏–Ω–≥ JSON —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–ª—è `alignments`

**–ö–æ–¥:**
```python
def _parse_llm_response(self, response: str) -> Dict:
    # –û—á–∏—Å—Ç–∫–∞ –æ—Ç markdown
    response = response.strip()
    if response.startswith('```json'): response = response[7:]
    if response.startswith('```'): response = response[3:]
    if response.endswith('```'): response = response[:-3]

    # –ü–∞—Ä—Å–∏–Ω–≥
    result = json.loads(response)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
    if 'alignments' not in result:
        raise ValueError("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ 'alignments'")

    return result
```

**–ü—Ä–∏ –æ—à–∏–±–∫–µ:** Fallback –Ω–∞ regex-–≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ

---

### 2Ô∏è‚É£ **–í–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è**

**–§–∞–π–ª:** `bilingual_alignment_service.py:272-304`

**–ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞:**

#### üìè **Coverage (–ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ–∫—Å—Ç–∞)**
- **`coverage_ru`** - –ø—Ä–æ—Ü–µ–Ω—Ç –ø–æ–∫—Ä—ã—Ç–∏—è —Ä—É—Å—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
- **`coverage_zh`** - –ø—Ä–æ—Ü–µ–Ω—Ç –ø–æ–∫—Ä—ã—Ç–∏—è –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
- –†–∞—Å—á–µ—Ç: –¥–ª–∏–Ω–∞ –≤—ã—Ä–æ–≤–Ω–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ / –¥–ª–∏–Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞

```python
aligned_ru = ' '.join([pair['ru'] for pair in alignments])
aligned_zh = ' '.join([pair['zh'] for pair in alignments])

coverage_ru = len(aligned_ru) / len(russian_text)
coverage_zh = len(aligned_zh) / len(chinese_text)
```

#### üéØ **Confidence (–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å LLM)**
- **`avg_confidence`** - —Å—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å LLM –ø–æ –≤—Å–µ–º –ø–∞—Ä–∞–º
- –ö–∞–∂–¥–∞—è –ø–∞—Ä–∞ –∏–º–µ–µ—Ç —Å–≤–æ–π `confidence` (0.0 - 1.0)
- –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Å–∞–º–æ–π LLM –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è

```python
avg_confidence = sum([pair.get('confidence', 0.5) for pair in alignments]) / len(alignments)
```

#### üìä **Quality Score (–ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞)**
–§–æ—Ä–º—É–ª–∞ –≤–∑–≤–µ—à–µ–Ω–Ω–æ–π –æ—Ü–µ–Ω–∫–∏:
```python
quality_score = (
    coverage_ru * 0.3 +      # 30% –≤–µ—Å–∞
    coverage_zh * 0.3 +      # 30% –≤–µ—Å–∞
    avg_confidence * 0.4     # 40% –≤–µ—Å–∞ (–æ—Å–Ω–æ–≤–Ω–æ–π –≤–µ—Å –Ω–∞ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å LLM)
)
```

#### ‚úÖ **–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏**
–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è **–≤–∞–ª–∏–¥–Ω—ã–º**, –µ—Å–ª–∏:
- `coverage_ru > 0.8` (80% —Ä—É—Å—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –ø–æ–∫—Ä—ã—Ç–æ)
- `coverage_zh > 0.8` (80% –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –ø–æ–∫—Ä—ã—Ç–æ)
- `avg_confidence > 0.6` (60% —Å—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å LLM)

```python
is_valid = coverage_ru > 0.8 and coverage_zh > 0.8 and avg_confidence > 0.6
```

**–ü—Ä–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ:** Fallback –Ω–∞ regex-–≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º –≤ –ª–æ–≥–∞—Ö

---

### 3Ô∏è‚É£ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –≤ –ë–î**

**–¢–∞–±–ª–∏—Ü–∞:** `bilingual_alignments`

**–°–æ—Ö—Ä–∞–Ω—è–µ–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞:**

```sql
-- –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
quality_score        FLOAT    -- 0.0 - 1.0 (–∏—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞)
coverage_ru          FLOAT    -- –ü—Ä–æ—Ü–µ–Ω—Ç –ø–æ–∫—Ä—ã—Ç–∏—è —Ä—É—Å—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
coverage_zh          FLOAT    -- –ü—Ä–æ—Ü–µ–Ω—Ç –ø–æ–∫—Ä—ã—Ç–∏—è –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
avg_confidence       FLOAT    -- –°—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å LLM

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
total_pairs          INTEGER  -- –í—Å–µ–≥–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø–∞—Ä
misalignment_count   INTEGER  -- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä —Å –Ω–∏–∑–∫–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é (<0.7)

-- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
alignment_method     VARCHAR  -- 'llm', 'regex', 'manual'
model_used          VARCHAR  -- –ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "kimi-k2:1t-cloud")
template_used_id    INTEGER  -- ID –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —à–∞–±–ª–æ–Ω–∞ –ø—Ä–æ–º–ø—Ç–∞

-- –†—É—á–Ω–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è
verified_by_human   BOOLEAN  -- –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ —á–µ–ª–æ–≤–µ–∫–æ–º
verification_notes  TEXT     -- –ó–∞–º–µ—Ç–∫–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞
verified_at         DATETIME -- –í—Ä–µ–º—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
```

**–†–∞—Å—á–µ—Ç misalignment_count:**
```python
misalignment_count = sum(1 for pair in alignments if pair['confidence'] < 0.7)
```

---

### 4Ô∏è‚É£ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞ –º–æ–¥–µ–ª–∏**

**–§–∞–π–ª:** `models/bilingual_alignment.py:94-112`

#### üåü **is_high_quality** (–í—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ)
```python
@property
def is_high_quality(self):
    return (
        self.quality_score > 0.8 and
        self.coverage_ru > 0.85 and
        self.coverage_zh > 0.85 and
        self.avg_confidence > 0.75
    )
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã—Å–æ–∫–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞:**
- Quality score > 80%
- –ü–æ–∫—Ä—ã—Ç–∏–µ RU > 85%
- –ü–æ–∫—Ä—ã—Ç–∏–µ ZH > 85%
- –°—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å > 75%

#### ‚ö†Ô∏è **needs_review** (–¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
```python
@property
def needs_review(self):
    return (
        not self.verified_by_human and (
            self.quality_score < 0.7 or
            self.misalignment_count > (self.total_pairs * 0.2)
        )
    )
```

**–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –µ—Å–ª–∏:**
- –ù–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ —á–µ–ª–æ–≤–µ–∫–æ–º –ò
  - Quality score < 70% –ò–õ–ò
  - –ë–æ–ª—å—à–µ 20% –ø–∞—Ä –∏–º–µ—é—Ç –Ω–∏–∑–∫—É—é —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å (<0.7)

---

## üìà –ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª—å–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫

**–ù–æ–≤–µ–ª–ª–∞ 21, –ì–ª–∞–≤–∞ 1:**
```
–ú–µ—Ç–æ–¥:              llm
–ú–æ–¥–µ–ª—å:             kimi-k2:1t-cloud
Quality Score:      0.96 (96%) ‚úÖ
Coverage RU:        0.99 (99%) ‚úÖ
Coverage ZH:        0.98 (98%) ‚úÖ
Avg Confidence:     0.92 (92%) ‚úÖ
–í—Å–µ–≥–æ –ø–∞—Ä:          37
–ù–∏–∑–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: 0 (0%)
–í—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ:   ‚úÖ –î–∞
–¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏:   ‚ùå –ù–µ—Ç
```

**–ü—Ä–∏–º–µ—Ä —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø–∞—Ä:**
```json
{
  "ru": "18 —Å–µ–Ω—Ç—è–±—Ä—è 2013 –≥–æ–¥–∞, 22:15. –û–∫—Ä–∞–∏–Ω–∞ –®–∞–Ω—Ö–∞—è.",
  "zh": "2013Âπ¥ÁöÑ9Êúà18Êó•Â§ú22:15ÁöÑ‰∏äÊµ∑ÈÉäÂå∫„ÄÇ",
  "type": "description",
  "confidence": 1.0
}
```

---

## üîÑ Fallback –º–µ—Ö–∞–Ω–∏–∑–º

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Regex Fallback?

1. **–û—à–∏–±–∫–∞ LLM –∑–∞–ø—Ä–æ—Å–∞** - —Ç–∞–π–º–∞—É—Ç, rate limit, –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
2. **–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON** - –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞
3. **–ù–∏–∑–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ** - –Ω–µ –ø—Ä–æ—à–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è (`is_valid = False`)

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ Fallback?

```python
def _fallback_regex_alignment(self, russian_text, chinese_text, chapter):
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ BilingualTextAligner.align_sentences()
    aligned_pairs = BilingualTextAligner.align_sentences(russian_text, chinese_text)

    # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ —Ñ–æ—Ä–º–∞—Ç LLM
    result = [
        {
            'ru': ru,
            'zh': zh,
            'type': 'unknown',
            'confidence': 0.5  # –ù–∏–∑–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –¥–ª—è regex
        }
        for ru, zh in aligned_pairs
    ]

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å –ø–æ–º–µ—Ç–∫–æ–π
    self._save_to_cache(
        alignment_data={'alignments': result, 'stats': {'method': 'regex_fallback'}},
        quality_score=0.5,  # –ù–∏–∑–∫–∞—è –æ—Ü–µ–Ω–∫–∞
        model_name='regex_fallback'
    )
```

**–ú–µ—Ç—Ä–∏–∫–∏ Regex Fallback:**
- `alignment_method = 'regex_fallback'`
- `model_used = 'regex_fallback'`
- `quality_score = 0.5` (50%)
- `confidence = 0.5` –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä
- `type = 'unknown'` –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä

---

## üé® –ü—Ä–æ–º–ø—Ç –¥–ª—è LLM

**–®–∞–±–ª–æ–Ω:** "–°—è–Ω—å—Å—è –¥–≤—É—è–∑—ã—á–Ω—ã–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)"

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- Temperature: 0.1 (–Ω–∏–∑–∫–∞—è –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏)
- Max tokens: 64000

**–û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è LLM:**

1. **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å–º—ã—Å–ª–∞:**
   - 1 –∫–∏—Ç–∞–π—Å–∫–æ–µ ‚Üí 1-3 —Ä—É—Å—Å–∫–∏—Ö (–≥–∏–±–∫–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ)
   - –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Å–º—ã—Å–ª–æ–≤—ã–º –±–ª–æ–∫–∞–º
   - –î–∏–∞–ª–æ–≥–∏ –≤—Å–µ–≥–¥–∞ —Ç–æ—á–Ω–æ (—Ä–µ–ø–ª–∏–∫–∞ –∫ —Ä–µ–ø–ª–∏–∫–µ)

2. **–¢–∏–ø—ã —Ç–µ–∫—Å—Ç–∞:**
   - `dialogue` - –¥–∏–∞–ª–æ–≥–∏ –∏ —Ä–µ–ø–ª–∏–∫–∏
   - `description` - –æ–ø–∏—Å–∞–Ω–∏—è
   - `action` - –¥–µ–π—Å—Ç–≤–∏—è –∏ —Å–æ–±—ã—Ç–∏—è
   - `internal` - –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –º—ã—Å–ª–∏

3. **–®–∫–∞–ª–∞ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏:**
   - `0.95-1.0` - –¢–æ—á–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ (–¥–∏–∞–ª–æ–≥–∏)
   - `0.80-0.95` - –•–æ—Ä–æ—à–µ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ (–æ–ø–∏—Å–∞–Ω–∏—è)
   - `0.60-0.80` - –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ–µ (—Å–ª–æ–∂–Ω—ã–µ —Å–ª—É—á–∞–∏)
   - `0.00-0.60` - –ù–µ—É–≤–µ—Ä–µ–Ω (—Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏)

4. **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∂–∞–Ω—Ä–∞:**
   - –ö–∏—Ç–∞–π—Å–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —á–∞—Å—Ç–æ –¥–ª–∏–Ω–Ω–µ–µ
   - –†—É—Å—Å–∫–∏–π —Ä–∞–∑–±–∏–≤–∞–µ—Ç –¥–ª—è —á–∏—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏
   - –ö—É–ª—å—Ç–∏–≤–∞—Ü–∏—è/—Ç–µ—Ö–Ω–∏–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è –≤ –æ–¥–Ω–æ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏

---

## üîß –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

**Celery –∑–∞–¥–∞—á–∞:** `align_novel_chapters_task`

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `parallel_threads` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤ (–∏–∑ `novel.config['alignment_threads']`)
- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 3 –ø–æ—Ç–æ–∫–∞

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ö–∞–∂–¥—ã–π –ø–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–µ—Ç —Å–≤–æ–π Flask app context
- Thread-safe –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤ —á–µ—Ä–µ–∑ `Lock()`
- –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ `BilingualAlignment`
- Graceful shutdown –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ (SIGTERM)

**–ü—Ä–æ–≥—Ä–µ—Å—Å:**
```python
self.update_state(state='PROGRESS', meta={
    'status': '–í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –≥–ª–∞–≤—É 5/10',
    'progress': 50,
    'success_count': 4,
    'aligned_count': 4
})
```

---

## üìä API –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**Endpoint:** `GET /api/novels/<id>/alignment-status`

**–í–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:**
```json
{
  "is_running": true,
  "state": "PROGRESS",
  "progress": 45,
  "aligned_count": 12,
  "status": "–í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –≥–ª–∞–≤—É 13..."
}
```

**Endpoint:** `POST /novels/<id>/alignment/cancel`

**–û—Ç–º–µ–Ω–∞ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è:**
```python
celery.control.revoke(task_id, terminate=True, signal='SIGTERM')
novel.status = 'alignment_cancelled'
novel.alignment_task_id = None
```

---

## üéØ –í—ã–≤–æ–¥—ã

### ‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã

1. **–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:**
   - –ü–∞—Ä—Å–∏–Ω–≥ JSON
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–∫—Ä—ã—Ç–∏—è
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ LLM
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞ –∫–∞—á–µ—Å—Ç–≤–∞

2. **–ù–∞–¥–µ–∂–Ω—ã–π fallback:**
   - –ü—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ LLM ‚Üí regex
   - –°–∏—Å—Ç–µ–º–∞ –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–æ–¥–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

3. **–î–µ—Ç–∞–ª—å–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞:**
   - 4 –æ—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞
   - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–∏–∑–∫–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
   - –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ –∏ —à–∞–±–ª–æ–Ω–∞

4. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –û–¥–∏–Ω —Ä–∞–∑ –≤—ã—Ä–æ–≤–Ω–µ–Ω–æ ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞
   - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è —á–µ—Ä–µ–∑ `regenerate_alignment()`
   - –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –ø–æ `chapter_id`

### ‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–†—É—á–Ω–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è:**
   - –ü–æ–ª—è –µ—Å—Ç—å –≤ –ë–î: `verified_by_human`, `verification_notes`
   - –ù–æ –Ω–µ—Ç UI –¥–ª—è —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏/–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä
   - –°–≤–æ–π—Å—Ç–≤–æ `needs_review` —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç, –Ω–æ –Ω–µ—Ç workflow

2. **–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º:**
   - –ù–µ—Ç –∞–Ω–∞–ª–∏–∑–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–æ–≤ (dialogue/description/action)
   - –ù–µ—Ç –º–µ—Ç—Ä–∏–∫ –ø–æ confidence –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –æ—Ç–¥–µ–ª—å–Ω–æ

3. **–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:**
   - –ù–µ—Ç –ø—Ä–µ–≤—å—é –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è –≤ UI (–º–µ—Ç–æ–¥ `get_alignment_preview` –µ—Å—Ç—å)
   - –ù–µ—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –¥–æ/–ø–æ—Å–ª–µ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞

4. **A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å—Ä–∞–≤–Ω–∏—Ç—å LLM vs Regex —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
   - –ù–µ—Ç –º–µ—Ç—Ä–∏–∫ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è

---

## üìÅ –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã

```
web_app/app/services/bilingual_alignment_service.py    # –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å
web_app/app/models/bilingual_alignment.py              # –ú–æ–¥–µ–ª—å –ë–î
web_app/app/celery_tasks.py:863-1050                   # Celery –∑–∞–¥–∞—á–∞
web_app/app/api/alignment.py                           # API endpoints
web_app/app/utils/text_alignment.py                    # Regex fallback
```

---

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 2025-11-17
**–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º–∞—è –≤–µ—Ä—Å–∏—è:** Latest (master branch)
