# –†–µ–∑—é–º–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –≤ czbooks_parser.py

**–î–∞—Ç–∞**: 2025-11-18
**–§–∞–π–ª**: `parsers/sources/czbooks_parser.py`
**–ü—Ä–æ–±–ª–µ–º–∞**: –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–ª—Å—è, –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–ª—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

---

## ‚úÖ –í–Ω–µ–¥—Ä–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ retry (—Å—Ç—Ä–æ–∫–∏ 594-611)

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å–∏–≥–Ω–∞—Ç—É—Ä—ã –º–µ—Ç–æ–¥–∞**:
```python
def _get_page_with_selenium(self, url: str, wait_selector: str = None,
                            wait_time: int = 15, _retry_count: int = 0) -> str:
```

**–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞**:
```python
# –ó–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ retry
MAX_RETRIES = 3
if _retry_count >= MAX_RETRIES:
    print(f"   ‚ùå –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç retry ({MAX_RETRIES}), –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ")
    return self.driver.page_source if self.driver else ""
```

**–ó–∞—á–µ–º**: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ —Ü–∏–∫–ª—ã retry –ø—Ä–∏ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö.

---

### 2. –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ consecutive_errors (—Å—Ç—Ä–æ–∫–∏ 613-616)

**–î–æ–±–∞–≤–ª–µ–Ω–æ**:
```python
# –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–æ –º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫ - –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
if self.consecutive_errors >= 5:
    print(f"   üî• –ù–∞–∫–æ–ø–ª–µ–Ω–æ {self.consecutive_errors} –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫ - –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫")
    self.restart_driver(force_kill_chrome=True)
```

**–ó–∞—á–µ–º**: –¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `consecutive_errors` –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π. –ü—Ä–∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–∏ 5+ –æ—à–∏–±–æ–∫ –±—Ä–∞—É–∑–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏—á–µ—Å–∫–∏.

---

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞–π–º–∞—É—Ç–∞ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ (—Å—Ç—Ä–æ–∫–∏ 645-701)

**–î–û** (—Å—Ç—Ä–æ–∫–∏ 633-635):
```python
except Exception as e:
    print(f"   ‚ö†Ô∏è –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è —Å–µ–ª–µ–∫—Ç–æ—Ä–∞: {e}")
    # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–∞–∂–µ –µ—Å–ª–∏ —Å–µ–ª–µ–∫—Ç–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω  ‚Üê –ü–†–û–ë–õ–ï–ú–ê!
```

**–ü–û–°–õ–ï** (—Å—Ç—Ä–æ–∫–∏ 645-701):
```python
except Exception as e:
    print(f"   ‚ö†Ô∏è –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è —Å–µ–ª–µ–∫—Ç–æ—Ä–∞: {e}")

    # –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    page_source = self.driver.page_source
    page_size = len(page_source)
    chinese_chars = len([c for c in page_source if '\u4e00' <= c <= '\u9fff'])
    print(f"   üìä –†–∞–∑–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã: {page_size}, –ö–∏—Ç–∞–π—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤: {chinese_chars}")

    # –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ–º —Å—á–µ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
    self.consecutive_errors += 1

    # –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ï—Å–ª–∏ 3+ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –æ—à–∏–±–∫–∏
    if self.consecutive_errors >= 3:
        print(f"\n{'='*60}")
        print(f"   üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –°–ò–¢–£–ê–¶–ò–Ø")
        print(f"   –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫: {self.consecutive_errors}")
        print(f"   –ü—Ä–∏—á–∏–Ω–∞: –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞")
        print(f"   –î–µ–π—Å—Ç–≤–∏–µ: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ Chrome")
        print(f"{'='*60}\n")

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º HTML –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        debug_file = f"/tmp/czbooks_selector_timeout_{int(time.time())}.html"
        with open(debug_file, 'w', encoding='utf-8') as f:
            f.write(page_source)
        print(f"   üíæ HTML —Å–æ—Ö—Ä–∞–Ω–µ–Ω –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞: {debug_file}")

        # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å force_kill
        self.restart_driver(force_kill_chrome=True)

        # Retry –¢–ï–ö–£–©–ï–ô —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
        print(f"   üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞...")
        return self._get_page_with_selenium(url, wait_selector, wait_time, _retry_count + 1)

    # –ï—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—É—Å—Ç–∞—è - –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π restart
    if page_size < 5000 or chinese_chars < 100:
        print(f"   ‚ùå –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—É—Å—Ç–∞—è –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω–∞—è")
        print(f"   üîÑ –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±—Ä–∞—É–∑–µ—Ä–∞ –∏ retry...")

        self.restart_driver(force_kill_chrome=True)
        return self._get_page_with_selenium(url, wait_selector, wait_time, _retry_count + 1)

    # –ò–Ω–∞—á–µ: –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º
    print(f"   ‚ö†Ô∏è –°–µ–ª–µ–∫—Ç–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –ø—É—Å—Ç–∞—è (–æ—à–∏–±–∫–∞ {self.consecutive_errors}/3) - –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º...")
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
- ‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã (—Ä–∞–∑–º–µ—Ä, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∏—Ç–∞–π—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤)
- ‚úÖ –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç `consecutive_errors`
- ‚úÖ –ü—Ä–∏ 3+ –æ—à–∏–±–∫–∞—Ö: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ HTML ‚Üí restart Chrome ‚Üí retry
- ‚úÖ –ü—Ä–∏ –ø—É—Å—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ: –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π restart ‚Üí retry
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ HTML –≤ `/tmp/` –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

---

### 4. –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü –ë–ï–ó –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (—Å—Ç—Ä–æ–∫–∏ 848-898)

**–î–û** (—Å—Ç—Ä–æ–∫–∏ 786-797):
```python
elif page_size > 5000:
    print(f"   ‚ö†Ô∏è –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –Ω–æ –ù–ï–¢ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞")
    self.consecutive_errors += 1
    # –ü—Ä–æ–±—É–µ–º –≤–µ—Ä–Ω—É—Ç—å –∫–∞–∫ –µ—Å—Ç—å - –º–æ–∂–µ—Ç –ø–∞—Ä—Å–µ—Ä —Å–ø—Ä–∞–≤–∏—Ç—Å—è  ‚Üê –ü–†–û–ë–õ–ï–ú–ê!
    return page_source
else:
    print(f"   ‚ö†Ô∏è –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ –º–∞–ª—ã–π —Ä–∞–∑–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã: {page_size}")
    self.consecutive_errors += 1
    return page_source  ‚Üê –ü–†–û–ë–õ–ï–ú–ê!
```

**–ü–û–°–õ–ï** (—Å—Ç—Ä–æ–∫–∏ 852-898):
```python
elif page_size > 5000:
    # –ë–æ–ª—å—à–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ë–ï–ó —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    print(f"   ‚ö†Ô∏è –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ ({page_size} —Å–∏–º–≤–æ–ª–æ–≤), –Ω–æ –ù–ï–¢ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞")
    print(f"   üìä –ö–∏—Ç–∞–π—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤: {chinese_chars}")
    print(f"   ‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω–æ —ç—Ç–æ Cloudflare challenge —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∏–ª–∏ –±–∏—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞")

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º HTML –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
    debug_file = f"/tmp/czbooks_no_content_{int(time.time())}.html"
    with open(debug_file, 'w', encoding='utf-8') as f:
        f.write(page_source[:20000])  # –ü–µ—Ä–≤—ã–µ 20KB
    print(f"   üíæ HTML —Å–æ—Ö—Ä–∞–Ω–µ–Ω –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞: {debug_file}")

    self.consecutive_errors += 1

    # –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ï—Å–ª–∏ 3+ –æ—à–∏–±–æ–∫ –ø–æ–¥—Ä—è–¥
    if self.consecutive_errors >= 3:
        print(f"   üî• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ({self.consecutive_errors} –æ—à–∏–±–æ–∫) - –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ Chrome –∏ retry")
        self.restart_driver(force_kill_chrome=True)
        return self._get_page_with_selenium(url, wait_selector, wait_time, _retry_count + 1)

    # –ï—Å–ª–∏ <3 –æ—à–∏–±–æ–∫ - retry —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –ë–ï–ó –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
    print(f"   üîÑ Retry —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ (–ø–æ–ø—ã—Ç–∫–∞ {_retry_count + 1}/{MAX_RETRIES})...")
    time.sleep(5)
    return self._get_page_with_selenium(url, wait_selector, wait_time, _retry_count + 1)

else:
    # –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ –º–∞–ª—ã–π —Ä–∞–∑–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    print(f"   ‚ö†Ô∏è –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ –º–∞–ª—ã–π —Ä–∞–∑–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã: {page_size}")

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
    debug_file = f"/tmp/czbooks_small_page_{int(time.time())}.html"
    with open(debug_file, 'w', encoding='utf-8') as f:
        f.write(page_source)
    print(f"   üíæ HTML —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {debug_file}")

    self.consecutive_errors += 1

    # –ú–∞–ª–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ - –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∏ retry
    print(f"   üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±—Ä–∞—É–∑–µ—Ä–∞ –∏ retry...")
    self.restart_driver(force_kill_chrome=True)
    return self._get_page_with_selenium(url, wait_selector, wait_time, _retry_count + 1)
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ HTML –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤ `/tmp/`
- ‚úÖ –ü—Ä–∏ 3+ –æ—à–∏–±–∫–∞—Ö: restart ‚Üí retry
- ‚úÖ –ü—Ä–∏ <3 –æ—à–∏–±–∫–∞—Ö: retry —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 5 —Å–µ–∫
- ‚úÖ –ú–∞–ª—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π restart ‚Üí retry
- ‚úÖ –ù–ï–¢ –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü –≤ –ø–∞—Ä—Å–µ—Ä!

---

## üìã –°–≤–æ–¥–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –î–æ–±–∞–≤–ª–µ–Ω–æ:

1. **–ü–∞—Ä–∞–º–µ—Ç—Ä `_retry_count`** –≤ —Å–∏–≥–Ω–∞—Ç—É—Ä—É `_get_page_with_selenium()`
2. **–ó–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ retry** (–º–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏)
3. **–ü—Ä–æ–∞–∫—Ç–∏–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞** `consecutive_errors >= 5` ‚Üí restart
4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞–π–º–∞—É—Ç–∞ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞**:
   - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
   - –ü—Ä–∏ 3+ –æ—à–∏–±–∫–∞—Ö ‚Üí restart + retry
   - –ü—Ä–∏ –ø—É—Å—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ ‚Üí restart + retry
5. **–£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü –ë–ï–ó –∫–æ–Ω—Ç–µ–Ω—Ç–∞**:
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ HTML –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
   - Progressive retry (—Å –∑–∞–¥–µ—Ä–∂–∫–æ–π ‚Üí restart)
6. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ HTML –¥–µ–±–∞–≥ —Ñ–∞–π–ª–æ–≤** –≤ `/tmp/` –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

### –£–¥–∞–ª–µ–Ω–æ:

- ‚ùå –í–æ–∑–≤—Ä–∞—Ç –ø—É—Å—Ç—ã—Ö/–ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü –≤ –ø–∞—Ä—Å–µ—Ä –±–µ–∑ retry

### –ò–∑–º–µ–Ω–µ–Ω–æ:

- ‚úÖ `consecutive_errors` –¢–ï–ü–ï–†–¨ –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π
- ‚úÖ –í—Å–µ –ø—É—Ç–∏ —Å –æ—à–∏–±–∫–∞–º–∏ –≤–µ–¥—É—Ç –∫ restart –∏/–∏–ª–∏ retry
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üéØ –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ë—ã–ª–æ:

1. ‚ùå –¢–∞–π–º–∞—É—Ç —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ ‚Üí –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è ‚Üí –ø—É—Å—Ç–∞—è –≥–ª–∞–≤–∞
2. ‚ùå –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ë–ï–ó –∫–æ–Ω—Ç–µ–Ω—Ç–∞ ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å ‚Üí –ø—É—Å—Ç–∞—è –≥–ª–∞–≤–∞
3. ‚ùå `consecutive_errors` ‚Üí —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–∞—É–∑, –Ω–µ –¥–ª—è —Ä–µ—à–µ–Ω–∏–π
4. ‚ùå –ë—Ä–∞—É–∑–µ—Ä –≤ –±–∏—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ ‚Üí –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É –¥–æ 100 –∑–∞–ø—Ä–æ—Å–æ–≤
5. ‚ùå –ù–µ—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ ‚Üí –Ω–µ—è—Å–Ω–æ —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ

### –°—Ç–∞–ª–æ:

1. ‚úÖ –¢–∞–π–º–∞—É—Ç —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ ‚Üí –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ ‚Üí restart (–ø—Ä–∏ 3+ –æ—à–∏–±–∫–∞—Ö) ‚Üí retry ‚Üí —É—Å–ø–µ—Ö –∏–ª–∏ –ª–∏–º–∏—Ç retry
2. ‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ë–ï–ó –∫–æ–Ω—Ç–µ–Ω—Ç–∞ ‚Üí —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ HTML ‚Üí retry ‚Üí restart (–ø—Ä–∏ 3+ –æ—à–∏–±–∫–∞—Ö) ‚Üí —É—Å–ø–µ—Ö –∏–ª–∏ –ª–∏–º–∏—Ç retry
3. ‚úÖ `consecutive_errors >= 5` ‚Üí –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏—á–µ—Å–∫–∏–π restart
4. ‚úÖ –ë—Ä–∞—É–∑–µ—Ä –≤ –±–∏—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π restart —á–µ—Ä–µ–∑ 3-5 –æ—à–∏–±–æ–∫
5. ‚úÖ HTML —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `/tmp/` ‚Üí –ª–µ–≥–∫–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

1. **–ù–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞**:
   - –°–µ–ª–µ–∫—Ç–æ—Ä –Ω–∞–π–¥–µ–Ω ‚Üí `consecutive_errors = 0` ‚Üí –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ

2. **1-2 —Ç–∞–π–º–∞—É—Ç–∞ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞**:
   - –û—à–∏–±–∫–∞ 1 ‚Üí retry —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
   - –û—à–∏–±–∫–∞ 2 ‚Üí retry —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
   - –£—Å–ø–µ—Ö ‚Üí `consecutive_errors = 0`

3. **3+ —Ç–∞–π–º–∞—É—Ç–∞ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞**:
   - –û—à–∏–±–∫–∞ 1 ‚Üí retry
   - –û—à–∏–±–∫–∞ 2 ‚Üí retry
   - –û—à–∏–±–∫–∞ 3 ‚Üí **RESTART Chrome** ‚Üí retry
   - –£—Å–ø–µ—Ö –∏–ª–∏ –ª–∏–º–∏—Ç retry

4. **–ü—É—Å—Ç–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞**:
   - –¢–∞–π–º–∞—É—Ç + page_size < 5000 ‚Üí **RESTART –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ** ‚Üí retry

5. **–°—Ç—Ä–∞–Ω–∏—Ü–∞ –ë–ï–ó –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (>5000 —Å–∏–º–≤–æ–ª–æ–≤, <500 –∫–∏—Ç–∞–π—Å–∫–∏—Ö)**:
   - –û—à–∏–±–∫–∞ 1 ‚Üí retry —á–µ—Ä–µ–∑ 5 —Å–µ–∫
   - –û—à–∏–±–∫–∞ 2 ‚Üí retry —á–µ—Ä–µ–∑ 5 —Å–µ–∫
   - –û—à–∏–±–∫–∞ 3 ‚Üí **RESTART** ‚Üí retry

6. **–ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫**:
   - 5+ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫ ‚Üí **–ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏—á–µ—Å–∫–∏–π RESTART**

7. **–õ–∏–º–∏—Ç retry**:
   - 3 –Ω–µ—É–¥–∞—á–Ω—ã—Ö retry ‚Üí –≤–æ–∑–≤—Ä–∞—Ç —Ç–µ–∫—É—â–µ–≥–æ page_source (–∑–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è)

---

## üìÅ –î–µ–±–∞–≥ —Ñ–∞–π–ª—ã

–í—Å–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ HTML —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `/tmp/`:

- `/tmp/czbooks_selector_timeout_<timestamp>.html` - —Ç–∞–π–º–∞—É—Ç —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –ø—Ä–∏ 3+ –æ—à–∏–±–∫–∞—Ö
- `/tmp/czbooks_empty_page_<timestamp>.html` - –ø—É—Å—Ç–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (<5000 —Å–∏–º–≤–æ–ª–æ–≤)
- `/tmp/czbooks_no_content_<timestamp>.html` - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ë–ï–ó –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- `/tmp/czbooks_small_page_<timestamp>.html` - –º–∞–ª–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞

**–î–ª—è –∞–Ω–∞–ª–∏–∑–∞**:
```bash
# –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
ls -lht /tmp/czbooks_*.html | head -5

# –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
cat /tmp/czbooks_no_content_*.html | head -100

# –ü–æ–∏—Å–∫ Cloudflare –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
grep -i "cloudflare\|turnstile\|verify you are human" /tmp/czbooks_*.html
```

---

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

**–§–∞–π–ª –∏–∑–º–µ–Ω–µ–Ω**: `parsers/sources/czbooks_parser.py`

**–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫**:
- ‚úÖ Celery worker (–¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ø–∞—Ä—Å–µ—Ä–µ)

**–ö–æ–º–∞–Ω–¥–∞**:
```bash
cd web_app
./stop_celery_worker.sh
./start_celery_worker.sh
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã**:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Celery
tail -f /tmp/celery_worker_novelbins.log

# –ò—Å–∫–∞—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
grep -E "–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –°–ò–¢–£–ê–¶–ò–Ø|–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ|–ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫|HTML —Å–æ—Ö—Ä–∞–Ω–µ–Ω" /tmp/celery_worker_novelbins.log
```

---

## ‚úÖ –ò—Ç–æ–≥

**–ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞**: –¢–µ–ø–µ—Ä—å –ø—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø–∞—Ä—Å–µ—Ä:
1. –î–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä—É–µ—Ç –ø—Ä–æ–±–ª–µ–º—É
2. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç HTML –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
3. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `consecutive_errors` –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π
4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç Chrome –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö
5. –î–µ–ª–∞–µ—Ç retry –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
6. –ó–∞—â–∏—â–µ–Ω –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã—Ö —Ü–∏–∫–ª–æ–≤

**–ì–ª–∞–≤–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ**: `consecutive_errors` –ø–µ—Ä–µ—Å—Ç–∞–ª –±—ã—Ç—å "–º–µ—Ä—Ç–≤–æ–π" –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –∏ —Ç–µ–ø–µ—Ä—å –∞–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è!
