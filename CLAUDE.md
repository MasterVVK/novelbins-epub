# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Web-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ Flask –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞ –∫–∏—Ç–∞–π—Å–∫–∏—Ö –≤–µ–±-–Ω–æ–≤–µ–ª–ª (–ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ –∂–∞–Ω—Ä —Å—è–Ω—Å—è/—Ñ—ç–Ω—Ç–µ–∑–∏) —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º AI –º–æ–¥–µ–ª–µ–π. –°–∏—Å—Ç–µ–º–∞ –≤–∫–ª—é—á–∞–µ—Ç –ø–∞—Ä—Å–∏–Ω–≥ –≥–ª–∞–≤ —Å —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤, –ø–µ—Ä–µ–≤–æ–¥ —Å –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ –Ω–∞ —Ä—É—Å—Å–∫–∏–π, –º–Ω–æ–≥–æ—ç—Ç–∞–ø–Ω—É—é —Ä–µ–¥–∞–∫—Ç—É—Ä—É –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é EPUB —Ñ–∞–π–ª–æ–≤.

### ü§ñ Cloudflare Turnstile Solver (NEW!)

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ Cloudflare Turnstile —á–µ—Ä–µ–∑ Qwen3-VL vision –º–æ–¥–µ–ª—å (–ª–æ–∫–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ Ollama)**

- **–ú–æ–¥–µ–ª—å**: `qwen3-vl:8b` (6GB) –∏–ª–∏ `qwen3-vl:32b` (21GB)
- **–°—Ç–æ–∏–º–æ—Å—Ç—å**: $0 (–ª–æ–∫–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞)
- **–¢–æ—á–Ω–æ—Å—Ç—å**: 0px –æ—à–∏–±–∫–∞ –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**: `parsers/sources/czbooks_parser.py:478-520`
- **–°–µ—Ä–≤–∏—Å**: `web_app/app/services/cloudflare_solver_ollama.py`
- **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**: `.env` ‚Üí `CLOUDFLARE_SOLVER_ENABLED=true`
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: `test_qwen_vision.py`
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: `CLOUDFLARE_SOLVER_README.md`

–ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ Cloudflare challenge —Å–∏—Å—Ç–µ–º–∞:
1. –ü—ã—Ç–∞–µ—Ç—Å—è –ø—Ä–æ–π—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–∑–∞–¥–µ—Ä–∂–∫–∏ 15-60 —Å–µ–∫)
2. –ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–ª–æ ‚Üí ü§ñ **Qwen3-VL –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ** (3 –ø–æ–ø—ã—Ç–∫–∏)
3. –ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–ª–æ ‚Üí VNC —Ä—É—á–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (fallback)

## Common Development Commands

### Web Application
```bash
# –ó–∞–ø—É—Å–∫ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–æ—Å–Ω–æ–≤–Ω–æ–π —Å–ø–æ—Å–æ–±)
python run_web.py                    # –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞
# –∏–ª–∏
cd web_app && python run.py         # –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ web_app

# –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ http://0.0.0.0:5001

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ)
flask --app run_web init-db

# –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
cd web_app
flask db migrate -m "–æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π"
flask db upgrade
```

### Celery Background Tasks
```bash
# –ó–∞–ø—É—Å–∫ Celery worker (—Ç—Ä–µ–±—É–µ—Ç—Å—è Redis –∏ Xvfb –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ czbooks)
cd web_app
./start_celery_worker.sh

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ Redis
redis-cli ping

# –ó–∞–ø—É—Å–∫ Redis (–µ—Å–ª–∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω)
sudo systemctl start redis-server
```

## Architecture Overview

### –ú–æ–¥—É–ª—å–Ω–∞—è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Flask

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ–∞–±—Ä–∏–∫—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π (`create_app()`) —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –Ω–∞ blueprints:

- **API Endpoints** (`web_app/app/api/`): REST API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  - `novels.py`: CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –Ω–æ–≤–µ–ª–ª–∞–º–∏
  - `chapters.py`: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–ª–∞–≤–∞–º–∏, –∑–∞–ø—É—Å–∫ –ø–µ—Ä–µ–≤–æ–¥–æ–≤
  - `glossary.py`: –†–∞–±–æ—Ç–∞ —Å —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–º –≥–ª–æ—Å—Å–∞—Ä–∏–µ–º
  - `tasks.py`: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Celery –∑–∞–¥–∞—á

- **Models** (`web_app/app/models/`): SQLAlchemy –º–æ–¥–µ–ª–∏
  - `novel.py`: –ú–æ–¥–µ–ª—å –Ω–æ–≤–µ–ª–ª—ã —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
  - `chapter.py`: –ì–ª–∞–≤—ã —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º –∏ –ø–µ—Ä–µ–≤–æ–¥–æ–º
  - `ai_model.py`: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è AI –º–æ–¥–µ–ª–µ–π —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
  - `glossary.py`: –¢–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –≥–ª–æ—Å—Å–∞—Ä–∏–π –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
  - `prompt_template.py`: –®–∞–±–ª–æ–Ω—ã –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤

- **Services** (`web_app/app/services/`): –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
  - `universal_llm_translator.py`: –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Gemini, OpenAI, Claude, Ollama
  - `translator_service.py`: –°–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–≤–æ–¥–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø—Ä–æ–º–ø—Ç-—à–∞–±–ª–æ–Ω–æ–≤
  - **–°–µ—Ä–≤–∏—Å—ã —Ä–µ–¥–∞–∫—Ç—É—Ä—ã**:
    - `original_aware_editor_service.py`: **–û–°–ù–û–í–ù–û–ô –ò–°–ü–û–õ–¨–ó–£–ï–ú–´–ô** - —Ä–µ–¥–∞–∫—Ç—É—Ä–∞ —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –∏ –≥–ª–æ—Å—Å–∞—Ä–∏–µ–º
    - `glossary_aware_editor_service.py`: –ë–∞–∑–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å —Ä–µ–¥–∞–∫—Ç—É—Ä—ã —Å —É—á–µ—Ç–æ–º –≥–ª–æ—Å—Å–∞—Ä–∏—è (—Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–ª–∞—Å—Å)
    - `editor_service.py`: –ú–Ω–æ–≥–æ—ç—Ç–∞–ø–Ω–∞—è —Ä–µ–¥–∞–∫—Ç—É—Ä–∞ (analysis ‚Üí style ‚Üí dialogue ‚Üí polish)
    - `parallel_editor_service.py`: –£—Å—Ç–∞—Ä–µ–≤—à–∏–π, –ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø (–∏–º–µ–ª –±–∞–≥ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º)
  - `glossary_service.py`: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–ª–æ—Å—Å–∞—Ä–∏–µ–º –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–æ–≤
  - `parser_service.py`: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–∞—Ä—Å–µ—Ä–æ–≤ –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
  - `ai_adapter_service.py`: –ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å AI –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏

### Parser System

–°–∏—Å—Ç–µ–º–∞ –ø–∞—Ä—Å–µ—Ä–æ–≤ —Å —Ñ–∞–±—Ä–∏—á–Ω—ã–º –ø–∞—Ç—Ç–µ—Ä–Ω–æ–º (`parsers/parser_factory.py`):

- **Base Parser** (`parsers/base/base_parser.py`): –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∫–ª–∞—Å—Å —Å –æ–±—â–∏–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
- **Source Parsers** (`parsers/sources/`):
  - `czbooks_parser.py`: –ü–∞—Ä—Å–µ—Ä –¥–ª—è czbooks.net (—Ç—Ä–µ–±—É–µ—Ç Selenium + Xvfb)
  - `qidian_parser.py`: –ü–∞—Ä—Å–µ—Ä –¥–ª—è qidian.com
  - `epub_parser.py`: –ò–º–ø–æ—Ä—Ç –∏–∑ EPUB —Ñ–∞–π–ª–æ–≤

–ü–∞—Ä—Å–µ—Ä—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç:
- –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –ø–æ URL
- SOCKS5 –ø—Ä–æ–∫—Å–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
- Cookie-based –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
- Headless/non-headless —Ä–µ–∂–∏–º—ã (czbooks —Ç—Ä–µ–±—É–µ—Ç non-headless)

### AI Translation Pipeline

1. **Context Building**: –°–±–æ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –≥–ª–∞–≤ + –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≥–ª–æ—Å—Å–∞—Ä–∏—è
2. **LLM Translation**: –ü–µ—Ä–µ–≤–æ–¥ —á–µ—Ä–µ–∑ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∞–¥–∞–ø—Ç–µ—Ä —Å —Ä–æ—Ç–∞—Ü–∏–µ–π API –∫–ª—é—á–µ–π
3. **Multi-Stage Editing**: –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è —Ä–µ–¥–∞–∫—Ç—É—Ä–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞
4. **Quality Scoring**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –ø–µ—Ä–µ–≤–æ–¥–∞

**Ollama –ø–∞—Ä–∞–º–µ—Ç—Ä—ã** (`ai_adapter_service.py:303-326`):
- **–û—Ü–µ–Ω–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤**: –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —è–∑—ã–∫–∞ —Ç–µ–∫—Å—Ç–∞
  - –ö–∏—Ç–∞–π—Å–∫–∏–π: 1.5 —Å–∏–º–≤–æ–ª–∞/—Ç–æ–∫–µ–Ω
  - –†—É—Å—Å–∫–∏–π: 2.5 —Å–∏–º–≤–æ–ª–∞/—Ç–æ–∫–µ–Ω
  - –ê–Ω–≥–ª–∏–π—Å–∫–∏–π: 4.0 —Å–∏–º–≤–æ–ª–∞/—Ç–æ–∫–µ–Ω
- **num_ctx**: `prompt_length √ó 1.2` (–ø—Ä–æ–º–ø—Ç + 20% –±—É—Ñ–µ—Ä, –º–∏–Ω–∏–º—É–º 2048)
- **num_predict**: `num_ctx √ó 2` (–Ω–æ –Ω–µ –±–æ–ª—å—à–µ max_output_tokens –º–æ–¥–µ–ª–∏)
- **–¢–∞–π–º–∞—É—Ç**: 1200 —Å–µ–∫—É–Ω–¥ (20 –º–∏–Ω—É—Ç) –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–æ–ª—å—à–∏—Ö –º–æ–¥–µ–ª–µ–π
- **–ü–æ–≤—Ç–æ—Ä—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö** (`universal_llm_translator.py:230-294`):
  - timeout, upstream_timeout, upstream_error, server_error: 2 –ø–æ–ø—ã—Ç–∫–∏ (30 —Å–µ–∫, 5 –º–∏–Ω)
  - rate_limit: 4 –ø–æ–ø—ã—Ç–∫–∏ (5 –º–∏–Ω, 10 –º–∏–Ω, 20 –º–∏–Ω, 30 –º–∏–Ω)
- –§–æ—Ä–º—É–ª–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –∫–∏—Ç–∞–π—Å–∫–∏–π‚Üí—Ä—É—Å—Å–∫–∏–π

### Background Task Queue

Celery —Å Redis –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ (`web_app/app/celery_tasks.py`):

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ—á–µ—Ä–µ–¥–µ–π**:
- **–û–¥–Ω–∞ –æ–±—â–∞—è –æ—á–µ—Ä–µ–¥—å**: `czbooks_queue` –¥–ª—è –≤—Å–µ—Ö –∑–∞–¥–∞—á (–ø–∞—Ä—Å–∏–Ω–≥, –ø–µ—Ä–µ–≤–æ–¥, —Ä–µ–¥–∞–∫—Ç—É—Ä–∞)
- **–û–¥–∏–Ω worker**: `--concurrency=1 --pool=solo` –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π Selenium
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: PostgreSQL 18.0 —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (MVCC)
- **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞**:
  - ‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ –∏ –ø–µ—Ä–µ–≤–æ–¥ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞—é—Ç (–Ω–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –ë–î)
  - ‚úÖ –ü–µ—Ä–µ–≤–æ–¥ –∏ —Ä–µ–¥–∞–∫—Ç—É—Ä–∞ —Ä–∞–∑–Ω—ã—Ö –Ω–æ–≤–µ–ª–ª –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞—é—Ç
  - ‚ö†Ô∏è Celery –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ (–∏–∑-–∑–∞ `--concurrency=1`)
  - ‚úÖ –í–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–π –∑–∞–¥–∞—á–∏ —Ä–µ–¥–∞–∫—Ç—É—Ä—ã - –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≥–ª–∞–≤ —á–µ—Ä–µ–∑ `ThreadPoolExecutor`

**–ó–∞–¥–∞—á–∏**:
- **–ü–∞—Ä—Å–∏–Ω–≥ –≥–ª–∞–≤** (`parsing.py:55`):
  - –û—á–µ—Ä–µ–¥—å: `czbooks_queue`
  - –° –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –æ—Ç–º–µ–Ω—ã
  - –¢—Ä–µ–±—É–µ—Ç Xvfb –¥–ª—è Selenium (non-headless Chrome)

- **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥**:
  - –ù–µ—Å–∫–æ–ª—å–∫–æ –≥–ª–∞–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–π –∑–∞–¥–∞—á–∏

- **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Ä–µ–¥–∞–∫—Ç—É—Ä–∞** (`celery_tasks.py:267-492`, `views.py:813`):
  - –û—á–µ—Ä–µ–¥—å: `czbooks_queue`
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `ThreadPoolExecutor` –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ **–≥–ª–∞–≤ –æ–¥–Ω–æ–π –Ω–æ–≤–µ–ª–ª—ã**
  - –ö–∞–∂–¥—ã–π –ø–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–µ—Ç —Å–≤–æ–π Flask `app_context()` –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ —Å–µ—Å—Å–∏–π –ë–î
  - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤ —á–µ—Ä–µ–∑ `novel.config['editing_threads']` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 3, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 2-5)
  - **–ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è**: –ü—Ä–æ–≤–µ—Ä–∫–∞ `chapter.status == 'edited'` –≤ –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ –ø–æ—Ç–æ–∫–∞
  - **Thread-safe –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `Lock()` –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤
  - **–ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ—Ç–º–µ–Ω—ã**: `_cancel_requested` (–æ–±—â–∞—è –¥–ª—è –≤—Å–µ—Ö –∑–∞–¥–∞—á –≤ worker'–µ)
  - **–û—Ç–º–µ–Ω–∞ –∑–∞–¥–∞—á**:
    - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –º–µ–∂–¥—É –≥–ª–∞–≤–∞–º–∏ —á–µ—Ä–µ–∑ `novel.status == 'editing_cancelled'`
    - –û—Ç–º–µ–Ω–∞ —á–µ—Ä–µ–∑ `celery.control.revoke(task_id, terminate=True, signal='SIGTERM')` (`editing.py:33`)
    - API endpoint: `POST /api/novels/<id>/edit/cancel`
  - **–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–π —Å–µ—Ä–≤–∏—Å**: `OriginalAwareEditorService` (—Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –∏ –≥–ª–æ—Å—Å–∞—Ä–∏–µ–º)

- **–û—Ç–º–µ–Ω–∞ –∑–∞–¥–∞—á**: –ß–µ—Ä–µ–∑ —Å–∏–≥–Ω–∞–ª—ã SIGTERM —Å graceful shutdown
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—É—é Redis –ë–î (DB 1) –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏

**–ú–æ–¥–µ–ª—å Novel** (`app/models/novel.py`):
- `editing_task_id`: ID –∞–∫—Ç–∏–≤–Ω–æ–π Celery –∑–∞–¥–∞—á–∏ —Ä–µ–¥–∞–∫—Ç—É—Ä—ã (–∞–Ω–∞–ª–æ–≥ `parsing_task_id`)
- `config['editing_threads']`: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤ —Ä–µ–¥–∞–∫—Ç—É—Ä—ã (1-10, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 2-5)
- `edited_chapters`: –°—á–µ—Ç—á–∏–∫ —É—Å–ø–µ—à–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≥–ª–∞–≤ (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏)

### Configuration System

–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ –∫–ª–∞—Å—Å—ã (`web_app/config/__init__.py`):
- `DevelopmentConfig`: DEBUG —Ä–µ–∂–∏–º, –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- `ProductionConfig`: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è production
- `TestingConfig`: In-memory –±–∞–∑–∞ –¥–ª—è —Ç–µ—Å—Ç–æ–≤

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ `.env`:
- `GEMINI_API_KEYS`: –°–ø–∏—Å–æ–∫ Gemini API –∫–ª—é—á–µ–π —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
- `CELERY_BROKER_URL`: Redis URL –¥–ª—è Celery (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é DB 1)
- `DATABASE_URL`: PostgreSQL connection string
- `PROXY_URL`: SOCKS5 –ø—Ä–æ–∫—Å–∏ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞

**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:**
- **–¢–∏–ø:** PostgreSQL 18.0
- **–ë–î:** `novelbins_epub`
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:** `novelbins_user`
- **Connection String:** `postgresql://novelbins_user:novelbins_strong_pass_2025@localhost:5432/novelbins_epub`
- **–¢–∞–±–ª–∏—Ü—ã:** novels, chapters, ai_models, glossary_items, prompt_templates, tasks, log_entries, translations, prompt_history, system_settings
- **Connection Pool:**
  - `pool_size`: 10 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
  - `max_overflow`: 20 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö
  - `pool_pre_ping`: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
  - `pool_recycle`: 3600 —Å–µ–∫—É–Ω–¥
- **–î–æ—Å—Ç—É–ø:**
  ```bash
  PGPASSWORD='novelbins_strong_pass_2025' psql -U novelbins_user -d novelbins_epub -h localhost
  # –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤:
  SELECT id, title, status, parsed_chapters, total_chapters FROM novels;
  SELECT COUNT(*) FROM chapters WHERE novel_id=13;
  # –°–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü:
  \dt
  # –í—ã—Ö–æ–¥:
  \q
  ```
- **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
  - ‚úÖ –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (MVCC)
  - ‚úÖ –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–∏—Å–∞—Ç–µ–ª–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
  - ‚úÖ –ù–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ "database is locked"
  - ‚úÖ Production-ready –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

### Key Integration Points

**UniversalLLMTranslator —Å —Ä–æ—Ç–∞—Ü–∏–µ–π –∫–ª—é—á–µ–π**:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É Gemini API –∫–ª—é—á–∞–º–∏ –ø—Ä–∏ rate limiting
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ failed –∫–ª—é—á–µ–π –∏ –ø–æ–ø—ã—Ç–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

**Parser Factory –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ**:
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–∞—Ä—Å–µ—Ä–æ–≤ —Å URL –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏
- `create_parser_from_url()` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä
- –õ–µ–≥–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–∞—Ä—Å–µ—Ä–æ–≤ —á–µ—Ä–µ–∑ `register_parser()`

**Celery Integration**:
- Flask app context –¥–ª—è –≤—Å–µ—Ö –∑–∞–¥–∞—á
- Soft/hard time limits –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–∞–≤–∏—Å–∞–Ω–∏–π
- –û–±—Ä–∞–±–æ—Ç–∫–∞ SIGTERM –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ—Ç–º–µ–Ω—ã –∑–∞–¥–∞—á
- Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ SocketIO

### Editing System Architecture

**OriginalAwareEditorService** - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å —Ä–µ–¥–∞–∫—Ç—É—Ä—ã (`app/services/original_aware_editor_service.py:36-145`):

–≠—Ç–∞–ø—ã —Ä–µ–¥–∞–∫—Ç—É—Ä—ã –≥–ª–∞–≤—ã:
1. **–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö** (—Å—Ç—Ä–æ–∫–∏ 40-70):
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è `original_text` (–∫–∏—Ç–∞–π—Å–∫–∏–π –æ—Ä–∏–≥–∏–Ω–∞–ª)
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è `translated_text` (—Ä—É—Å—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥)
   - –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≥–ª–æ—Å—Å–∞—Ä–∏—è —á–µ—Ä–µ–∑ `_load_prioritized_glossary()`
   - –ü–æ–¥—Å—á–µ—Ç —Ç–µ—Ä–º–∏–Ω–æ–≤ –≤–æ –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö –≥–ª–æ—Å—Å–∞—Ä–∏—è

2. **–ê–Ω–∞–ª–∏–∑ —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º** (—Å—Ç—Ä–æ–∫–∏ 75-85):
   - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–∞ —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
   - –í—ã—è–≤–ª–µ–Ω–∏–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π —Å–º—ã—Å–ª–∞
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ—á–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥–∞—á–∏ –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

3. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å —É—á–µ—Ç–æ–º –æ—Ä–∏–≥–∏–Ω–∞–ª–∞** (—Å—Ç—Ä–æ–∫–∏ 86-95):
   - –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–µ–π –ø–µ—Ä–µ–≤–æ–¥–∞
   - –£–ª—É—á—à–µ–Ω–∏–µ –ø–µ—Ä–µ–¥–∞—á–∏ —Å–º—ã—Å–ª–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏ –∏–∑ –≥–ª–æ—Å—Å–∞—Ä–∏—è

4. **–£–ª—É—á—à–µ–Ω–∏–µ —Å—Ç–∏–ª—è** (—Å—Ç—Ä–æ–∫–∏ 96-106):
   - –ü–æ–ª–∏—Ä–æ–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —á–∏—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏
   - –£–ª—É—á—à–µ–Ω–∏–µ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ–≥–æ —Å—Ç–∏–ª—è
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ—á–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–≤–æ–¥–∞

5. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞** (—Å—Ç—Ä–æ–∫–∏ 107-130):
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `chapter.edited_text`
   - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ `chapter.status = 'edited'`
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Ä–µ–¥–∞–∫—Ç—É—Ä—ã –∏ –∫–∞—á–µ—Å—Ç–≤–∞

**–ú–µ—Ç–æ–¥—ã —Ä–µ–¥–∞–∫—Ç—É—Ä—ã**:
- `analyze_with_original()`: –ê–Ω–∞–ª–∏–∑ –∫–∞—á–µ—Å—Ç–≤–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ —á–µ—Ä–µ–∑ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º
- `fix_with_original()`: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
- `polish_with_original()`: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–ª–∏—Ä–æ–≤–∫–∞ —Å—Ç–∏–ª—è —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ç–æ—á–Ω–æ—Å—Ç–∏

**–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø—Ä–æ–º–ø—Ç-—à–∞–±–ª–æ–Ω—ã** (`app/services/prompt_template_service.py`):
- `analyze_with_original_prompt`: –î–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –æ—Ä–∏–≥–∏–Ω–∞–ª—É
- `fix_with_original_prompt`: –î–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å —É—á–µ—Ç–æ–º –æ—Ä–∏–≥–∏–Ω–∞–ª–∞
- `polish_with_original_prompt`: –î–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –ø–æ–ª–∏—Ä–æ–≤–∫–∏

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≥–ª–æ—Å—Å–∞—Ä–∏–µ–º**:
- –ù–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç `GlossaryAwareEditorService`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–æ–≤ –∏–∑ –≥–ª–æ—Å—Å–∞—Ä–∏—è
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏
- –ü—Ä–∏–æ—Ä–∏—Ç–µ–∑–∞—Ü–∏—è: —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã –Ω–æ–≤–µ–ª–ª—ã ‚Üí –æ–±—â–∏–µ —Ç–µ—Ä–º–∏–Ω—ã –∂–∞–Ω—Ä–∞

### Logging System

–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ `LogService`:
- Rotational file logs (`logs/app.log`)
- Console output –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- **–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `[Novel:ID, Ch:NUM]` –≤–æ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö:
  - –õ–æ–≥–∏ —Ä–µ–¥–∞–∫—Ç—É—Ä—ã (`celery_tasks.py:329, 348, 360, 379, 384, 390, 418, 449, 466, 480, 489`)
  - –õ–æ–≥–∏ OriginalAwareEditorService (`original_aware_editor_service.py:41, 131, 136`)
  - –õ–æ–≥–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–ª–æ—Å—Å–∞—Ä–∏—è (`original_aware_editor_service.py:69`, `glossary_aware_editor_service.py:38`)
  - **–õ–æ–≥–∏ Ollama –∑–∞–ø—Ä–æ—Å–æ–≤** (`ai_adapter_service.py:339-346`):
    - –ü–µ—Ä–µ–¥–∞—á–∞ `chapter_id` —á–µ—Ä–µ–∑ `AIAdapterService.__init__(chapter_id=...)`
    - –ó–∞–≥—Ä—É–∑–∫–∞ –≥–ª–∞–≤—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è `novel_id` –∏ `chapter_number`
    - –§–æ—Ä–º–∞—Ç: `[Novel:11, Ch:104] Ollama –∑–∞–ø—Ä–æ—Å: glm-4.6:cloud | Temperature: 0.5 | Num ctx: 10,723 | ...`
