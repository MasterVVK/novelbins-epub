# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ URL –¥–ª—è EPUB –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

## üìù –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–æ–≤–µ–ª–ª —Å —Ç–∏–ø–æ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∞ EPUB —Å–∏—Å—Ç–µ–º–∞ –≤—ã–ø–æ–ª–Ω—è–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫—É URL, –∫–æ—Ç–æ—Ä–∞—è –±—ã–ª–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –≤–µ–±-URL, –Ω–æ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏–ª–∞ –¥–ª—è –ø—É—Ç–µ–π –∫ —Ñ–∞–π–ª–∞–º EPUB.

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –û–±–Ω–æ–≤–ª–µ–Ω `ParserIntegrationService.validate_url_for_source()`

**–§–∞–π–ª**: `/web_app/app/services/parser_integration.py`

```python
@classmethod
def validate_url_for_source(cls, url: str, expected_source: str) -> bool:
    # –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è EPUB –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
    if expected_source == 'epub':
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –ø—É—Ç—å –∫ EPUB —Ñ–∞–π–ª—É
        return (url.lower().endswith('.epub') or 
               'epub_files' in url or 
               url.lower().endswith('.epub/'))
    
    detected = cls.detect_source_from_url(url)
    return detected == expected_source
```

### 2. –£–ª—É—á—à–µ–Ω—ã –ø–∞—Ç—Ç–µ—Ä–Ω—ã URL –≤ `ParserFactory`

**–§–∞–π–ª**: `/parsers/parser_factory.py`

```python
_url_patterns: Dict[str, str] = {
    r'qidian\.com': 'qidian',
    r'm\.qidian\.com': 'qidian', 
    r'book\.qidian\.com': 'qidian',
    r'\.epub(?:/.*)?$': 'epub',  # –§–∞–π–ª—ã EPUB (–≤–∫–ª—é—á–∞—è –ø—É—Ç–∏ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ —Å–ª–µ—à–∞–º–∏)
    r'epub_files': 'epub',  # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å EPUB —Ñ–∞–π–ª–∞–º–∏
}
```

### 3. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–µ–ª–ª

**–§–∞–π–ª**: `/web_app/app/views.py` - —Ñ—É–Ω–∫—Ü–∏—è `add_novel()`

```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è URL –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
if source_url and not ParserIntegrationService.validate_url_for_source(source_url, source_type):
    detected = ParserIntegrationService.detect_source_from_url(source_url)
    if detected and detected != source_type:
        if source_type == 'epub':
            flash(f'–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –Ω–µ –ø–æ—Ö–æ–∂ –Ω–∞ EPUB —Ñ–∞–π–ª. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É–∫–∞–∑–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å.', 'warning')
        else:
            flash(f'–í–Ω–∏–º–∞–Ω–∏–µ: URL –±–æ–ª—å—à–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞ "{detected}", –Ω–æ –≤—ã–±—Ä–∞–Ω "{source_type}"', 'warning')
```

### 4. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–µ–ª–ª

**–§–∞–π–ª**: `/web_app/app/views.py` - —Ñ—É–Ω–∫—Ü–∏—è `edit_novel()`

–î–æ–±–∞–≤–ª–µ–Ω–∞ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ + –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è `epub_file_path`:

```python
# –î–ª—è EPUB –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–∫–∂–µ epub_file_path
if source_type == 'epub':
    novel.epub_file_path = source_url

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ URL/–ø—É—Ç–∏ –∏ —Ç–∏–ø–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
if source_url and not ParserIntegrationService.validate_url_for_source(source_url, source_type):
    # ... –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç-—Å–∫—Ä–∏–ø—Ç `test_epub_validation.py` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã:

### –í–∞–ª–∏–¥–Ω—ã–µ EPUB –ø—É—Ç–∏:
- ‚úÖ `/path/to/book.epub`
- ‚úÖ `/epub_files/novel.epub`
- ‚úÖ `/home/user/novelbins-epub/web_app/instance/epub_files/qinkan.net.epub`

### –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –ø—É—Ç–∏:
- ‚ùå `/home/user/document.pdf`
- ‚ùå `https://qidian.com/book/123` (–¥–ª—è EPUB)
- ‚ùå `/home/user/text.txt`

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚ùå EPUB –ø—É—Ç–∏ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–ª–∏—Å—å –∫–∞–∫ –≤–µ–±-URL
- ‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
- ‚ùå –ü—É—Ç–∞–Ω–∏—Ü–∞ –º–µ–∂–¥—É URL –∏ –ø—É—Ç—è–º–∏ –∫ —Ñ–∞–π–ª–∞–º

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ EPUB –ø—É—Ç–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞—Å–ø–æ–∑–Ω–∞—é—Ç—Å—è
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `epub_file_path`
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—É—Ç–µ–π

## üìã –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã

1. `/web_app/app/services/parser_integration.py` - –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
2. `/parsers/parser_factory.py` - –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤  
3. `/web_app/app/views.py` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –Ω–æ–≤–µ–ª–ª
4. `/test_epub_validation.py` - —Ç–µ—Å—Ç-—Å–∫—Ä–∏–ø—Ç (–Ω–æ–≤—ã–π)

## üöÄ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

–¢–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç EPUB –∏—Å—Ç–æ—á–Ω–∏–∫–∏:
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π –Ω–æ–≤–µ–ª–ª—ã
- –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –Ω–æ–≤–µ–ª–ª—ã
- –ü—Ä–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ —Ç–∏–ø–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
- –ü—Ä–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø—É—Ç–µ–π –∫ —Ñ–∞–π–ª–∞–º

---
**–î–∞—Ç–∞**: 05.08.2025  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ