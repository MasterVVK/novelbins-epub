# Улучшенные промпты редактирования сянься с оригиналом и глоссарием
## Для романа "Одна мысль о вечности" (一念永恒) автора Эргэн

### 1. АНАЛИЗ КАЧЕСТВА С ОРИГИНАЛОМ

```python
editing_analysis_prompt_with_original = """
Анализируй точность и качество перевода главы романа "一念永恒" автора 耳根 (Эргэн).

===== ОРИГИНАЛЬНЫЙ ТЕКСТ НА КИТАЙСКОМ (ПОЛНЫЙ) =====
{original_text}

===== ТЕКУЩИЙ ПЕРЕВОД НА РУССКИЙ =====
{translated_text}

===== ГЛОССАРИЙ УСТАНОВЛЕННЫХ ТЕРМИНОВ =====
{glossary}

ПРОВЕРЬ ТОЧНОСТЬ ПЕРЕВОДА:
1. Все ли детали оригинала присутствуют в переводе
2. Правильно ли переданы философские концепции
3. Точно ли переведены имена и термины культивации
4. Сохранены ли поэтические образы и метафоры
5. Передан ли юмор и ирония (если есть в оригинале)

ОЦЕНИ КАЧЕСТВО по шкале 1-10, учитывая:
- Полноту передачи оригинала (пропущенные детали снижают оценку!)
- Соответствие терминов глоссарию
- Естественность русской речи
- Философскую глубину и атмосферу сянься
- Точность культурных отсылок

ФОРМАТ ОТВЕТА:
КАЧЕСТВО: [число от 1 до 10]
ПРОПУЩЕНО В ПЕРЕВОДЕ: [детали из оригинала, которые отсутствуют]
НЕТОЧНЫЕ ТЕРМИНЫ: [термины, не соответствующие глоссарию]
СТРАТЕГИЯ: [style/dialogue/polish/glossary_fix/all]
КРИТИЧЕСКИЕ ОШИБКИ: [серьезные искажения смысла]
"""
```

### 2. ИСПРАВЛЕНИЕ НЕСООТВЕТСТВИЙ С ГЛОССАРИЕМ И ОРИГИНАЛОМ

```python
editing_glossary_fix_with_original = """
Исправь все несоответствия перевода с оригиналом и глоссарием для романа "一念永恒".

===== ОРИГИНАЛЬНЫЙ ТЕКСТ (КИТАЙСКИЙ) =====
{original_text}

===== ТЕКУЩИЙ ПЕРЕВОД (требует исправления) =====
{translated_text}

===== ОБЯЗАТЕЛЬНЫЙ ГЛОССАРИЙ ТЕРМИНОВ =====
{glossary}

КРИТИЧЕСКИЕ ЗАДАЧИ:
1. СВЕРЬ каждое предложение с оригиналом
2. ВОССТАНОВИ все пропущенные детали из оригинала
3. ИСПРАВЬ все имена и термины согласно глоссарию
4. ПРОВЕРЬ точность перевода философских концепций
5. УБЕДИСЬ, что сохранены все реплики и действия

ОСОБОЕ ВНИМАНИЕ:
- Китайские имена: проверь по глоссарию (例: 白小纯 = Бай Сяочунь)
- Термины культивации: строго по глоссарию
- Названия техник: точный перевод с сохранением образности
- Уровни культивации: единообразно по всему тексту

ВАЖНО:
- НЕ пропускай детали из оригинала
- НЕ добавляй отсебятины
- Верни ТОЛЬКО исправленный текст
"""
```

### 3. УЛУЧШЕНИЕ СТИЛЯ С ОРИГИНАЛОМ

```python
editing_style_with_original = """
Улучши стилистику перевода, сверяясь с оригиналом романа "一念永恒".

===== ОРИГИНАЛЬНЫЙ ТЕКСТ (для проверки точности) =====
{original_text}

===== ТЕКУЩИЙ ПЕРЕВОД (для стилистической правки) =====
{translated_text}

===== ГЛОССАРИЙ (не изменять эти термины!) =====
{glossary}

ЗАДАЧИ СТИЛИСТИЧЕСКОЙ ПРАВКИ:
1. Сверься с оригиналом - сохрани ВСЕ нюансы
2. Передай ритм и поэтичность китайского текста
3. Устрани неловкие обороты, но сохрани смысл
4. Адаптируй культурные метафоры для русского читателя
5. Сохрани баланс серьезности и юмора из оригинала

ПРОВЕРКА ПО ОРИГИНАЛУ:
- Если в оригинале короткая фраза - не растягивай
- Если поэтичное описание - сохрани образность
- Если философское размышление - передай глубину
- Если ирония - сохрани тонкий юмор

СТИЛИСТИЧЕСКИЕ ПРИНЦИПЫ:
- Естественный русский язык без канцеляризмов
- Плавность повествования как в оригинале
- Термины культивации строго по глоссарию
- Имена персонажей НЕ изменять

Верни ТОЛЬКО отредактированный текст.
"""
```

### 4. ПОЛИРОВКА ДИАЛОГОВ С ОРИГИНАЛОМ

```python
editing_dialogue_with_original = """
Отредактируй диалоги, сверяя с оригиналом романа "一念永恒".

===== ОРИГИНАЛЬНЫЕ ДИАЛОГИ (китайский) =====
{original_text}

===== ПЕРЕВЕДЕННЫЕ ДИАЛОГИ (требуют правки) =====
{translated_text}

===== ГЛОССАРИЙ ИМЕН ПЕРСОНАЖЕЙ =====
{glossary}

АНАЛИЗ ОРИГИНАЛЬНЫХ ДИАЛОГОВ:
1. Определи тон каждого персонажа в оригинале
2. Проверь формы обращения (尊称/обычные)
3. Выяви эмоциональную окраску реплик
4. Отметь юмор, иронию, сарказм

ПРИНЦИПЫ АДАПТАЦИИ:
- 前辈 (старший) → "старший брат/мастер" (не "ваш покорный ученик"!)
- 道友 (друг по Дао) → "друг/брат" (контекстно)
- Сохрани краткость или многословность как в оригинале
- Передай характер через речь, а не через штампы

РЕЧЕВЫЕ ОСОБЕННОСТИ (из оригинала):
- Бай Сяочунь: хитрый, но искренний (проверь по оригиналу!)
- Старшие: мудрые, но не напыщенные
- Враги: высокомерные, но реалистичные

КРИТИЧЕСКИ ВАЖНО:
- Сверь ВСЕ реплики с оригиналом
- НЕ пропускай и НЕ добавляй реплики
- Имена строго по глоссарию

Верни только отредактированный текст.
"""
```

### 5. ФИНАЛЬНАЯ ПОЛИРОВКА С ПОЛНОЙ ПРОВЕРКОЙ

```python
editing_final_with_original = """
Финальная проверка и полировка перевода романа "一念永恒".

===== ОРИГИНАЛ (финальная сверка) =====
{original_text}

===== ТЕКУЩИЙ ПЕРЕВОД (последняя правка) =====
{translated_text}

===== ПОЛНЫЙ ГЛОССАРИЙ =====
{glossary}

ФИНАЛЬНАЯ ПРОВЕРКА:

1. ПОЛНОТА (сверка с оригиналом):
   □ Все ли абзацы на месте
   □ Все ли предложения переведены
   □ Все ли детали сохранены
   □ Нет ли лишних добавлений

2. ТОЧНОСТЬ ТЕРМИНОЛОГИИ:
   □ Все имена по глоссарию
   □ Термины культивации единообразны
   □ Названия техник точны
   □ Титулы и обращения корректны

3. КУЛЬТУРНАЯ АДЕКВАТНОСТЬ:
   □ Философские концепции переданы точно
   □ Даосские термины понятны читателю
   □ Культурные отсылки адаптированы
   □ Юмор и ирония сохранены

4. ЛИТЕРАТУРНОЕ КАЧЕСТВО:
   □ Текст читается естественно
   □ Ритм соответствует оригиналу
   □ Эмоции переданы точно
   □ Атмосфера сянься сохранена

5. ТЕХНИЧЕСКАЯ ПРОВЕРКА:
   □ Нет опечаток и грамматических ошибок
   □ Пунктуация корректна
   □ Абзацы соответствуют оригиналу
   □ Форматирование сохранено

После всех проверок верни ТОЛЬКО финальный текст, готовый к публикации.
"""
```

## Преимущества новых промптов:

1. **Полная сверка с оригиналом** на каждом этапе
2. **Обнаружение пропущенных деталей** из китайского текста
3. **Точная передача тона и эмоций** через сравнение с оригиналом
4. **Правильная интерпретация культурных элементов**
5. **Проверка соответствия глоссарию** с учетом оригинала

## Реализация в коде:

```python
class OriginalAwareEditorService(GlossaryAwareEditorService):
    """Сервис редактирования с полной поддержкой оригинала"""

    def edit_chapter(self, chapter: Chapter) -> bool:
        # Получаем ВСЕ необходимые данные
        original_text = chapter.original_text  # Полный китайский текст
        translation = chapter.current_translation.translated_text
        glossary = self._load_prioritized_glossary(chapter.novel_id)

        # Передаем на КАЖДЫЙ этап
        strategy = self.analyze_with_original(original_text, translation, glossary)

        if strategy.get('needs_glossary_fix'):
            translation = self.fix_with_original(original_text, translation, glossary)

        if strategy.get('needs_style'):
            translation = self.improve_style_with_original(original_text, translation, glossary)

        if strategy.get('needs_dialogue'):
            translation = self.polish_dialogues_with_original(original_text, translation, glossary)

        if strategy.get('needs_polish'):
            translation = self.final_polish_with_original(original_text, translation, glossary)

        return self.save_edited_chapter(chapter, translation, glossary)
```

## Ожидаемые результаты:

- ✅ 100% полнота перевода (ничего не пропущено)
- ✅ 100% соответствие терминов глоссарию
- ✅ Точная передача философских концепций
- ✅ Сохранение культурных нюансов
- ✅ Естественные диалоги с правильным тоном
- ✅ Повышение quality_score с 6-7 до 9-10