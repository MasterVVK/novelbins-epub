# Система логирования для Novel Translator

## Обзор

Реализована комплексная система логирования, которая позволяет:
- Сохранять логи в базе данных
- Отображать логи в веб-интерфейсе в реальном времени
- Фильтровать и искать логи
- Получать статистику по логам
- Отправлять логи через WebSocket для real-time обновлений

## Архитектура

### Компоненты системы

1. **LogEntry** - модель для хранения логов в базе данных
2. **LogService** - сервис для работы с логами
3. **DatabaseHandler** - хендлер для сохранения логов в БД
4. **API endpoints** - REST API для получения логов
5. **Веб-интерфейс** - страница для просмотра логов

### Связи с существующими моделями

- Логи привязаны к задачам (Task)
- Логи привязаны к новеллам (Novel)
- Логи привязаны к главам (Chapter)

## Установка и настройка

### 1. Создание таблицы логов

```bash
cd web_app
python migrate_logs.py
```

### 2. Тестирование системы

```bash
python test_logging.py
```

### 3. Запуск приложения

```bash
python run.py
```

## Использование

### В коде Python

```python
from app.services.log_service import LogService

# Простое логирование
LogService.log_info("Информационное сообщение")
LogService.log_error("Сообщение об ошибке")
LogService.log_warning("Предупреждение")

# Логирование с привязкой к задаче
LogService.log_info("Начинаем обработку", task_id=123)
LogService.log_error("Ошибка обработки", task_id=123, 
                    extra_data={'step': 'parsing', 'error_code': 500})

# Логирование с привязкой к новелле
LogService.log_info("Новелла загружена", novel_id=456)
```

### В веб-интерфейсе

1. Откройте страницу "Логи" в навигации
2. Используйте фильтры для поиска нужных логов
3. Включите автообновление для real-time логов
4. Просматривайте статистику в верхней части страницы

### API endpoints

- `GET /api/logs` - получение логов с фильтрацией
- `GET /api/logs/recent` - недавние логи
- `GET /api/logs/errors` - только ошибки
- `GET /api/logs/task/{task_id}` - логи конкретной задачи
- `GET /api/logs/novel/{novel_id}` - логи конкретной новеллы
- `GET /api/logs/stats` - статистика логов
- `POST /api/logs/clear` - очистка старых логов

## Функциональность

### Фильтрация логов

- По уровню (ERROR, WARNING, INFO, DEBUG)
- По задаче
- По новелле
- По времени (часы, дни)
- По количеству записей

### Real-time обновления

- WebSocket подключение для мгновенных обновлений
- Автообновление каждые 5 секунд
- Анимация появления новых логов

### Статистика

- Общее количество логов
- Количество ошибок
- Количество предупреждений
- Количество информационных сообщений
- Логи за последние 24 часа

### Управление

- Очистка старых логов (старше 30 дней)
- Экспорт логов
- Поиск по тексту сообщений

## Интеграция с существующим кодом

### Обновление сервисов

Для интеграции с существующими сервисами замените:

```python
# Старый способ
logger = logging.getLogger(__name__)
logger.info("Сообщение")

# Новый способ
from app.services.log_service import LogService
LogService.log_info("Сообщение", task_id=task_id)
```

### Пример интеграции в TranslatorService

```python
def translate_chapter(self, chapter: Chapter) -> bool:
    task_id = getattr(chapter, 'current_task_id', None)
    
    LogService.log_info(f"Начинаем перевод главы {chapter.chapter_number}", 
                       task_id=task_id, novel_id=chapter.novel_id)
    
    try:
        # ... код перевода ...
        LogService.log_info(f"Перевод главы {chapter.chapter_number} завершен", 
                           task_id=task_id, novel_id=chapter.novel_id)
        return True
    except Exception as e:
        LogService.log_error(f"Ошибка перевода главы {chapter.chapter_number}: {e}", 
                            task_id=task_id, novel_id=chapter.novel_id)
        return False
```

## Производительность

### Оптимизации

1. **Индексы базы данных** - автоматически создаются для полей поиска
2. **Пагинация** - ограничение количества записей в запросах
3. **Кеширование** - статистика кешируется на короткое время
4. **Очистка старых логов** - автоматическое удаление старых записей

### Мониторинг

- Отслеживание количества логов
- Мониторинг производительности запросов
- Алерты при большом количестве ошибок

## Безопасность

- Логи не содержат чувствительной информации
- API endpoints защищены от SQL-инъекций
- Ограничение доступа к логам (можно добавить авторизацию)

## Расширение функциональности

### Возможные улучшения

1. **Экспорт логов** - выгрузка в CSV/JSON
2. **Алерты** - уведомления о критических ошибках
3. **Графики** - визуализация статистики
4. **Поиск** - полнотекстовый поиск по логам
5. **Группировка** - группировка похожих ошибок

### Добавление новых типов логов

```python
# В LogService добавить новый метод
@staticmethod
def log_critical(message: str, **kwargs):
    """Логирование критических ошибок"""
    logger = LogService.get_logger(**kwargs)
    logger.critical(message)
```

## Устранение неполадок

### Частые проблемы

1. **Таблица логов не создана**
   ```bash
   python migrate_logs.py
   ```

2. **Логи не отображаются в веб-интерфейсе**
   - Проверьте WebSocket подключение
   - Убедитесь, что логи сохраняются в БД

3. **Медленная работа страницы логов**
   - Уменьшите лимит записей
   - Добавьте индексы в базу данных

### Отладка

```python
# Проверка сохранения логов
from app.services.log_service import LogService
logs = LogService.get_recent_logs(hours=1)
print(f"Логов за час: {len(logs)}")

# Проверка статистики
stats = LogService.get_log_stats()
print(f"Статистика: {stats}")
```

## Заключение

Новая система логирования предоставляет полный контроль над логами приложения, позволяя отслеживать выполнение задач, диагностировать проблемы и анализировать производительность системы в реальном времени. 