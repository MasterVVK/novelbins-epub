"""
Сервис для управления шаблонами промптов перевода и редактуры
"""
from typing import List, Dict, Optional
from app.models import PromptTemplate
from app import db


class PromptTemplateService:
    """Сервис для работы с шаблонами промптов"""
    
    @staticmethod
    def create_default_templates():
        """Создание шаблонов по умолчанию"""
        templates = [
            {
                'name': 'Сянься (Покрывая Небеса)',
                'description': 'Шаблон для китайских веб-новелл жанра сянься',
                'category': 'xianxia',
                'is_default': True,
                'translation_prompt': """Ты профессиональный переводчик китайских веб-новелл жанра сянься.
Переводишь роман "Shrouding the Heavens" (遮天) с английского на русский.

ОСОБЕННОСТИ ЖАНРА:
Веб-новеллы часто содержат резкие переходы между сценами без предупреждения:
- Современная жизнь → древние артефакты
- Встречи друзей → космические драконы
- Городские сцены → мистические события
Это НОРМАЛЬНО для жанра. Переводи всё как есть, сохраняя эти переходы.

КРИТИЧЕСКИ ВАЖНЫЕ ПРАВИЛА ТОЧНОСТИ:

1. ПОЛНОТА ПЕРЕВОДА:
   - Переводи ВЕСЬ текст без пропусков
   - Сохраняй ВСЕ абзацы и их структуру
   - НЕ объединяй и НЕ разделяй абзацы
   - Сохраняй резкие переходы между сценами

2. ИМЕНА И НАЗВАНИЯ:
   - Ye Fan → Е Фань (главный герой)
   - Pang Bo → Пан Бо (друг главного героя)
   - Liu Yunzhi → Лю Юньчжи
   - Lin Jia → Линь Цзя
   - Mount Tai → гора Тайшань
   - Строго следуй переводам из предоставленного глоссария

3. ТЕРМИНЫ КУЛЬТИВАЦИИ:
   - cultivation → культивация
   - qi/chi → ци
   - dao → дао
   - immortal → бессмертный
   - divine power → божественная сила
   - spiritual energy → духовная энергия
   - Используй ТОЛЬКО термины из глоссария для известных понятий

4. ЧИСЛА И ИЗМЕРЕНИЯ:
   - Сохраняй ВСЕ числовые значения точно как в оригинале
   - zhang (3.3 метра) → чжан
   - li (500 метров) → ли
   - Не переводи числа в другие системы измерения

5. СТИЛИСТИКА СЯНЬСЯ:
   - Сохраняй поэтичность описаний природы
   Пример: "clouds and mist swirled like dragons" → "облака и туман кружились словно драконы"
   - Передавай эпичность боевых сцен
   - Сохраняй восточный колорит метафор

6. ИЕРАРХИЯ И ОБРАЩЕНИЯ:
   - senior brother → старший брат (по школе)
   - junior sister → младшая сестра (по школе)
   - elder → старейшина
   - ancestor → предок/патриарх

7. СОВРЕМЕННЫЕ ЭЛЕМЕНТЫ (когда встречаются):
   - Переводи названия машин, технологий как есть
   - Mercedes-Benz → Мерседес-Бенц
   - Toyota → Тойота
   - karaoke → караоке

8. ЗВУКОВЫЕ ЭФФЕКТЫ:
   - "Wooo..." → "Уууу..." (протяжный вой)
   - "Ahhh..." → "Аааа..." (протяжный крик)
   - "Eeee..." → "Ииии..." (визг)
   - "Ohhh..." → "Оооо..." (стон)
   - "Nooo..." → "Нееет..." (протяжный крик)
   - Многоточие означает протяжный/затухающий звук

ЗАПРЕЩЕНО:
❌ Пропускать предложения или абзацы
❌ Добавлять пояснения в скобках
❌ Изменять имена собственные произвольно
❌ Упрощать или модернизировать язык
❌ Объединять короткие предложения
❌ Удивляться резким переходам между сценами

ФОРМАТ ОТВЕТА:
В первой строке напиши ТОЛЬКО переведённое название главы (без слова "Глава" и номера).
Затем с новой строки начни перевод основного текста.""",
                
                'summary_prompt': """Ты работаешь с китайской веб-новеллой жанра сянься, где часто происходят резкие переходы между сценами.
Это нормально для жанра - могут чередоваться:
- Современные сцены (встречи друзей, городская жизнь)
- Фантастические элементы (драконы, древние артефакты)
- Воспоминания и флешбеки
- Параллельные сюжетные линии

Составь КРАТКОЕ резюме главы (максимум 150 слов) для использования как контекст в следующих главах.
Включи:
- Ключевые события (что произошло)
- Важные открытия или изменения в силе персонажей
- Новые локации (куда переместились герои)
- Активных персонажей (кто участвовал)
- Важные артефакты или техники

Пиши в прошедшем времени, только факты, без оценок.
Если в главе есть переходы между разными сценами, упомяни ОБЕ сюжетные линии.""",
                
                'terms_extraction_prompt': """Ты работаешь с китайской веб-новеллой, где могут чередоваться современные и фантастические элементы.

Извлеки из текста ТОЛЬКО НОВЫЕ элементы (которых нет в глоссарии):

1. Новые ПЕРСОНАЖИ (имена людей, титулы)
2. Новые ЛОКАЦИИ (места, города, священные земли)
3. Новые ТЕРМИНЫ (техники культивации, уровни силы, артефакты)
4. Новые ТЕХНИКИ (боевые приемы, заклинания)
5. Новые АРТЕФАКТЫ (оружие, сокровища, реликвии)

ФОРМАТ ОТВЕТА:
ПЕРСОНАЖИ:
- English Name = Русское Имя

ЛОКАЦИИ:
- English Location = Русская Локация

ТЕРМИНЫ:
- English Term = Русский Термин

ТЕХНИКИ:
- English Technique = Русская Техника

АРТЕФАКТЫ:
- English Artifact = Русский Артефакт

Если в какой-то категории нет новых элементов, напиши "нет новых".

ВАЖНО:
- Извлекай только ИМЕНА СОБСТВЕННЫЕ и СПЕЦИАЛЬНЫЕ ТЕРМИНЫ
- НЕ извлекай обычные слова
- Проверяй, что термина нет в существующем глоссарии
- Используй точные переводы, соответствующие контексту""",
                
                'temperature': 0.1,
                'max_tokens': 24000
            },
            
            {
                'name': 'Уся (Боевые Искусства)',
                'description': 'Шаблон для веб-новелл жанра уся',
                'category': 'wuxia',
                'is_default': False,
                'translation_prompt': """Ты профессиональный переводчик китайских веб-новелл жанра уся.
Переводишь роман с английского на русский.

ОСОБЕННОСТИ ЖАНРА УСЯ:
- Фокус на боевых искусствах и кунг-фу
- Мирские конфликты и месть
- Школы боевых искусств
- Внутренняя сила (qi/chi)
- Оружие и техники

КРИТИЧЕСКИ ВАЖНЫЕ ПРАВИЛА:

1. ПОЛНОТА ПЕРЕВОДА:
   - Переводи ВЕСЬ текст без пропусков
   - Сохраняй ВСЕ абзацы и их структуру
   - НЕ объединяй и НЕ разделяй абзацы

2. БОЕВЫЕ ТЕРМИНЫ:
   - martial arts → боевые искусства
   - kung fu → кунг-фу
   - internal energy → внутренняя сила
   - external techniques → внешние техники
   - sword technique → техника меча
   - palm strike → удар ладонью

3. ИЕРАРХИЯ:
   - master → мастер
   - disciple → ученик
   - sect → секта
   - elder → старейшина

4. ОРУЖИЕ:
   - sword → меч
   - saber → сабля
   - spear → копье
   - staff → посох

ФОРМАТ ОТВЕТА:
В первой строке напиши ТОЛЬКО переведённое название главы.
Затем с новой строки начни перевод основного текста.""",
                
                'summary_prompt': """Создай краткое резюме главы уся (максимум 150 слов).
Включи:
- Ключевые боевые сцены
- Новые техники или оружие
- Конфликты между персонажами
- Развитие силы главного героя
- Важные события в мире боевых искусств

Пиши в прошедшем времени, только факты.""",
                
                'terms_extraction_prompt': """Извлеки из текста НОВЫЕ элементы уся:

ПЕРСОНАЖИ:
- English Name = Русское Имя

ЛОКАЦИИ:
- English Location = Русская Локация

ТЕХНИКИ:
- English Technique = Русская Техника

ОРУЖИЕ:
- English Weapon = Русское Оружие

СЕКТЫ:
- English Sect = Русская Секта

Если в категории нет новых элементов, напиши "нет новых".""",
                
                'temperature': 0.1,
                'max_tokens': 24000
            },
            
            {
                'name': 'Современный Роман',
                'description': 'Шаблон для современных романов',
                'category': 'modern',
                'is_default': False,
                'translation_prompt': """Ты профессиональный переводчик современной литературы.
Переводишь роман с английского на русский.

ОСОБЕННОСТИ СОВРЕМЕННОЙ ЛИТЕРАТУРЫ:
- Естественная речь и диалоги
- Современные реалии и технологии
- Психологические аспекты
- Социальные темы

КРИТИЧЕСКИ ВАЖНЫЕ ПРАВИЛА:

1. ПОЛНОТА ПЕРЕВОДА:
   - Переводи ВЕСЬ текст без пропусков
   - Сохраняй ВСЕ абзацы и их структуру
   - Сохраняй стиль и тон повествования

2. ДИАЛОГИ:
   - Делай речь естественной для русского языка
   - Сохраняй индивидуальность персонажей
   - Передавай эмоции и интонации

3. СОВРЕМЕННЫЕ ТЕРМИНЫ:
   - Переводи названия технологий и брендов
   - Сохраняй культурные отсылки
   - Адаптируй идиомы к русскому языку

ФОРМАТ ОТВЕТА:
В первой строке напиши ТОЛЬКО переведённое название главы.
Затем с новой строки начни перевод основного текста.""",
                
                'summary_prompt': """Создай краткое резюме главы (максимум 150 слов).
Включи:
- Ключевые события
- Развитие персонажей
- Важные диалоги
- Эмоциональные моменты
- Сюжетные повороты

Пиши в прошедшем времени, только факты.""",
                
                'terms_extraction_prompt': """Извлеки из текста НОВЫЕ элементы:

ПЕРСОНАЖИ:
- English Name = Русское Имя

ЛОКАЦИИ:
- English Location = Русская Локация

ТЕРМИНЫ:
- English Term = Русский Термин

Если в категории нет новых элементов, напиши "нет новых".""",
                
                'temperature': 0.2,
                'max_tokens': 24000
            },
            
            {
                'name': 'Сянься (Я хочу запечатать небеса)',
                'description': 'Шаблон для романа "我欲封天" (I Shall Seal the Heavens) автора Ergen',
                'category': 'xianxia',
                'is_default': False,
                'translation_prompt': """Ты профессиональный переводчик китайских веб-новелл жанра сянься.
Переводишь роман "I Shall Seal the Heavens" (我欲封天) с китайского на русский.

ОСОБЕННОСТИ РОМАНА "Я ХОЧУ ЗАПЕЧАТАТЬ НЕБЕСА":
Автор: 耳根 (Ergen) - известен своим философским подходом и детализированной системой культивации.
Особенности стиля:
- Глубокие философские размышления о пути Дао
- Мистические артефакты с уникальными способностями
- Сложная алхимическая система
- Эмоциональные переживания главного героя
- Юмористические моменты и ироничные ситуации

🚨 КРИТИЧЕСКИ ВАЖНЫЕ ПРАВИЛА ПОЛНОГО ПЕРЕВОДА:

1. АБСОЛЮТНАЯ ПОЛНОТА ПЕРЕВОДА:
   - Переводи КАЖДЫЙ китайский символ на русский
   - В финальном тексте НЕ ДОЛЖНО остаться НИ ОДНОГО китайского символа
   - Переводи ВЕСЬ текст без пропусков
   - Сохраняй ВСЕ абзацы и их структуру
   - НЕ объединяй и НЕ разделяй абзацы
   - Сохраняй резкие переходы между сценами

🔴 ЗАПРЕЩЕНО СМЕШИВАТЬ ЯЗЫКИ:
   ❌ НЕ оставляй китайские символы в русском тексте
   ❌ НЕ используй конструкции типа "看了孟 Хао" или "孟浩一眼"
   ✅ Переводи полностью: "посмотрел на Мэн Хао" или "Мэн Хао взглянул"

2. КЛЮЧЕВЫЕ ПЕРСОНАЖИ:
   - 孟浩 → Мэн Хао (главный герой, молодой ученый)
   - 小胖子 → Пухлик (друг главного героя)
   - 许师姐 → Старшая сестра Сю
   - 王腾飞 → Ван Тэнфэй
   - Строго следуй переводам из предоставленного глоссария

3. КЛЮЧЕВЫЕ ЛОКАЦИИ:
   - 靠山宗 → Секта Опоры
   - 南域 → Южный регион
   - 赵国 → Государство Чжао
   - 大青山 → Гора Дацин

4. СИСТЕМА КУЛЬТИВАЦИИ И ТЕРМИНЫ:
   - 凝气 → Конденсация ци (1-й уровень)
   - 筑基 → Создание основы (2-й уровень)
   - 结丹 → Формирование ядра (3-й уровень)
   - 元婴 → Изначальная душа (4-й уровень)
   - 灵石 → духовные камни
   - 丹药 → пилюли
   - 法术 → магические техники
   - 法宝 → магические сокровища

5. УНИКАЛЬНЫЕ ЭЛЕМЕНТЫ РОМАНА:
   - 铜镜 → медное зеркало (основной артефакт Мэн Хао)
   - 封印 → печать
   - 天道 → Небесное Дао
   - 造化 → творение судьбы
   - 本源 → изначальная суть
   - 轮回 → реинкарнация

6. АЛХИМИЯ И ПИЛЮЛИ:
   - 炼丹 → алхимия
   - 丹方 → рецепт пилюль
   - 药草 → лекарственные травы
   - 炉鼎 → алхимическая печь
   - 丹火 → алхимический огонь

7. ЧИСЛА И ИЗМЕРЕНИЯ:
   - Сохраняй ВСЕ числовые значения точно как в оригинале
   - 丈 → чжан (примерно 3.3 метра)
   - 里 → ли (примерно 500 метров)
   - 年 → год
   - 月 → месяц
   - 日 → день

8. СТИЛИСТИКА ЭРГЕНА:
   - Сохраняй философскую глубину размышлений
   - Передавай эмоциональную насыщенность
   - Сохраняй поэтичность описаний природы и культивации
   - Передавай тонкий юмор и иронию автора
   - Сохраняй мистическую атмосферу

9. ЭМОЦИИ И ВОСКЛИЦАНИЯ:
   - Сохраняй все восклицания и эмоциональную окраску
   - "啊" → "а" / "ах"
   - "哈哈" → "ха-ха"
   - "呵呵" → "хе-хе"
   - "嗯" → "мм" / "хм"

10. ЗВУКОВЫЕ ЭФФЕКТЫ:
    - "轰" → "бум" / "грохот"
    - "砰" → "бах" / "пах"
    - "嗡" → "жужжание" / "гул"
    - "咔嚓" → "треск" / "хруст"

СТРОГО ЗАПРЕЩЕНО:
❌ Пропускать предложения или абзацы
❌ Добавлять пояснения в скобках
❌ Изменять имена собственные произвольно
❌ Упрощать философские размышления
❌ Объединять короткие предложения
❌ Терять эмоциональную окраску текста
🚨 ОСТАВЛЯТЬ КИТАЙСКИЕ СИМВОЛЫ В РУССКОМ ТЕКСТЕ
🚨 СМЕШИВАТЬ КИТАЙСКИЙ И РУССКИЙ В ОДНОМ ПРЕДЛОЖЕНИИ
🚨 ЧАСТИЧНО ПЕРЕВОДИТЬ ФРАЗЫ

⚠️ ОБЯЗАТЕЛЬНАЯ ПРОВЕРКА ПЕРЕД ОТВЕТОМ:
Проверь свой перевод - НЕТ ЛИ в нем китайских символов (汉字)?
Если есть - переведи их на русский!

ФОРМАТ ОТВЕТА:
В первой строке напиши ТОЛЬКО переведённое название главы (без слова "Глава" и номера).
Затем с новой строки начни перевод основного текста.
ВАЖНО: Весь текст должен быть ТОЛЬКО на русском языке!""",
                
                'summary_prompt': """Ты работаешь с китайской веб-новеллой "我欲封天" (I Shall Seal the Heavens) жанра сянься.
Автор Ergen известен своим глубоким философским подходом и детализированной системой культивации.

Особенности романа:
- Философские размышления о Дао и пути культивации
- Сложная система алхимии и создания пилюль
- Мистические артефакты с уникальными способностями
- Эмоциональные переживания и внутренние конфликты
- Тонкий юмор и ироничные ситуации

Составь КРАТКОЕ резюме главы (максимум 150 слов) для использования как контекст в следующих главах.
Включи:
- Ключевые события (что произошло с Мэн Хао)
- Прогресс в культивации или новые способности
- Важные открытия или артефакты
- Новые персонажи или локации
- Философские озарения или важные решения
- Алхимические эксперименты или новые пилюли
- Эмоциональные изменения главного героя

Пиши в прошедшем времени, только факты, без оценок.
Если в главе есть философские размышления, кратко упомяни их суть.""",
                
                'terms_extraction_prompt': """Ты работаешь с романом "我欲封天" (I Shall Seal the Heavens) автора Ergen.
Это сянься произведение с богатой терминологией культивации, алхимии и мистических артефактов.

Извлеки из текста ТОЛЬКО НОВЫЕ элементы (которых нет в глоссарии):

1. Новые ПЕРСОНАЖИ (имена людей, титулы, прозвища)
2. Новые ЛОКАЦИИ (секты, города, регионы, горы, пещеры)
3. Новые ТЕРМИНЫ КУЛЬТИВАЦИИ (уровни силы, техники, состояния)
4. Новые ТЕХНИКИ И ЗАКЛИНАНИЯ (боевые приемы, магические способности)
5. Новые АРТЕФАКТЫ (оружие, сокровища, пилюли, инструменты)
6. Новые АЛХИМИЧЕСКИЕ ТЕРМИНЫ (пилюли, травы, рецепты)

ФОРМАТ ОТВЕТА:
ПЕРСОНАЖИ:
- Chinese Name = Русский Перевод

ЛОКАЦИИ:
- Chinese Location = Русская Локация

ТЕРМИНЫ:
- Chinese Term = Русский Термин

ТЕХНИКИ:
- Chinese Technique = Русская Техника

АРТЕФАКТЫ:
- Chinese Artifact = Русский Артефакт

АЛХИМИЯ:
- Chinese Item = Русский Перевод

Если в категории нет новых элементов, напиши "нет новых".

ВАЖНО:
- Извлекай только ИМЕНА СОБСТВЕННЫЕ и СПЕЦИАЛЬНЫЕ ТЕРМИНЫ
- НЕ извлекай обычные слова
- Проверяй, что термина нет в существующем глоссарии
- Используй точные переводы, соответствующие контексту""",
                
                'temperature': 0.1,
                'max_tokens': 24000,
                
                # Промпты редактуры для сянься (ISSTH)
                'editing_analysis_prompt': """Проанализируй качество этого переведенного текста сянься "Я хочу запечатать небеса" и определи стратегию редактуры:

{text}

Оцени качество по шкале 1-10, учитывая:
- Полноту перевода китайских терминов
- Последовательность терминологии культивации
- Естественность диалогов
- Поэтичность описаний культивации
- Философскую глубину размышлений Мэн Хао
- Юмористические моменты и иронию

ФОРМАТ ОТВЕТА:
КАЧЕСТВО: [число от 1 до 10]
ПРОБЛЕМЫ: [список основных проблем]
СТРАТЕГИЯ: [style/dialogue/polish/all]
ОПИСАНИЕ: [краткое описание проблем]""",
                
                'editing_style_prompt': """Улучши стиль этого переведенного текста "Я хочу запечатать небеса". Сохраняй поэтичность и философскую глубину Эргена:

{text}

КРИТИЧЕСКИ ВАЖНЫЕ ПРАВИЛА:
- НЕ добавляй никакое форматирование (жирный текст, звездочки, курсив)
- НЕ добавляй вступительные фразы типа "Вот аккуратно отполированный текст"
- НЕ добавляй комментарии или пояснения
- Верни ТОЛЬКО исправленный текст без дополнений

Правила для ISSTH:
- Улучши плавность переходов между описаниями культивации
- Исправь неловкие обороты в терминологии культивации
- Сохрани мистическую атмосферу и юмор
- Передай эмоциональную насыщенность Мэн Хао
- Подчеркни философские размышления о Дао
- Не меняй термины культивации и имена персонажей
- Убери излишне торжественные обращения, сделай речь естественной
- НЕ СОКРАЩАЙ текст - он должен остаться той же длины""",
                
                'editing_dialogue_prompt': """Отполируй диалоги в этом тексте "Я хочу запечатать небеса". Сделай их более выразительными и характерными:

{text}

КРИТИЧЕСКИ ВАЖНЫЕ ПРАВИЛА:
- НЕ добавляй никакое форматирование (жирный текст, звездочки, курсив)
- НЕ добавляй вступительные фразы или комментарии
- Верни ТОЛЬКО исправленный текст без дополнений
- НЕ СОКРАЩАЙ текст - он должен остаться той же длины

Правила для диалогов ISSTH:
- Сделай речь естественной, но сохрани колорит сянься
- Убери излишне торжественные и неестественные обращения
- Замени "ваш покорный ученик" на более простые формы вежливости
- Передай статус через тон, а не через заученные фразы
- Сохрани мудрость старших персонажей
- Подчеркни решимость и хитрость Мэн Хао
- Сохрани ироничные и юмористические реплики
- Не меняй смысл реплик и имена персонажей""",
                
                'editing_final_prompt': """Сделай финальную полировку этого текста "Я хочу запечатать небеса":

{text}

КРИТИЧЕСКИ ВАЖНЫЕ ПРАВИЛА:
- НЕ добавляй никакое форматирование (жирный текст, звездочки, курсив)
- НЕ добавляй вступительные фразы или комментарии
- Верни ТОЛЬКО исправленный текст без дополнений
- НЕ СОКРАЩАЙ текст - он должен остаться той же длины

Правила финальной полировки ISSTH:
- Проверь согласованность терминов культивации
- Обеспечь плавность повествования
- Сохрани философские размышления о пути Дао
- Подчеркни эмоциональные переживания Мэн Хао
- Проверь все детали алхимии и артефактов
- Сохрани баланс между серьезностью и юмором
- Убери неестественные обращения и фразы
- Сделай диалоги более естественными для русского языка"""
            }
        ]
        
        for template_data in templates:
            # Проверяем, существует ли уже такой шаблон
            existing = PromptTemplate.query.filter_by(name=template_data['name']).first()
            if not existing:
                template = PromptTemplate(**template_data)
                db.session.add(template)
        
        db.session.commit()
        print("✅ Созданы шаблоны промптов по умолчанию")
    
    @staticmethod
    def get_all_templates() -> List[PromptTemplate]:
        """Получение всех активных шаблонов"""
        return PromptTemplate.query.filter_by(is_active=True).order_by(PromptTemplate.name).all()
    
    @staticmethod
    def get_templates_by_category(category: str) -> List[PromptTemplate]:
        """Получение шаблонов по категории"""
        return PromptTemplate.query.filter_by(category=category, is_active=True).all()
    
    @staticmethod
    def get_template_by_id(template_id: int) -> Optional[PromptTemplate]:
        """Получение шаблона по ID"""
        return PromptTemplate.query.get(template_id)
    
    @staticmethod
    def get_template(template_name: str, prompt_type: str = 'translation') -> str:
        """Получение промпта по имени шаблона и типу
        
        Args:
            template_name: Название шаблона
            prompt_type: Тип промпта ('translation', 'summary', 'terms_extraction', 
                        'editing_analysis', 'editing_style', 'editing_dialogue', 'editing_final')
        
        Returns:
            Текст промпта или дефолтный промпт если не найден
        """
        template = PromptTemplate.query.filter_by(name=template_name, is_active=True).first()
        if not template:
            return PromptTemplateService._get_default_prompt(prompt_type)
        
        # Базовые промпты перевода
        if prompt_type == 'translation':
            return template.translation_prompt or PromptTemplateService._get_default_prompt('translation')
        elif prompt_type == 'summary':
            return template.summary_prompt or PromptTemplateService._get_default_prompt('summary')
        elif prompt_type == 'terms_extraction':
            return template.terms_extraction_prompt or PromptTemplateService._get_default_prompt('terms_extraction')
        
        # Промпты редактуры - получаем из шаблона или дефолтные
        elif prompt_type == 'editing_analysis':
            return getattr(template, 'editing_analysis_prompt', None) or PromptTemplateService._get_default_prompt('editing_analysis')
        elif prompt_type == 'editing_style':
            return getattr(template, 'editing_style_prompt', None) or PromptTemplateService._get_default_prompt('editing_style')
        elif prompt_type == 'editing_dialogue':
            return getattr(template, 'editing_dialogue_prompt', None) or PromptTemplateService._get_default_prompt('editing_dialogue')
        elif prompt_type == 'editing_final':
            return getattr(template, 'editing_final_prompt', None) or PromptTemplateService._get_default_prompt('editing_final')
        
        return PromptTemplateService._get_default_prompt(prompt_type)
    
    @staticmethod
    def _get_default_prompt(prompt_type: str) -> str:
        """Получение дефолтных промптов"""
        defaults = {
            'translation': """Переведи следующий текст с английского на русский, сохраняя стиль и структуру:

{text}

Правила:
- Переводи весь текст полностью
- Сохраняй абзацы и структуру
- Не добавляй пояснения
- Сохраняй имена собственные""",
            
            'summary': """Создай краткое резюме главы (максимум 150 слов).
Включи ключевые события, персонажей и важные моменты.
Пиши в прошедшем времени, только факты.""",
            
            'terms_extraction': """Извлеки из текста новые элементы:

ПЕРСОНАЖИ:
- English Name = Русское Имя

ЛОКАЦИИ:
- English Location = Русская Локация

ТЕРМИНЫ:
- English Term = Русский Термин

Если в категории нет новых элементов, напиши "нет новых".""",
            
            'editing_analysis': """Проанализируй качество этого переведенного текста и определи стратегию редактуры:

{text}

Оцени качество по шкале 1-10 и определи, какие улучшения нужны.

ФОРМАТ ОТВЕТА:
КАЧЕСТВО: [число от 1 до 10]
ПРОБЛЕМЫ: [список основных проблем]
СТРАТЕГИЯ: [style/dialogue/polish/all]
ОПИСАНИЕ: [краткое описание проблем]""",
            
            'editing_style': """Улучши стиль этого переведенного текста. Сделай его более читаемым и литературным:

{text}

Правила:
- Улучши плавность предложений
- Исправь неловкие обороты
- Сохрани смысл и структуру
- Не меняй имена и термины""",
            
            'editing_dialogue': """Отполируй диалоги в этом тексте. Сделай их более естественными:

{text}

Правила:
- Сделай диалоги более живыми
- Исправь пунктуацию в диалогах
- Сохрани характер персонажей
- Не меняй смысл реплик""",
            
            'editing_final': """Сделай финальную полировку этого текста:

{text}

Правила:
- Исправь мелкие ошибки
- Улучши читаемость
- Проверь согласованность
- Сохрани все важные детали"""
        }
        
        return defaults.get(prompt_type, defaults['translation'])
    
    @staticmethod
    def create_template(data: Dict) -> PromptTemplate:
        """Создание нового шаблона"""
        template = PromptTemplate(**data)
        db.session.add(template)
        db.session.commit()
        return template
    
    @staticmethod
    def update_template(template_id: int, data: Dict) -> Optional[PromptTemplate]:
        """Обновление шаблона"""
        template = PromptTemplate.query.get(template_id)
        if not template:
            return None
        
        for key, value in data.items():
            if hasattr(template, key):
                setattr(template, key, value)
        
        db.session.commit()
        return template
    
    @staticmethod
    def delete_template(template_id: int) -> bool:
        """Удаление шаблона (мягкое удаление)"""
        template = PromptTemplate.query.get(template_id)
        if not template:
            return False
        
        template.is_active = False
        db.session.commit()
        return True
    
    @staticmethod
    def copy_template(template_id: int, new_name: str = None) -> Optional[PromptTemplate]:
        """Копирование шаблона"""
        template = PromptTemplate.query.get(template_id)
        if not template:
            return None
        
        new_template = template.copy(new_name)
        db.session.add(new_template)
        db.session.commit()
        return new_template
    
    @staticmethod
    def set_default_template(template_id: int) -> bool:
        """Установка шаблона по умолчанию"""
        # Сначала сбрасываем все шаблоны
        PromptTemplate.query.update({'is_default': False})
        
        # Устанавливаем новый
        template = PromptTemplate.query.get(template_id)
        if not template:
            return False
        
        template.is_default = True
        db.session.commit()
        return True
    
    @staticmethod
    def get_categories() -> List[str]:
        """Получение списка категорий"""
        categories = db.session.query(PromptTemplate.category).distinct().all()
        return [cat[0] for cat in categories if cat[0]]
    
    @staticmethod
    def validate_template_data(data: Dict) -> Dict[str, List[str]]:
        """Валидация данных шаблона"""
        errors = []
        
        if not data.get('name'):
            errors.append('Название обязательно')
        
        if not data.get('translation_prompt'):
            errors.append('Промпт для перевода обязателен')
        
        if data.get('temperature') is not None:
            try:
                temp = float(data['temperature'])
                if temp < 0 or temp > 2:
                    errors.append('Температура должна быть от 0 до 2')
            except ValueError:
                errors.append('Температура должна быть числом')
        
        if data.get('max_tokens') is not None:
            try:
                tokens = int(data['max_tokens'])
                if tokens < 1000 or tokens > 521000:
                    errors.append('Максимальное количество токенов должно быть от 1000 до 512000')
            except ValueError:
                errors.append('Максимальное количество токенов должно быть числом')
        
        return {'errors': errors, 'valid': len(errors) == 0} 