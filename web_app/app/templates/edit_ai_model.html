{% extends "base.html" %}

{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ - Novel Translator{% endblock %}
{% block page_title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ AI –º–æ–¥–µ–ª–∏{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: {{ model.name }}</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('main.api_update_ai_model', model_id=model.id) }}" id="editModelForm">
                    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                    <div class="mb-4">
                        <h6 class="text-muted">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                        <hr>

                        <div class="mb-3">
                            <label for="name" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏</label>
                            <input type="text" class="form-control" id="name" name="name"
                                   value="{{ model.name }}" required>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea class="form-control" id="description" name="description" rows="2">{{ model.description }}</textarea>
                        </div>

                        <div class="mb-3">
                            <label for="model_id" class="form-label">ID –º–æ–¥–µ–ª–∏ (–≤ API –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞)</label>
                            <input type="text" class="form-control" id="model_id" name="model_id"
                                   value="{{ model.model_id }}" required>
                            <div class="form-text">–ù–∞–ø—Ä–∏–º–µ—Ä: gemini-2.5-flash, gpt-4o, claude-3-5-sonnet-20241022</div>
                        </div>
                    </div>

                    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ API -->
                    <div class="mb-4">
                        <h6 class="text-muted">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ API</h6>
                        <hr>

                        <div class="mb-3">
                            <label for="provider" class="form-label">–ü—Ä–æ–≤–∞–π–¥–µ—Ä</label>
                            <input type="text" class="form-control" id="provider" value="{{ model.provider }}" disabled>
                            <div class="form-text">–ü—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –º–æ–¥–µ–ª–∏</div>
                        </div>

                        {% if model.provider != 'ollama' %}
                        {% if model.provider == 'gemini' %}
                        <!-- –î–ª—è Gemini - —Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π -->
                        <div class="mb-3">
                            <label for="api_keys" class="form-label">
                                API –∫–ª—é—á–∏ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É)
                                {% if model.api_keys %}
                                    <span class="badge bg-info">{{ model.api_keys | length }} –∫–ª—é—á–µ–π</span>
                                {% endif %}
                            </label>
                            <textarea class="form-control font-monospace" id="api_keys" name="api_keys"
                                      rows="8" placeholder="AIzaSy...&#10;AIzaSy...&#10;AIzaSy...">{% if model.api_keys %}{{ model.api_keys | join('\n') }}{% endif %}</textarea>
                            <div class="form-text">
                                Gemini –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–æ—Ç–∞—Ü–∏—é –∫–ª—é—á–µ–π –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ rate limits.
                                –í–≤–µ–¥–∏—Ç–µ –ø–æ –æ–¥–Ω–æ–º—É –∫–ª—é—á—É –Ω–∞ —Å—Ç—Ä–æ–∫—É –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–æ—Ç–∞—Ü–∏–∏.
                            </div>
                        </div>
                        {% else %}
                        <!-- –î–ª—è –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ - –æ–¥–∏–Ω –∫–ª—é—á -->
                        <div class="mb-3">
                            <label for="api_key" class="form-label">API –∫–ª—é—á</label>
                            <input type="text" class="form-control font-monospace" id="api_key" name="api_key"
                                   value="{{ model.api_key or '' }}"
                                   placeholder="sk-...">
                            <div class="form-text">API –∫–ª—é—á –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ {{ model.provider | upper }}</div>
                        </div>
                        {% endif %}
                        {% endif %}

                        <div class="mb-3">
                            <label for="api_endpoint" class="form-label">API Endpoint</label>
                            <input type="url" class="form-control" id="api_endpoint" name="api_endpoint"
                                   value="{{ model.api_endpoint }}" required>
                        </div>
                    </div>

                    <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -->
                    <div class="mb-4">
                        <h6 class="text-muted">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</h6>
                        <hr>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="max_input_tokens" class="form-label">–ú–∞–∫—Å. –≤—Ö–æ–¥–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤</label>
                                    <input type="number" class="form-control" id="max_input_tokens" name="max_input_tokens"
                                           value="{{ model.max_input_tokens }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="max_output_tokens" class="form-label">–ú–∞–∫—Å. –≤—ã—Ö–æ–¥–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤</label>
                                    <input type="number" class="form-control" id="max_output_tokens" name="max_output_tokens"
                                           value="{{ model.max_output_tokens }}" required>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="default_temperature" class="form-label">
                                –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: <span id="temperatureValue">{{ model.default_temperature }}</span>
                            </label>
                            <input type="range" class="form-range" id="default_temperature" name="default_temperature"
                                   min="0" max="2" step="0.1" value="{{ model.default_temperature }}"
                                   oninput="document.getElementById('temperatureValue').textContent = this.value">
                            <div class="form-text">0 = –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, 2 = –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π</div>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="supports_system_prompt"
                                   name="supports_system_prompt" {% if model.supports_system_prompt %}checked{% endif %}>
                            <label class="form-check-label" for="supports_system_prompt">
                                –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã
                            </label>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="enable_thinking"
                                   name="enable_thinking" {% if model.enable_thinking %}checked{% endif %}>
                            <label class="form-check-label" for="enable_thinking">
                                <strong>üß† –í–∫–ª—é—á–∏—Ç—å Thinking Mode</strong>
                                <div class="form-text">–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å –ø–æ—à–∞–≥–æ–≤—ã–º–∏ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è–º–∏ (–¥–ª—è DeepSeek, DeepSeek-R1 –∏ –¥—Ä—É–≥–∏—Ö reasoning –º–æ–¥–µ–ª–µ–π)</div>
                            </label>
                        </div>
                    </div>

                    <!-- –†–µ–π—Ç–∏–Ω–≥–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
                    <div class="mb-4">
                        <h6 class="text-muted">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h6>
                        <hr>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="speed_rating" class="form-label">
                                        –°–∫–æ—Ä–æ—Å—Ç—å: <span id="speedValue">{{ model.speed_rating }}</span>‚ö°
                                    </label>
                                    <input type="range" class="form-range" id="speed_rating" name="speed_rating"
                                           min="1" max="5" step="1" value="{{ model.speed_rating }}"
                                           oninput="document.getElementById('speedValue').textContent = this.value">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="quality_rating" class="form-label">
                                        –ö–∞—á–µ—Å—Ç–≤–æ: <span id="qualityValue">{{ model.quality_rating }}</span>‚≠ê
                                    </label>
                                    <input type="range" class="form-range" id="quality_rating" name="quality_rating"
                                           min="1" max="5" step="1" value="{{ model.quality_rating }}"
                                           oninput="document.getElementById('qualityValue').textContent = this.value">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="cost_rating" class="form-label">
                                        –°—Ç–æ–∏–º–æ—Å—Ç—å: <span id="costValue">{{ model.cost_rating }}</span>üí∞
                                    </label>
                                    <input type="range" class="form-range" id="cost_rating" name="cost_rating"
                                           min="1" max="5" step="1" value="{{ model.cost_rating }}"
                                           oninput="document.getElementById('costValue').textContent = this.value">
                                    <div class="form-text">1 = –¥–æ—Ä–æ–≥–æ, 5 = –¥–µ—à–µ–≤–æ</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="recommended_for" class="form-label">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è</label>
                            <input type="text" class="form-control" id="recommended_for" name="recommended_for"
                                   value="{{ model.recommended_for | join(', ') if model.recommended_for else '' }}"
                                   placeholder="draft, final_translation, poetry, dialogue (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)">
                        </div>
                    </div>

                    <!-- –°—Ç–∞—Ç—É—Å -->
                    <div class="mb-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="is_active" name="is_active"
                                   {% if model.is_active %}checked{% endif %}>
                            <label class="form-check-label" for="is_active">
                                –ú–æ–¥–µ–ª—å –∞–∫—Ç–∏–≤–Ω–∞
                            </label>
                        </div>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∏ -->
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('main.ai_models') }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> –û—Ç–º–µ–Ω–∞
                        </a>
                        <div>
                            <button type="button" class="btn btn-info me-2" onclick="testModel()">
                                <i class="bi bi-play-circle"></i> –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ—Å–ª–µ–¥–Ω–µ–º —Ç–µ—Å—Ç–µ -->
        {% if model.last_tested_at %}
        <div class="card mt-3">
            <div class="card-body">
                <h6 class="card-title">–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h6>
                <p class="mb-0">
                    <small class="text-muted">
                        {{ model.last_tested_at.strftime('%d.%m.%Y %H:%M') }} -
                        {% if model.test_status == 'success' %}
                            <span class="text-success">–£—Å–ø–µ—à–Ω–æ</span>
                        {% elif model.test_status == 'failed' %}
                            <span class="text-danger">–û—à–∏–±–∫–∞</span>
                        {% else %}
                            <span class="text-warning">–ù–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª–∞—Å—å</span>
                        {% endif %}
                    </small>
                </p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–∞ -->
<div class="modal fade" id="testResultModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="testResultBody">
                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('editModelForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const data = {};

    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
    for (let [key, value] of formData.entries()) {
        if (key === 'recommended_for') {
            data[key] = value.split(',').map(s => s.trim()).filter(s => s);
        } else if (key === 'api_keys') {
            // –†–∞–∑–±–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π –ø–æ —Å—Ç—Ä–æ–∫–∞–º
            data[key] = value.split('\n').map(s => s.trim()).filter(s => s);
        } else if (key === 'is_active' || key === 'supports_system_prompt' || key === 'enable_thinking') {
            data[key] = true;
        } else if (value !== '') {
            data[key] = value;
        }
    }

    // –î–æ–±–∞–≤–ª—è–µ–º false –¥–ª—è –Ω–µ–æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö —á–µ–∫–±–æ–∫—Å–æ–≤
    if (!formData.has('is_active')) data.is_active = false;
    if (!formData.has('supports_system_prompt')) data.supports_system_prompt = false;
    if (!formData.has('enable_thinking')) data.enable_thinking = false;

    try {
        const response = await fetch(this.action, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            window.location.href = '{{ url_for("main.ai_models") }}';
        } else {
            const error = await response.json();
            alert('–û—à–∏–±–∫–∞: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
    }
});

async function testModel() {
    const testButton = event.target.closest('button');
    testButton.disabled = true;
    testButton.innerHTML = '<i class="bi bi-hourglass-split"></i> –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...';

    try {
        const response = await fetch(`/api/ai-models/{{ model.id }}/test`, {
            method: 'POST'
        });
        const result = await response.json();

        const modal = new bootstrap.Modal(document.getElementById('testResultModal'));
        const body = document.getElementById('testResultBody');

        if (result.success) {
            body.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> –ú–æ–¥–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
                </div>
                <p><strong>–¢–µ—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç:</strong></p>
                <pre class="bg-light p-2 rounded">${result.response}</pre>
            `;
        } else {
            body.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle"></i> –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                </div>
                <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏:</strong></p>
                <pre class="bg-light p-2 rounded text-danger">${result.error}</pre>
            `;
        }

        modal.show();
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ' + error.message);
    } finally {
        testButton.disabled = false;
        testButton.innerHTML = '<i class="bi bi-play-circle"></i> –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å';
    }
}
</script>
{% endblock %}