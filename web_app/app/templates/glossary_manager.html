{% extends "base.html" %}

{% block title %}–ú–µ–Ω–µ–¥–∂–µ—Ä –≥–ª–æ—Å—Å–∞—Ä–∏–µ–≤{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1>üî§ –ú–µ–Ω–µ–¥–∂–µ—Ä –≥–ª–æ—Å—Å–∞—Ä–∏–µ–≤</h1>
    
    <!-- –¢–∞–±—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π -->
    <ul class="nav nav-tabs mb-3" id="glossaryTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="extract-tab" data-bs-toggle="tab" data-bs-target="#extract" type="button">
                –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="copy-tab" data-bs-toggle="tab" data-bs-target="#copy" type="button">
                –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="merge-tab" data-bs-toggle="tab" data-bs-target="#merge" type="button">
                –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ
            </button>
        </li>
    </ul>
    
    <div class="tab-content" id="glossaryTabContent">
        <!-- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–∑ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã—Ö –≥–ª–∞–≤ -->
        <div class="tab-pane fade show active" id="extract" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5>üìñ –ò–∑–≤–ª–µ—á—å –≥–ª–æ—Å—Å–∞—Ä–∏–π –∏–∑ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã—Ö –≥–ª–∞–≤</h5>
                </div>
                <div class="card-body">
                    <form id="extractForm">
                        <div class="mb-3">
                            <label for="extractNovel" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–º–∞–Ω</label>
                            <select class="form-select" id="extractNovel" required>
                                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–º–∞–Ω --</option>
                                {% for novel in novels %}
                                <option value="{{ novel.id }}">
                                    {{ novel.title }} ({{ novel.translated_chapters }} –≥–ª–∞–≤)
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="minFrequency" class="form-label">
                                –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ –ø–æ—è–≤–ª–µ–Ω–∏—è
                            </label>
                            <input type="number" class="form-control" id="minFrequency" value="2" min="1">
                            <small class="text-muted">–¢–µ—Ä–º–∏–Ω—ã, –≤—Å—Ç—Ä–µ—á–∞—é—â–∏–µ—Å—è —Ä–µ–∂–µ, –±—É–¥—É—Ç –∏—Å–∫–ª—é—á–µ–Ω—ã</small>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search"></i> –ò–∑–≤–ª–µ—á—å —Ç–µ—Ä–º–∏–Ω—ã
                        </button>
                    </form>
                    
                    <div id="extractResults" class="mt-3" style="display: none;">
                        <h6>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–∑–≤–ª–µ—á–µ–Ω–∏—è:</h6>
                        <div id="extractStats"></div>
                        <button class="btn btn-success mt-2" id="saveExtracted">
                            <i class="bi bi-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –≥–ª–æ—Å—Å–∞—Ä–∏–π
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–∂–¥—É –∫–Ω–∏–≥–∞–º–∏ -->
        <div class="tab-pane fade" id="copy" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5>üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≥–ª–æ—Å—Å–∞—Ä–∏–π –º–µ–∂–¥—É –∫–Ω–∏–≥–∞–º–∏</h5>
                </div>
                <div class="card-body">
                    <form id="copyForm">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="sourceNovel" class="form-label">–ò—Å—Ç–æ—á–Ω–∏–∫</label>
                                <select class="form-select" id="sourceNovel" required>
                                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫ --</option>
                                    {% for novel in novels %}
                                    {% if novel.glossary_count > 0 %}
                                    <option value="{{ novel.id }}">
                                        {{ novel.title }} ({{ novel.glossary_count }} —Ç–µ—Ä–º–∏–Ω–æ–≤)
                                    </option>
                                    {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="targetNovel" class="form-label">–¶–µ–ª—å</label>
                                <select class="form-select" id="targetNovel" required>
                                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å --</option>
                                    {% for novel in novels %}
                                    <option value="{{ novel.id }}">
                                        {{ novel.title }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="characters" id="copyCharacters" checked>
                                <label class="form-check-label" for="copyCharacters">–ü–µ—Ä—Å–æ–Ω–∞–∂–∏</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="locations" id="copyLocations" checked>
                                <label class="form-check-label" for="copyLocations">–õ–æ–∫–∞—Ü–∏–∏</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="terms" id="copyTerms" checked>
                                <label class="form-check-label" for="copyTerms">–¢–µ—Ä–º–∏–Ω—ã</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="techniques" id="copyTechniques" checked>
                                <label class="form-check-label" for="copyTechniques">–¢–µ—Ö–Ω–∏–∫–∏</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="artifacts" id="copyArtifacts" checked>
                                <label class="form-check-label" for="copyArtifacts">–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã</label>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <label for="themeFilter" class="form-label">–¢–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ñ–∏–ª—å—Ç—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                            <select class="form-select" id="themeFilter">
                                <option value="">–ë–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞</option>
                                <option value="ballistics">–ë–∞–ª–ª–∏—Å—Ç–∏–∫–∞</option>
                                <option value="cultivation">–ö—É–ª—å—Ç–∏–≤–∞—Ü–∏—è</option>
                                <option value="military">–í–æ–µ–Ω–Ω–∞—è</option>
                                <option value="medicine">–ú–µ–¥–∏—Ü–∏–Ω–∞</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="btn btn-primary mt-3">
                            <i class="bi bi-files"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≥–ª–æ—Å—Å–∞—Ä–∏–π
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –≥–ª–æ—Å—Å–∞—Ä–∏–µ–≤ -->
        <div class="tab-pane fade" id="merge" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5>üîÄ –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≥–ª–æ—Å—Å–∞—Ä–∏–µ–≤</h5>
                </div>
                <div class="card-body">
                    <form id="mergeForm">
                        <div class="mb-3">
                            <label for="mergeTarget" class="form-label">–¶–µ–ª–µ–≤–æ–π —Ä–æ–º–∞–Ω</label>
                            <select class="form-select" id="mergeTarget" required>
                                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–º–∞–Ω --</option>
                                {% for novel in novels %}
                                <option value="{{ novel.id }}">{{ novel.title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è</label>
                            {% for novel in novels %}
                            {% if novel.glossary_count > 0 %}
                            <div class="form-check">
                                <input class="form-check-input merge-source" type="checkbox" 
                                       value="{{ novel.id }}" id="merge{{ novel.id }}">
                                <label class="form-check-label" for="merge{{ novel.id }}">
                                    {{ novel.title }} ({{ novel.glossary_count }} —Ç–µ—Ä–º–∏–Ω–æ–≤)
                                </label>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-arrow-down-up"></i> –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –≥–ª–æ—Å—Å–∞—Ä–∏–∏
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø–µ—Ä–∞—Ü–∏–π -->
    <div class="alert alert-info mt-3" id="operationResult" style="display: none;"></div>
</div>

<script>
// –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –≥–ª–æ—Å—Å–∞—Ä–∏—è
document.getElementById('extractForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const novelId = document.getElementById('extractNovel').value;
    const minFreq = document.getElementById('minFrequency').value;
    
    const response = await fetch(`/api/glossary/extract/${novelId}?min_frequency=${minFreq}`);
    const data = await response.json();
    
    if (data.success) {
        document.getElementById('extractStats').innerHTML = `
            <ul>
                ${Object.entries(data.stats).map(([cat, count]) => 
                    `<li>${cat}: ${count} —Ç–µ—Ä–º–∏–Ω–æ–≤</li>`
                ).join('')}
            </ul>
        `;
        document.getElementById('extractResults').style.display = 'block';
        document.getElementById('saveExtracted').dataset.novelId = novelId;
        document.getElementById('saveExtracted').dataset.glossary = JSON.stringify(data.glossary);
    }
});

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–≤–ª–µ—á–µ–Ω–Ω–æ–≥–æ –≥–ª–æ—Å—Å–∞—Ä–∏—è
document.getElementById('saveExtracted').addEventListener('click', async (e) => {
    const novelId = e.target.dataset.novelId;
    const glossary = JSON.parse(e.target.dataset.glossary);
    
    const response = await fetch(`/api/glossary/save-extracted/${novelId}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(glossary)
    });
    
    const data = await response.json();
    showResult(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${data.saved} –Ω–æ–≤—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤`);
});

// –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–ª–æ—Å—Å–∞—Ä–∏—è
document.getElementById('copyForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const categories = [];
    document.querySelectorAll('#copy input[type="checkbox"]:checked').forEach(cb => {
        categories.push(cb.value);
    });
    
    const params = {
        source: document.getElementById('sourceNovel').value,
        target: document.getElementById('targetNovel').value,
        categories: categories,
        theme: document.getElementById('themeFilter').value
    };
    
    const response = await fetch('/api/glossary/copy', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(params)
    });
    
    const data = await response.json();
    showResult(`–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ${data.copied} —Ç–µ—Ä–º–∏–Ω–æ–≤`);
});

// –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –≥–ª–æ—Å—Å–∞—Ä–∏–µ–≤
document.getElementById('mergeForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const sources = [];
    document.querySelectorAll('.merge-source:checked').forEach(cb => {
        sources.push(cb.value);
    });
    
    const params = {
        target: document.getElementById('mergeTarget').value,
        sources: sources
    };
    
    const response = await fetch('/api/glossary/merge', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(params)
    });
    
    const data = await response.json();
    showResult(`–û–±—ä–µ–¥–∏–Ω–µ–Ω–æ ${data.merged} —Ç–µ—Ä–º–∏–Ω–æ–≤`);
});

function showResult(message) {
    const alert = document.getElementById('operationResult');
    alert.textContent = message;
    alert.style.display = 'block';
    setTimeout(() => alert.style.display = 'none', 5000);
}
</script>
{% endblock %}