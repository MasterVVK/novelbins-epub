{% extends "base.html" %}

{% block title %}Редактировать {{ novel.title }} - Novel Translator{% endblock %}
{% block page_title %}Редактировать {{ novel.title }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-pencil-square"></i> Редактировать новеллу
                </h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="mb-3">
                        <label for="title" class="form-label">Название новеллы *</label>
                        <input type="text" class="form-control" id="title" name="title" value="{{ novel.title }}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="original_title" class="form-label">Оригинальное название</label>
                        <input type="text" class="form-control" id="original_title" name="original_title" value="{{ novel.original_title or '' }}">
                        <div class="form-text">Название на языке оригинала</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="author" class="form-label">Автор</label>
                        <input type="text" class="form-control" id="author" name="author" value="{{ novel.author or '' }}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="source_url" class="form-label" id="source_url_label">
                            {% if novel.source_type == 'epub' %}
                                Путь к EPUB файлу *
                            {% else %}
                                URL источника *
                            {% endif %}
                        </label>
                        <input type="{% if novel.source_type == 'epub' %}text{% else %}url{% endif %}" 
                               class="form-control" id="source_url" name="source_url" 
                               value="{{ novel.source_url }}" required
                               placeholder="{% if novel.source_type == 'epub' %}Путь к EPUB файлу{% else %}URL источника{% endif %}">
                        <div class="form-text" id="source_url_help">
                            {% if novel.source_type == 'epub' %}
                                Укажите полный путь к EPUB файлу на сервере
                            {% else %}
                                Ссылка на страницу новеллы
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="source_type" class="form-label">Тип источника</label>
                        <select class="form-select" id="source_type" name="source_type">
                            {% for source in available_sources %}
                            <option value="{{ source.id }}" 
                                    data-description="{{ source.description }}" 
                                    data-languages="{{ source.supported_languages|join(',') }}"
                                    data-example="{{ source.example_url }}"
                                    {{ 'selected' if novel.source_type == source.id else '' }}>
                                {{ source.name }}
                            </option>
                            {% endfor %}
                            <option value="novelbins" {{ 'selected' if novel.source_type == 'novelbins' else '' }}>NovelBins (Legacy)</option>
                            <option value="webnovel" {{ 'selected' if novel.source_type == 'webnovel' else '' }}>WebNovel (Legacy)</option>
                            <option value="other" {{ 'selected' if novel.source_type == 'other' else '' }}>Другой</option>
                        </select>
                        <div class="form-text">
                            <span id="source-description">{{ novel.source_type }} - выберите правильный тип источника для вашей новеллы</span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="prompt_template_id" class="form-label">Шаблон промпта</label>
                        <select class="form-select" id="prompt_template_id" name="prompt_template_id">
                            <option value="none" {{ 'selected' if not novel.prompt_template_id else '' }}>Без шаблона (по умолчанию)</option>
                            {% for template in prompt_templates %}
                            <option value="{{ template.id }}" {{ 'selected' if novel.prompt_template_id == template.id else '' }}>
                                {{ template.name }} ({{ template.category }})
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Выберите специальный шаблон промпта для перевода этой новеллы</div>
                    </div>
                    
                    <hr>
                    <h6 class="mb-3">Настройки парсинга</h6>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="max_chapters" class="form-label">Максимум глав</label>
                                <!-- Отладка: max_chapters = {{ novel.config.max_chapters if novel.config and novel.config.max_chapters else 'НЕТ ЗНАЧЕНИЯ' }} -->
                                <div class="input-group">
                                    <input type="number" class="form-control" id="max_chapters" name="max_chapters" 
                                           value="{{ novel.config.max_chapters if novel.config and novel.config.max_chapters else 100 }}" 
                                           min="1" max="1000" 
                                           {{ 'disabled style="background-color: #e9ecef;"' if novel.config and novel.config.all_chapters else '' }}>
                                </div>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="all_chapters" name="all_chapters" value="true"
                                           {{ 'checked' if novel.config and novel.config.all_chapters else '' }}>
                                    <label class="form-check-label" for="all_chapters">
                                        Все главы (игнорировать ограничение)
                                    </label>
                                </div>
                                <div class="form-text">Текущее значение: {{ novel.config.max_chapters if novel.config and novel.config.max_chapters else 'не установлено' }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="start_chapter" class="form-label">Начать с главы</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="start_chapter" name="start_chapter" 
                                           value="{{ novel.config.start_chapter if novel.config and novel.config.start_chapter else 1 }}" 
                                           min="0" max="1000">
                                    <span class="input-group-text">
                                        <i class="bi bi-play-fill"></i>
                                    </span>
                                </div>
                                <div class="form-text">
                                    {% if novel.source_type == 'epub' %}
                                        Пропустить служебные главы (Cover, Table of Contents). Обычно начинать с главы 1 или 3.
                                    {% else %}
                                        Номер главы, с которой начать парсинг (1 = первая глава)
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="request_delay" class="form-label">Задержка запросов (сек)</label>
                                <input type="number" class="form-control" id="request_delay" name="request_delay" 
                                       value="{{ novel.config.request_delay if novel.config and novel.config.request_delay else 1.0 }}" 
                                       min="0.1" max="10" step="0.1">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="filter_text" class="form-label">Фильтровать текст при парсинге</label>
                                <textarea class="form-control" id="filter_text" name="filter_text" rows="3" 
                                          placeholder="Введите текст для удаления (каждая строка - отдельный фильтр)">{{ novel.config.filter_text if novel.config and novel.config.filter_text else '' }}</textarea>
                                <div class="form-text">
                                    Текст, который будет автоматически удаляться из глав при парсинге. 
                                    Например: "Txt,Epub,Mobi www.qinkan.net" или рекламные ссылки.
                                    Каждая строка - отдельный текст для удаления.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    <h6 class="mb-3">🔐 Авторизация для парсинга</h6>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Для доступа к заблокированным главам:</strong>
                        <ol class="mb-0 mt-2">
                            <li>Зарегистрируйтесь на сайте-источнике (например, Qidian.com)</li>
                            <li>Войдите в аккаунт в браузере</li>
                            <li>Откройте Developer Tools (F12) → Network</li>
                            <li>Обновите страницу и скопируйте значение Cookie из заголовков</li>
                            <li>Вставьте cookies в поле ниже</li>
                        </ol>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="auth_enabled" name="auth_enabled" value="true"
                                   {{ 'checked' if novel.auth_enabled else '' }}>
                            <label class="form-check-label" for="auth_enabled">
                                <strong>Включить авторизацию</strong>
                            </label>
                        </div>
                        <div class="form-text">Использовать cookies для доступа к заблокированным главам</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="auth_cookies" class="form-label">Cookies для авторизации</label>
                        <textarea class="form-control" id="auth_cookies" name="auth_cookies" rows="3" 
                                  placeholder="Вставьте сюда cookies из браузера...">{{ novel.auth_cookies or '' }}</textarea>
                        <div class="form-text">
                            <strong>Пример:</strong> <code>sessionid=abc123; user_id=456; token=xyz789</code><br>
                            <strong>Статус:</strong> 
                            {% if novel.auth_enabled and novel.auth_cookies %}
                                <span class="text-success">✅ Авторизация активна</span>
                            {% else %}
                                <span class="text-muted">❌ Авторизация не настроена</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <hr>
                    <h6 class="mb-3">💎 VIP авторизация для премиум контента</h6>
                    
                    <div class="alert alert-success">
                        <i class="bi bi-star-fill"></i>
                        <strong>Для доступа к VIP/платным главам:</strong>
                        <ol class="mb-0 mt-2">
                            <li>Авторизуйтесь на сайте и <strong>купите/подпишитесь</strong> на VIP контент</li>
                            <li>Откройте VIP главу в браузере (убедитесь, что она доступна)</li>
                            <li>Откройте Developer Tools (F12) → Network</li>
                            <li>Обновите страницу и скопируйте <strong>VIP cookies</strong> из заголовков</li>
                            <li>Вставьте VIP cookies в поле ниже</li>
                        </ol>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="vip_cookies_enabled" name="vip_cookies_enabled" value="true"
                                   {{ 'checked' if novel.vip_cookies_enabled else '' }}>
                            <label class="form-check-label" for="vip_cookies_enabled">
                                <strong>Включить VIP авторизацию</strong>
                            </label>
                        </div>
                        <div class="form-text">Использовать специальные cookies для доступа к платным главам</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="vip_cookies" class="form-label">VIP Cookies для премиум контента</label>
                        <textarea class="form-control" id="vip_cookies" name="vip_cookies" rows="3" 
                                  placeholder="Вставьте сюда VIP cookies из браузера...">{{ novel.vip_cookies or '' }}</textarea>
                        <div class="form-text">
                            <strong>Важно:</strong> Должны содержать <code>w_tsfp</code>, <code>_csrfToken</code> и другие VIP параметры<br>
                            <strong>Статус:</strong> 
                            {% if novel.vip_cookies_enabled and novel.vip_cookies %}
                                <span class="text-success">✅ VIP авторизация активна</span>
                            {% else %}
                                <span class="text-muted">❌ VIP авторизация не настроена</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <hr>
                    <h6 class="mb-3">🌐 SOCKS прокси для обхода блокировок</h6>
                    
                    <div class="alert alert-warning">
                        <i class="bi bi-shield-exclamation"></i>
                        <strong>Для обхода WAF блокировок:</strong>
                        <ol class="mb-0 mt-2">
                            <li>Настройте SOCKS5 прокси-сервер (например, через VPN)</li>
                            <li>Укажите адрес прокси в формате <code>host:port</code></li>
                            <li>Прокси будет использоваться только для этой новеллы</li>
                            <li>Особенно полезно для китайских сайтов (Qidian, WebNovel)</li>
                        </ol>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="proxy_enabled" name="proxy_enabled" value="true"
                                   {{ 'checked' if novel.proxy_enabled else '' }}>
                            <label class="form-check-label" for="proxy_enabled">
                                <strong>Включить SOCKS прокси</strong>
                            </label>
                        </div>
                        <div class="form-text">Использовать SOCKS прокси для обхода геоблокировок и WAF</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="socks_proxy" class="form-label">SOCKS прокси (host:port)</label>
                        <input type="text" class="form-control" id="socks_proxy" name="socks_proxy" 
                               value="{{ novel.socks_proxy or '' }}" 
                               placeholder="192.168.1.100:1080">
                        <div class="form-text">
                            <strong>Пример:</strong> <code>192.168.0.61:1080</code> или <code>proxy.example.com:1080</code><br>
                            <strong>Статус:</strong> 
                            {% if novel.proxy_enabled and novel.socks_proxy %}
                                <span class="text-success">✅ SOCKS прокси активен: {{ novel.socks_proxy }}</span>
                            {% else %}
                                <span class="text-muted">❌ Прокси не настроен</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <hr>
                    <h6 class="mb-3">Настройки перевода</h6>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="translation_model" class="form-label">Модель перевода</label>
                                <select class="form-select" id="translation_model" name="translation_model">
                                    {% if ai_models %}
                                        {% for model in ai_models %}
                                            <option value="{{ model.model_id }}"
                                                    data-provider="{{ model.provider }}"
                                                    data-name="{{ model.name }}"
                                                    {{ 'selected' if novel.config and novel.config.translation_model == model.model_id else '' }}>
                                                {{ model.name }} ({{ model.provider|upper }})
                                                {% if model.is_default %}[По умолчанию]{% endif %}
                                            </option>
                                        {% endfor %}
                                    {% else %}
                                        <!-- Fallback на старые опции если моделей нет в базе -->
                                        <option value="gemini-2.5-flash"
                                                {{ 'selected' if not novel.config or novel.config.translation_model == 'gemini-2.5-flash' else '' }}>
                                            Gemini 2.5 Flash
                                        </option>
                                        <option value="gemini-2.5-pro"
                                                {{ 'selected' if novel.config and novel.config.translation_model == 'gemini-2.5-pro' else '' }}>
                                            Gemini 2.5 Pro
                                        </option>
                                        <option value="gpt-4o"
                                                {{ 'selected' if novel.config and novel.config.translation_model == 'gpt-4o' else '' }}>
                                            GPT-4o
                                        </option>
                                        <option value="claude-3-5-sonnet"
                                                {{ 'selected' if novel.config and novel.config.translation_model == 'claude-3-5-sonnet' else '' }}>
                                            Claude 3.5 Sonnet
                                        </option>
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="translation_temperature" class="form-label">Точность перевода</label>
                                <input type="number" class="form-control" id="translation_temperature" name="translation_temperature" 
                                       value="{{ novel.config.translation_temperature if novel.config and novel.config.translation_temperature else 0.1 }}" 
                                       min="0" max="1" step="0.1">
                                <div class="form-text">Точность перевода (0-1). 0 = максимальная точность, 1 = более свободный перевод</div>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    <h6 class="mb-3">📚 Настройки EPUB генерации</h6>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="epub_add_chapter_prefix" class="form-label">Добавление префикса к главам</label>
                                <select class="form-select" id="epub_add_chapter_prefix" name="epub_add_chapter_prefix">
                                    <option value="auto" {{ 'selected' if not novel.epub_add_chapter_prefix or novel.epub_add_chapter_prefix == 'auto' else '' }}>
                                        Автоматически (умное определение)
                                    </option>
                                    <option value="always" {{ 'selected' if novel.epub_add_chapter_prefix == 'always' else '' }}>
                                        Всегда добавлять
                                    </option>
                                    <option value="never" {{ 'selected' if novel.epub_add_chapter_prefix == 'never' else '' }}>
                                        Никогда не добавлять
                                    </option>
                                </select>
                                <div class="form-text">
                                    <strong>Автоматически:</strong> добавляет префикс только если его нет в названии<br>
                                    <strong>Всегда:</strong> всегда добавляет префикс "Глава X:"<br>
                                    <strong>Никогда:</strong> использует название как есть
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="epub_chapter_prefix_text" class="form-label">Текст префикса</label>
                                <input type="text" class="form-control" id="epub_chapter_prefix_text" name="epub_chapter_prefix_text" 
                                       value="{{ novel.epub_chapter_prefix_text or 'Глава' }}" 
                                       placeholder="Глава">
                                <div class="form-text">
                                    Текст, который будет использоваться в префиксе.<br>
                                    Например: "Глава", "Chapter", "Часть" и т.д.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    <h6 class="mb-3">Настройки редактирования</h6>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editing_quality_mode" class="form-label">Режим качества редактирования</label>
                                <select class="form-select" id="editing_quality_mode" name="editing_quality_mode">
                                    <option value="fast" {{ 'selected' if not novel.config or novel.config.editing_quality_mode == 'fast' else '' }}>
                                        Быстро (температура: 0.5)
                                    </option>
                                    <option value="balanced" {{ 'selected' if novel.config and novel.config.editing_quality_mode == 'balanced' else '' }}>
                                        Баланс (температура: 0.7)
                                    </option>
                                    <option value="quality" {{ 'selected' if novel.config and novel.config.editing_quality_mode == 'quality' else '' }}>
                                        Качество (температура: 0.9)
                                    </option>
                                </select>
                                <div class="form-text">Автоматически устанавливает температуру редактирования</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editing_temperature_display" class="form-label">Текущая температура редактирования</label>
                                <input type="text" class="form-control" id="editing_temperature_display" readonly 
                                       value="{{ novel.config.editing_temperature if novel.config and novel.config.editing_temperature else '0.7' }}">
                                <div class="form-text">Устанавливается автоматически в зависимости от режима качества</div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editing_threads" class="form-label">
                                    Количество параллельных потоков редактуры
                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Сколько глав обрабатывать одновременно (рекомендуется 2-5 для Ollama)"></i>
                                </label>
                                <input type="number" class="form-control" id="editing_threads" name="editing_threads"
                                       min="1" max="10" step="1"
                                       value="{{ novel.config.editing_threads if novel.config and novel.config.editing_threads else 3 }}">
                                <div class="form-text">По умолчанию: 3 потока. Больше потоков = быстрее, но выше нагрузка на сервер</div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('main.novel_detail', novel_id=novel.id) }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Назад
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Сохранить изменения
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Динамическое изменение поля source_url в зависимости от типа источника
document.getElementById('source_type').addEventListener('change', function() {
    const sourceType = this.value;
    const sourceUrlInput = document.getElementById('source_url');
    const sourceUrlLabel = document.getElementById('source_url_label');
    const sourceUrlHelp = document.getElementById('source_url_help');
    
    if (sourceType === 'epub') {
        sourceUrlInput.type = 'text';
        sourceUrlInput.placeholder = 'Путь к EPUB файлу';
        sourceUrlLabel.textContent = 'Путь к EPUB файлу *';
        sourceUrlHelp.textContent = 'Укажите полный путь к EPUB файлу на сервере';
    } else {
        sourceUrlInput.type = 'url';
        sourceUrlInput.placeholder = 'URL источника';
        sourceUrlLabel.textContent = 'URL источника *';
        sourceUrlHelp.textContent = 'Ссылка на страницу новеллы';
    }
});

// Автоматическое обновление температуры редактирования при выборе режима качества
document.getElementById('editing_quality_mode').addEventListener('change', function() {
    const mode = this.value;
    const temperatureDisplay = document.getElementById('editing_temperature_display');
    
    const temperatureMap = {
        'fast': 0.5,
        'balanced': 0.7,
        'quality': 0.9
    };
    
    if (temperatureMap[mode]) {
        temperatureDisplay.value = temperatureMap[mode];
    }
});

// Обработка чекбокса "все главы"
const allChaptersCheckbox = document.getElementById('all_chapters');
const maxChaptersInput = document.getElementById('max_chapters');

if (allChaptersCheckbox && maxChaptersInput) {
    allChaptersCheckbox.addEventListener('change', function() {
        if (this.checked) {
            maxChaptersInput.disabled = true;
            maxChaptersInput.style.backgroundColor = '#e9ecef';
        } else {
            maxChaptersInput.disabled = false;
            maxChaptersInput.style.backgroundColor = '';
        }
    });
}
</script>
{% endblock %} 