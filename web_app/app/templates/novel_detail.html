{% extends "base.html" %}

{% block title %}{{ novel.title }} - Novel Translator{% endblock %}
{% block page_title %}{{ novel.title }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <!-- Информация о новелле -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-info-circle"></i> Информация
                </h5>
                <div>
                    <a href="{{ url_for('main.edit_novel', novel_id=novel.id) }}" class="btn btn-outline-primary btn-sm me-2">
                        <i class="bi bi-pencil-square"></i> Редактировать
                    </a>
                    <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteNovelModal">
                        <i class="bi bi-trash"></i> Удалить
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Название:</strong> {{ novel.title }}</p>
                        {% if novel.author %}
                        <p><strong>Автор:</strong> {{ novel.author }}</p>
                        {% endif %}
                        <p><strong>Источник:</strong> {{ novel.source_type }}</p>
                        <p><strong>Статус:</strong> 
                            <span class="{{ novel.status|status_badge_class('novel') }}">
                                <i class="{{ novel.status|status_icon('novel') }}"></i>
                                {{ novel.status|status_text('novel') }}
                            </span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Всего глав:</strong> {{ novel.total_chapters }}</p>
                        <p><strong>Переведено:</strong> {{ novel.translated_chapters }}</p>
                        <p><strong>Отредактировано:</strong> {{ novel.edited_chapters }}</p>
                        <p><strong>Добавлена:</strong> {{ novel.created_at.strftime('%d.%m.%Y %H:%M') }}</p>
                        {% if novel.prompt_template %}
                        <p><strong>Шаблон промпта:</strong> {{ novel.prompt_template.name }}</p>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Прогресс по этапам -->
                <div class="mt-3">
                    <h6 class="text-muted mb-3">Прогресс по этапам:</h6>
                    
                    <!-- Парсинг -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted">
                                <i class="bi bi-download text-primary"></i> Парсинг
                            </small>
                            <small class="text-muted">{{ novel.parsed_chapters }}/{{ novel.total_chapters }} глав</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-primary" style="width: {{ novel.parsing_progress_percentage }}%"></div>
                        </div>
                        <small class="text-muted">{{ novel.parsing_progress_percentage }}%</small>
                    </div>
                    
                    <!-- Перевод -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted">
                                <i class="bi bi-translate text-success"></i> Перевод
                            </small>
                            <small class="text-muted">{{ novel.translated_chapters }}/{{ novel.total_chapters }} глав</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" style="width: {{ novel.progress_percentage }}%"></div>
                        </div>
                        <small class="text-muted">{{ novel.progress_percentage }}%</small>
                    </div>
                    
                    <!-- Редактура -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted">
                                <i class="bi bi-pencil-square text-warning"></i> Редактура
                            </small>
                            <small class="text-muted">{{ novel.edited_chapters }}/{{ novel.translated_chapters if novel.translated_chapters > 0 else novel.total_chapters }} глав</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-warning" style="width: {{ novel.editing_progress_percentage }}%"></div>
                        </div>
                        <small class="text-muted">{{ novel.editing_progress_percentage }}%</small>
                    </div>

                    <!-- Сопоставление -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted">
                                <i class="bi bi-diagram-3 text-info"></i> Сопоставление
                            </small>
                            <small class="text-muted">{{ novel.aligned_chapters or 0 }}/{{ novel.total_chapters }} глав</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-info" style="width: {{ novel.alignment_progress_percentage }}%"></div>
                        </div>
                        <small class="text-muted">{{ novel.alignment_progress_percentage }}%</small>
                    </div>
                </div>
                
                {% if novel.config %}
                <!-- Текущие настройки -->
                <div class="mt-3">
                    <h6 class="text-muted mb-2">Текущие настройки:</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted">
                                <!-- Отладка: novel.config = {{ novel.config }}, max_chapters = {{ novel.config.max_chapters if novel.config else 'НЕТ КОНФИГА' }} -->
                                <strong>Макс. глав:</strong> {{ novel.config.max_chapters if novel.config and novel.config.max_chapters else 10 }} | 
                                <strong>Задержка:</strong> {{ novel.config.request_delay if novel.config and novel.config.request_delay else 1.0 }}с
                            </small>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">
                                <strong>Модель:</strong> {{ novel.config.get('translation_model', 'gemini-2.5-flash') }} |
                                <strong>Температура:</strong> {{ novel.config.get('translation_temperature', 0.1) }}
                            </small>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Действия -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-gear"></i> Действия
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-2">
                        {% if novel.parsing_task_id %}
                        <!-- Кнопка отмены парсинга -->
                        <button type="button" onclick="cancelParsing({{ novel.id }})" class="btn btn-outline-danger w-100">
                            <i class="bi bi-stop-circle"></i> Отменить парсинг
                        </button>
                        {% else %}
                        <!-- Кнопка запуска парсинга -->
                        <form method="POST" action="{{ url_for('main.start_parsing', novel_id=novel.id) }}" style="display: inline;">
                            <button type="submit" class="btn btn-outline-primary w-100">
                                <i class="bi bi-download"></i> Парсинг
                            </button>
                        </form>
                        {% endif %}
                    </div>
                    <div class="col-md-3 mb-2">
                        <form method="POST" action="{{ url_for('main.start_translation', novel_id=novel.id) }}" style="display: inline;">
                            <button type="submit" class="btn btn-outline-success w-100">
                                <i class="bi bi-translate"></i> Перевод
                            </button>
                        </form>
                    </div>
                    <div class="col-md-3 mb-2">
                        {% if novel.editing_task_id %}
                            <button type="button" class="btn btn-outline-danger w-100" onclick="cancelEditing({{ novel.id }})">
                                <i class="bi bi-x-circle"></i> Отменить редактуру
                            </button>
                        {% else %}
                            <form method="POST" action="{{ url_for('main.start_editing', novel_id=novel.id) }}" style="display: inline;">
                                <button type="submit" class="btn btn-outline-warning w-100">
                                    <i class="bi bi-pencil-square"></i> Редактура
                                </button>
                            </form>
                        {% endif %}
                    </div>
                    <div class="col-md-3 mb-2">
                        <form method="POST" action="{{ url_for('main.generate_epub', novel_id=novel.id) }}" style="display: inline;">
                            <button type="submit" class="btn btn-outline-info w-100">
                                <i class="bi bi-file-earmark-text"></i> EPUB
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Вторая строка: билингвальные функции -->
                <div class="row mt-2">
                    <div class="col-md-6 mb-2">
                        {% if novel.alignment_task_id %}
                            <button type="button" class="btn btn-outline-danger w-100" onclick="cancelAlignment({{ novel.id }})">
                                <i class="bi bi-x-circle"></i> Отменить сопоставление
                            </button>
                        {% else %}
                            <form method="POST" action="{{ url_for('main.start_alignment', novel_id=novel.id) }}" style="display: inline; width: 100%;">
                                <button type="submit" class="btn btn-outline-info w-100">
                                    <i class="bi bi-diagram-3"></i> Сопоставление с оригиналом
                                </button>
                            </form>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-2">
                        <form method="POST" action="{{ url_for('main.generate_bilingual_epub', novel_id=novel.id) }}" style="display: inline;">
                            <button type="submit" class="btn btn-outline-secondary w-100"
                                    {% if novel.epub_generation_task_id or novel.status == 'generating_epub' %}disabled{% endif %}>
                                <i class="bi bi-book"></i>
                                {% if novel.epub_generation_task_id or novel.status == 'generating_epub' %}
                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                    Генерируется...
                                {% else %}
                                    Двуязычный EPUB (RU + 中文)
                                {% endif %}
                            </button>
                        </form>
                    </div>
                </div>

                <!-- EPUB статус -->
                {% set epub_tasks = tasks|selectattr('task_type', 'equalto', 'generate_epub')|list %}
                {% set epub_task = epub_tasks|sort(attribute='updated_at', reverse=true)|first if epub_tasks else none %}
                {% if epub_task %}
                <div class="mt-3">
                    <div class="alert alert-{{ 'success' if epub_task.status == 'completed' else 'warning' if epub_task.status == 'running' else 'danger' }}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-file-earmark-text"></i>
                                <strong>EPUB:</strong>
                                {% if epub_task.status == 'completed' %}
                                    Готов к скачиванию
                                {% elif epub_task.status == 'running' %}
                                    Создается...
                                {% else %}
                                    Ошибка: {{ epub_task.error_message or 'Неизвестная ошибка' }}
                                {% endif %}
                            </div>
                            {% if epub_task.status == 'completed' %}
                            <a href="{{ url_for('main.download_epub', novel_id=novel.id) }}" class="btn btn-success btn-sm">
                                <i class="bi bi-download"></i> Скачать
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Двуязычный EPUB статус -->
                {% if novel.epub_generation_task_id or novel.status in ['generating_epub', 'epub_generated', 'epub_generation_error', 'epub_generation_cancelled'] %}
                <div class="mt-3">
                    <div class="alert alert-{{ 'success' if novel.status == 'epub_generated' else 'warning' if novel.status == 'generating_epub' else 'danger' }}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-book"></i>
                                <strong>Двуязычный EPUB:</strong>
                                {% if novel.status == 'epub_generated' %}
                                    Готов к скачиванию
                                {% elif novel.status == 'generating_epub' %}
                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                    Создается... (смотрите логи в <a href="{{ url_for('main.console_test') }}" target="_blank">консоли</a>)
                                {% elif novel.status == 'epub_generation_cancelled' %}
                                    Отменено
                                {% else %}
                                    Ошибка при генерации
                                {% endif %}
                            </div>
                            <div>
                                {% if novel.status == 'epub_generated' and novel.epub_path %}
                                <a href="{{ url_for('main.download_bilingual_epub', novel_id=novel.id) }}" class="btn btn-success btn-sm">
                                    <i class="bi bi-download"></i> Скачать
                                </a>
                                {% endif %}
                                {% if novel.epub_generation_task_id %}
                                <button class="btn btn-danger btn-sm" onclick="cancelEpubGeneration({{ novel.id }})">
                                    <i class="bi bi-x-circle"></i> Отменить
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- VNC Viewer для наблюдения за парсингом -->
        {% if novel.parsing_task_id or novel.source_type == 'czbooks' %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-display"></i> Браузер парсера
                    {% if novel.status == 'parsing' %}
                    <span class="badge bg-success ms-2">
                        <i class="bi bi-broadcast"></i> Активен
                    </span>
                    {% endif %}
                    <button class="btn btn-sm btn-outline-secondary ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#vncViewer" aria-expanded="{{ 'true' if novel.status == 'parsing' else 'false' }}">
                        <i class="bi bi-arrows-angle-expand"></i> Показать/Скрыть
                    </button>
                </h5>
            </div>
            <div class="card-body collapse {{ 'show' if novel.status == 'parsing' else '' }}" id="vncViewer">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>VNC Трансляция:</strong> Здесь отображается браузер, который парсит czbooks.net.
                    Вы можете вручную пройти Cloudflare Turnstile challenge, если он появится.
                </div>
                <div style="border: 2px solid #ddd; border-radius: 8px; overflow: hidden; background: #000;">
                    <iframe
                        src="http://{{ request.host.split(':')[0] }}:6080/vnc.html?autoconnect=1&resize=scale"
                        style="width: 100%; height: 600px; border: none;"
                        allow="fullscreen"
                    ></iframe>
                </div>
                <div class="mt-2 text-muted small">
                    <i class="bi bi-lightbulb"></i>
                    <strong>Совет:</strong> Если видите Cloudflare challenge, кликните на галочку прямо в этом окне.
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Главы -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-list-ul"></i> Главы 
                    <span class="badge bg-secondary">{{ chapters_pagination.total if chapters_pagination else 0 }}</span>
                </h5>
                
                <!-- Настройки пагинации -->
                {% if chapters_pagination and chapters_pagination.total > 0 %}
                <div class="d-flex align-items-center">
                    <label for="per_page" class="form-label me-2 mb-0">Глав на странице:</label>
                    <select id="per_page" class="form-select form-select-sm" style="width: auto;" onchange="changePerPage(this.value)">
                        <option value="10" {{ 'selected' if per_page == 10 else '' }}>10</option>
                        <option value="25" {{ 'selected' if per_page == 25 else '' }}>25</option>
                        <option value="50" {{ 'selected' if per_page == 50 else '' }}>50</option>
                        <option value="100" {{ 'selected' if per_page == 100 else '' }}>100</option>
                        <option value="200" {{ 'selected' if per_page == 200 else '' }}>200</option>
                    </select>
                </div>
                {% endif %}
            </div>
            <div class="card-body">
                {% if chapters and chapters|length > 0 %}

                <!-- Пагинация сверху -->
                {% if chapters_pagination and chapters_pagination.pages > 1 %}
                <nav aria-label="Навигация по страницам глав" class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-muted">
                            Показано {{ chapters_pagination.first }} - {{ chapters_pagination.last }} из {{ chapters_pagination.total }} глав
                        </div>
                        <ul class="pagination pagination-sm mb-0">
                            <!-- Кнопка "Предыдущая" -->
                            {% if chapters_pagination.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('main.novel_detail', novel_id=novel.id, page=chapters_pagination.prev_num, per_page=per_page) }}">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link"><i class="bi bi-chevron-left"></i></span>
                            </li>
                            {% endif %}

                            <!-- Номера страниц -->
                            {% for page_num in chapters_pagination.iter_pages(left_edge=2, left_current=2, right_current=3, right_edge=2) %}
                                {% if page_num %}
                                    {% if page_num != chapters_pagination.page %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('main.novel_detail', novel_id=novel.id, page=page_num, per_page=per_page) }}">
                                            {{ page_num }}
                                        </a>
                                    </li>
                                    {% else %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                    {% endif %}
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                                {% endif %}
                            {% endfor %}

                            <!-- Кнопка "Следующая" -->
                            {% if chapters_pagination.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('main.novel_detail', novel_id=novel.id, page=chapters_pagination.next_num, per_page=per_page) }}">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link"><i class="bi bi-chevron-right"></i></span>
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                </nav>
                {% endif %}

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>№</th>
                                <th>Название</th>
                                <th>Статус</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for chapter in chapters %}
                            <tr>
                                <td>{{ chapter.chapter_number }}</td>
                                <td>
                                    {% if chapter.original_title %}
                                        {{ chapter.original_title }}
                                    {% else %}
                                        Глава {{ chapter.chapter_number }}
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="{{ chapter.status|status_badge_class('chapter') }}" id="status-badge-{{ chapter.id }}">
                                        <i class="{{ chapter.status|status_icon('chapter') }}" id="status-icon-{{ chapter.id }}"></i>
                                        <span id="status-text-{{ chapter.id }}">{{ chapter.status|status_text('chapter') }}</span>
                                    </span>
                                    <div class="btn-group btn-group-sm ms-2" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" title="Изменить статус">
                                            <i class="bi bi-gear"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="changeChapterStatus({{ chapter.id }}, 'parsed'); return false;">
                                                <i class="bi bi-check-circle text-info"></i> Спарсено
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="changeChapterStatus({{ chapter.id }}, 'translated'); return false;">
                                                <i class="bi bi-translate text-success"></i> Переведено
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="changeChapterStatus({{ chapter.id }}, 'edited'); return false;">
                                                <i class="bi bi-pencil-square text-warning"></i> Отредактировано
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="changeChapterStatus({{ chapter.id }}, 'aligned'); return false;">
                                                <i class="bi bi-diagram-3 text-info"></i> Сопоставлено
                                            </a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item" href="#" onclick="changeChapterStatus({{ chapter.id }}, 'pending'); return false;">
                                                <i class="bi bi-hourglass text-secondary"></i> В ожидании
                                            </a></li>
                                        </ul>
                                    </div>
                                </td>
                                <td>
                                    <a href="{{ url_for('main.chapter_detail', chapter_id=chapter.id) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    {% if chapter.status in ['translated', 'edited', 'aligned'] %}
                                    <a href="{{ url_for('main.edit_chapter', chapter_id=chapter.id) }}" class="btn btn-sm btn-outline-warning">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    {% endif %}
                                    <button type="button" class="btn btn-sm btn-outline-danger"
                                            data-bs-toggle="modal"
                                            data-bs-target="#deleteChapterModal{{ chapter.id }}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Пагинация -->
                {% if chapters_pagination and chapters_pagination.pages > 1 %}
                <nav aria-label="Навигация по страницам глав">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-muted">
                            Показано {{ chapters_pagination.first }} - {{ chapters_pagination.last }} из {{ chapters_pagination.total }} глав
                        </div>
                        <ul class="pagination pagination-sm mb-0">
                            <!-- Кнопка "Предыдущая" -->
                            {% if chapters_pagination.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('main.novel_detail', novel_id=novel.id, page=chapters_pagination.prev_num, per_page=per_page) }}">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link"><i class="bi bi-chevron-left"></i></span>
                            </li>
                            {% endif %}
                            
                            <!-- Номера страниц -->
                            {% for page_num in chapters_pagination.iter_pages(left_edge=2, left_current=2, right_current=3, right_edge=2) %}
                                {% if page_num %}
                                    {% if page_num != chapters_pagination.page %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('main.novel_detail', novel_id=novel.id, page=page_num, per_page=per_page) }}">
                                            {{ page_num }}
                                        </a>
                                    </li>
                                    {% else %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                    {% endif %}
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                                {% endif %}
                            {% endfor %}
                            
                            <!-- Кнопка "Следующая" -->
                            {% if chapters_pagination.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('main.novel_detail', novel_id=novel.id, page=chapters_pagination.next_num, per_page=per_page) }}">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link"><i class="bi bi-chevron-right"></i></span>
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                </nav>
                {% endif %}
                
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-file-text text-muted fs-1"></i>
                    <p class="text-muted mt-2">Главы не найдены</p>
                    <p class="text-muted">Запустите парсинг для получения глав</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Боковая панель -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-link-45deg"></i> Ссылки
                </h5>
            </div>
            <div class="card-body">
                {% if novel.source_url %}
                <a href="{{ novel.source_url }}" target="_blank" class="btn btn-outline-primary w-100 mb-2">
                    <i class="bi bi-box-arrow-up-right"></i> Открыть источник
                </a>
                {% endif %}

                {% if novel.source_type == 'czbooks.net' %}
                <button type="button" class="btn btn-outline-warning w-100 mb-2" onclick="openCookieExtractor()">
                    <i class="bi bi-key"></i> Получить Cloudflare Cookies
                </button>
                <small class="text-muted d-block mb-2">
                    <i class="bi bi-info-circle"></i> Используйте Browser Extension для обхода Cloudflare
                </small>
                {% endif %}

                <a href="{{ url_for('main.novel_glossary', novel_id=novel.id) }}" class="btn btn-outline-info w-100 mb-2">
                    <i class="bi bi-translate"></i> Глоссарий
                </a>

                <a href="{{ url_for('main.novels') }}" class="btn btn-outline-secondary w-100">
                    <i class="bi bi-arrow-left"></i> К списку новелл
                </a>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-clock-history"></i> История
                </h5>
            </div>
            <div class="card-body">
                <p><strong>Создана:</strong> {{ novel.created_at.strftime('%d.%m.%Y %H:%M') }}</p>
                <p><strong>Обновлена:</strong> {{ novel.updated_at.strftime('%d.%m.%Y %H:%M') }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Модальные окна подтверждения удаления глав -->
{% for chapter in chapters %}
<div class="modal fade" id="deleteChapterModal{{ chapter.id }}" tabindex="-1" aria-labelledby="deleteChapterModalLabel{{ chapter.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteChapterModalLabel{{ chapter.id }}">
                    <i class="bi bi-exclamation-triangle text-danger"></i> Подтверждение удаления
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Вы уверены, что хотите удалить главу {{ chapter.chapter_number }}?</p>
                <p class="text-muted">Глава будет полностью удалена вместе со всей историей промптов. Восстановление невозможно.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <form method="POST" action="{{ url_for('main.delete_chapter', chapter_id=chapter.id) }}" style="display: inline;">
                    <!-- Сохраняем параметры пагинации при удалении -->
                    <input type="hidden" name="return_page" value="{{ current_page }}">
                    <input type="hidden" name="return_per_page" value="{{ per_page }}">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Удалить
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Модальное окно подтверждения удаления -->
<div class="modal fade" id="deleteNovelModal" tabindex="-1" aria-labelledby="deleteNovelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteNovelModalLabel">
                    <i class="bi bi-exclamation-triangle text-danger"></i> Подтверждение удаления
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Вы действительно хотите удалить новеллу <strong>"{{ novel.title }}"</strong>?</p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Внимание!</strong> Новелла будет перемещена в корзину. При этом:
                    <ul class="mb-0 mt-2">
                        <li>Все главы новеллы ({{ novel.total_chapters }}) будут сохранены</li>
                        <li>Все задачи, связанные с новеллой, останутся</li>
                        <li>Весь глоссарий новеллы будет сохранен</li>
                        <li>Все настройки и конфигурация останутся</li>
                        <li>Новеллу можно будет восстановить позже</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Отмена
                </button>
                <form method="POST" action="{{ url_for('main.delete_novel', novel_id=novel.id) }}" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Удалить новеллу
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript для пагинации -->
<script>
function changePerPage(perPage) {
    // Сохраняем текущую страницу или переходим на первую
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('per_page', perPage);
    urlParams.set('page', '1'); // Всегда переходим на первую страницу при изменении количества

    // Перенаправляем на новую страницу
    window.location.href = window.location.pathname + '?' + urlParams.toString();
}

function openCookieExtractor() {
    alert('Инструкция по использованию Browser Extension:\n\n' +
          '1. Убедитесь что Browser Extension установлен\n' +
          '2. Кликните на иконку расширения в панели Chrome\n' +
          '3. Нажмите кнопку "Автоматически получить Cookies"\n' +
          '4. Подождите ~10 секунд\n' +
          '5. Cookies будут автоматически отправлены в Web App\n\n' +
          'Если расширение не установлен:\n' +
          'Перейдите на страницу скачивания: {{ url_for("main.download_extension") }}');
}

// Отмена парсинга через API
async function cancelParsing(novelId) {
    if (!confirm('Вы уверены, что хотите отменить парсинг?')) {
        return;
    }

    try {
        const response = await fetch(`/api/novels/${novelId}/parse/cancel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            alert('✅ Парсинг успешно отменён');
            location.reload(); // Перезагружаем страницу
        } else {
            alert('❌ Ошибка: ' + (data.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        alert('❌ Ошибка при отмене парсинга: ' + error.message);
    }
}

// Отмена редактуры
async function cancelEditing(novelId) {
    if (!confirm('Вы уверены, что хотите отменить редактуру? Текущий прогресс будет сохранён, но незавершённые главы не будут отредактированы.')) {
        return;
    }

    try {
        const response = await fetch(`/api/novels/${novelId}/edit/cancel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            alert('✅ Редактура успешно отменена');
            location.reload(); // Перезагружаем страницу
        } else {
            alert('❌ Ошибка: ' + (data.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        alert('❌ Ошибка при отмене редактуры: ' + error.message);
    }
}

async function cancelAlignment(novelId) {
    if (!confirm('Вы уверены, что хотите отменить сопоставление? Текущий прогресс будет сохранён, но незавершённые главы не будут сопоставлены.')) {
        return;
    }

    try {
        const response = await fetch(`/api/novels/${novelId}/alignment/cancel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            alert('✅ Сопоставление успешно отменено');
            location.reload(); // Перезагружаем страницу
        } else {
            alert('❌ Ошибка: ' + (data.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        alert('❌ Ошибка при отмене выравнивания: ' + error.message);
    }
}

// Отмена генерации EPUB
async function cancelEpubGeneration(novelId) {
    if (!confirm('Вы уверены, что хотите отменить генерацию EPUB?')) {
        return;
    }

    try {
        const response = await fetch(`/api/novels/${novelId}/generate-epub/cancel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            alert('✅ Генерация EPUB успешно отменена');
            location.reload(); // Перезагружаем страницу
        } else {
            alert('❌ Ошибка: ' + (data.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        alert('❌ Ошибка при отмене генерации EPUB: ' + error.message);
    }
}

// Изменение статуса главы
async function changeChapterStatus(chapterId, newStatus) {
    try {
        const response = await fetch(`/api/chapters/${chapterId}/status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: newStatus })
        });

        const data = await response.json();

        if (data.success) {
            // Обновляем UI
            updateStatusBadge(chapterId, newStatus);

            // Показываем уведомление
            showNotification('Статус главы обновлен', 'success');

            // Перезагружаем страницу через небольшую задержку для обновления счетчиков
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('Ошибка: ' + (data.error || 'Неизвестная ошибка'), 'error');
        }
    } catch (error) {
        showNotification('Ошибка при изменении статуса: ' + error.message, 'error');
    }
}

// Обновление значка статуса
function updateStatusBadge(chapterId, newStatus) {
    const statusMap = {
        'pending': {
            badge: 'badge bg-secondary',
            icon: 'bi bi-hourglass',
            text: 'В ожидании'
        },
        'parsed': {
            badge: 'badge bg-info',
            icon: 'bi bi-check-circle',
            text: 'Спарсено'
        },
        'translated': {
            badge: 'badge bg-success',
            icon: 'bi bi-translate',
            text: 'Переведено'
        },
        'edited': {
            badge: 'badge bg-warning',
            icon: 'bi bi-pencil-square',
            text: 'Отредактировано'
        },
        'error': {
            badge: 'badge bg-danger',
            icon: 'bi bi-exclamation-triangle',
            text: 'Ошибка'
        }
    };

    const status = statusMap[newStatus];
    if (status) {
        const badgeEl = document.getElementById(`status-badge-${chapterId}`);
        const iconEl = document.getElementById(`status-icon-${chapterId}`);
        const textEl = document.getElementById(`status-text-${chapterId}`);

        if (badgeEl) badgeEl.className = status.badge;
        if (iconEl) iconEl.className = status.icon;
        if (textEl) textEl.textContent = status.text;
    }
}

// Показать уведомление
function showNotification(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', alertHtml);

    // Автоматически скрыть через 3 секунды
    setTimeout(() => {
        const alerts = document.querySelectorAll('.alert');
        if (alerts.length > 0) {
            alerts[alerts.length - 1].remove();
        }
    }, 3000);
}

// Автоматически прокрутить к VNC viewer при активном парсинге
{% if novel.status == 'parsing' %}
document.addEventListener('DOMContentLoaded', function() {
    // Небольшая задержка для завершения анимации разворота
    setTimeout(() => {
        const vncViewer = document.getElementById('vncViewer');
        if (vncViewer) {
            vncViewer.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });

            // Подсветка блока для привлечения внимания
            const vncCard = vncViewer.closest('.card');
            if (vncCard) {
                vncCard.style.boxShadow = '0 0 20px rgba(25, 135, 84, 0.5)';
                setTimeout(() => {
                    vncCard.style.boxShadow = '';
                }, 2000);
            }
        }
    }, 500);
});
{% endif %}

// ============================================================================
// Real-time UI Updates через AJAX Polling
// ============================================================================

let pollingInterval = null;
let previousStatus = null;

/**
 * Опрашивает API для получения актуального статуса новеллы
 */
async function pollNovelStatus(novelId) {
    try {
        const response = await fetch(`/api/novels/${novelId}/status`);
        const data = await response.json();

        if (data.success) {
            updateUIFromStatus(data);

            // Останавливаем polling если нет активных задач
            if (!data.has_active_tasks && pollingInterval) {
                console.log('✅ Все задачи завершены, останавливаем polling');
                stopPolling();

                // Показываем уведомление
                showNotification('Все задачи завершены!', 'success');
            }
        }
    } catch (error) {
        console.error('Ошибка при опросе статуса:', error);
    }
}

/**
 * Обновляет UI на основе полученного статуса
 */
function updateUIFromStatus(data) {
    const novelId = data.novel_id;

    // 1. Обновляем счетчики глав
    updateChapterCounts(data.progress);

    // 2. Обновляем прогресс-бары
    updateProgressBars(data.progress);

    // 3. Обновляем кнопки действий
    updateActionButtons(novelId, data.tasks);

    // 4. Обновляем статус EPUB
    updateEpubStatus(novelId, data.status, data.tasks.epub_generation, data.epub_path);

    // Сохраняем текущий статус для следующей итерации
    previousStatus = data;
}

/**
 * Обновляет счетчики глав в информационной карточке
 */
function updateChapterCounts(progress) {
    // Находим элементы с текстом через селекторы
    const rows = document.querySelectorAll('.card-body .row .col-md-6 p');

    rows.forEach(p => {
        const text = p.textContent;

        if (text.includes('Всего глав:')) {
            p.innerHTML = `<strong>Всего глав:</strong> ${progress.total_chapters}`;
        } else if (text.includes('Переведено:')) {
            p.innerHTML = `<strong>Переведено:</strong> ${progress.translated_chapters}`;
        } else if (text.includes('Отредактировано:')) {
            p.innerHTML = `<strong>Отредактировано:</strong> ${progress.edited_chapters}`;
        }
    });
}

/**
 * Обновляет все прогресс-бары
 */
function updateProgressBars(progress) {
    // Парсинг
    updateProgressBar('parsing', progress.parsed_chapters, progress.total_chapters, progress.parsing_percentage);

    // Перевод
    updateProgressBar('translation', progress.translated_chapters, progress.total_chapters, progress.translation_percentage);

    // Редактура
    const editingTotal = progress.translated_chapters > 0 ? progress.translated_chapters : progress.total_chapters;
    updateProgressBar('editing', progress.edited_chapters, editingTotal, progress.editing_percentage);

    // Сопоставление
    updateProgressBar('alignment', progress.aligned_chapters, progress.total_chapters, progress.alignment_percentage);
}

/**
 * Обновляет один прогресс-бар
 */
function updateProgressBar(type, current, total, percentage) {
    // Ищем прогресс-бар по содержимому (иконки)
    const icons = {
        'parsing': 'bi-download',
        'translation': 'bi-translate',
        'editing': 'bi-pencil-square',
        'alignment': 'bi-diagram-3'
    };

    const icon = document.querySelector(`.${icons[type]}`);
    if (!icon) return;

    // Находим родительский контейнер с прогресс-баром
    const container = icon.closest('.mb-3');
    if (!container) return;

    // Обновляем текст счетчика
    const counterText = container.querySelector('.d-flex .text-muted:last-child');
    if (counterText) {
        counterText.textContent = `${current}/${total} глав`;
    }

    // Обновляем прогресс-бар
    const progressBar = container.querySelector('.progress-bar');
    if (progressBar) {
        progressBar.style.width = `${percentage}%`;
    }

    // Обновляем процент
    const percentText = container.querySelector('small.text-muted:last-child');
    if (percentText) {
        percentText.textContent = `${percentage}%`;
    }
}

/**
 * Обновляет кнопки действий (показывает/скрывает кнопки отмены, disabled состояния)
 */
function updateActionButtons(novelId, tasks) {
    // Парсинг
    updateTaskButton('parsing', tasks.parsing, novelId, 'парсинг', 'Парсинг', 'download');

    // Редактура
    updateTaskButton('editing', tasks.editing, novelId, 'редактуру', 'Редактура', 'pencil-square');

    // Сопоставление
    updateTaskButton('alignment', tasks.alignment, novelId, 'сопоставление', 'Сопоставление с оригиналом', 'diagram-3');
}

/**
 * Обновляет одну кнопку задачи (парсинг/редактура/сопоставление)
 */
function updateTaskButton(taskType, taskId, novelId, cancelText, buttonText, iconName) {
    const cancelFunctions = {
        'parsing': 'cancelParsing',
        'editing': 'cancelEditing',
        'alignment': 'cancelAlignment'
    };

    // Находим контейнер кнопки (col-md-3 или col-md-6)
    const buttons = document.querySelectorAll('button, form');
    let targetContainer = null;

    buttons.forEach(el => {
        const text = el.textContent || el.querySelector('button')?.textContent || '';
        if (text.includes(buttonText) || text.includes(`Отменить ${cancelText}`)) {
            targetContainer = el.closest('.col-md-3, .col-md-6');
        }
    });

    if (!targetContainer) return;

    // Если есть активная задача - показываем кнопку отмены
    if (taskId) {
        targetContainer.innerHTML = `
            <button type="button" class="btn btn-outline-danger w-100" onclick="${cancelFunctions[taskType]}(${novelId})">
                <i class="bi bi-x-circle"></i> Отменить ${cancelText}
            </button>
        `;
    } else {
        // Если задачи нет - показываем кнопку запуска
        const routes = {
            'parsing': `/novels/${novelId}/parse`,
            'editing': `/novels/${novelId}/edit`,
            'alignment': `/novels/${novelId}/alignment`
        };

        const colors = {
            'parsing': 'primary',
            'editing': 'warning',
            'alignment': 'info'
        };

        targetContainer.innerHTML = `
            <form method="POST" action="${routes[taskType]}" style="display: inline; width: 100%;">
                <button type="submit" class="btn btn-outline-${colors[taskType]} w-100">
                    <i class="bi bi-${iconName}"></i> ${buttonText}
                </button>
            </form>
        `;
    }
}

/**
 * Обновляет статус генерации двуязычного EPUB
 */
function updateEpubStatus(novelId, novelStatus, epubTaskId, epubPath) {
    // Обновляем кнопку генерации EPUB
    const epubButton = document.querySelector('button[type="submit"]:has(.bi-book)') ||
                       document.querySelector('form button:has(.bi-book)');

    if (epubButton) {
        const isGenerating = epubTaskId || novelStatus === 'generating_epub';

        epubButton.disabled = isGenerating;

        if (isGenerating) {
            epubButton.innerHTML = `
                <i class="bi bi-book"></i>
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                Генерируется...
            `;
        } else {
            epubButton.innerHTML = `
                <i class="bi bi-book"></i>
                Двуязычный EPUB (RU + 中文)
            `;
        }
    }

    // Обновляем блок статуса EPUB (если существует)
    // Находим alert с текстом "Двуязычный EPUB"
    const alerts = document.querySelectorAll('.alert');
    let epubAlert = null;

    alerts.forEach(alert => {
        if (alert.textContent.includes('Двуязычный EPUB')) {
            epubAlert = alert;
        }
    });

    if (epubAlert) {
        // Обновляем существующий alert
        if (novelStatus === 'epub_generated') {
            epubAlert.className = 'alert alert-success';
            epubAlert.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi bi-book"></i>
                        <strong>Двуязычный EPUB:</strong>
                        Готов к скачиванию
                    </div>
                    <div>
                        <a href="/novels/${novelId}/download-bilingual-epub" class="btn btn-success btn-sm">
                            <i class="bi bi-download"></i> Скачать
                        </a>
                    </div>
                </div>
            `;
        } else if (novelStatus === 'generating_epub') {
            epubAlert.className = 'alert alert-warning';
            epubAlert.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi bi-book"></i>
                        <strong>Двуязычный EPUB:</strong>
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        Создается... (смотрите логи в <a href="/console-test" target="_blank">консоли</a>)
                    </div>
                    <div>
                        <button class="btn btn-danger btn-sm" onclick="cancelEpubGeneration(${novelId})">
                            <i class="bi bi-x-circle"></i> Отменить
                        </button>
                    </div>
                </div>
            `;
        }
    }
}

/**
 * Запускает polling
 */
function startPolling(novelId, intervalMs = 2000) {
    if (pollingInterval) {
        console.log('⚠️ Polling уже запущен');
        return;
    }

    console.log(`🔄 Запускаем polling для новеллы ${novelId} (интервал: ${intervalMs}ms)`);

    // Первый запрос сразу
    pollNovelStatus(novelId);

    // Затем каждые intervalMs миллисекунд
    pollingInterval = setInterval(() => {
        pollNovelStatus(novelId);
    }, intervalMs);
}

/**
 * Останавливает polling
 */
function stopPolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
        console.log('🛑 Polling остановлен');
    }
}

// Автоматически запускаем polling при загрузке страницы если есть активные задачи
document.addEventListener('DOMContentLoaded', function() {
    const novelId = {{ novel.id }};
    const hasActiveTasks = {{ 'true' if (novel.parsing_task_id or novel.editing_task_id or novel.alignment_task_id or novel.epub_generation_task_id) else 'false' }};

    if (hasActiveTasks) {
        console.log('✅ Обнаружены активные задачи, запускаем polling');
        startPolling(novelId, 2000); // Опрашиваем каждые 2 секунды
    } else {
        console.log('ℹ️ Активных задач нет, polling не требуется');
    }
});

// Останавливаем polling при уходе со страницы
window.addEventListener('beforeunload', function() {
    stopPolling();
});

</script>
{% endblock %} 