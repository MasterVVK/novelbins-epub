{% extends "base.html" %}

{% block title %}–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–µ–ª–ª—É - Novel Translator{% endblock %}
{% block page_title %}–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–µ–ª–ª—É{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-plus-circle"></i> –ù–æ–≤–∞—è –Ω–æ–≤–µ–ª–ª–∞
                </h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="mb-3">
                        <label for="title" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–µ–ª–ª—ã *</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="source_url" class="form-label">URL –∏—Å—Ç–æ—á–Ω–∏–∫–∞ *</label>
                        <div class="input-group">
                            <input type="url" class="form-control" id="source_url" name="source_url" required>
                            <button type="button" class="btn btn-outline-secondary" id="detect-source-btn">
                                <i class="bi bi-search"></i> –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å
                            </button>
                        </div>
                        <div class="form-text">–°—Å—ã–ª–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–æ–≤–µ–ª–ª—ã</div>
                        <div id="detection-result" class="mt-2" style="display: none;"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="source_type" class="form-label">–¢–∏–ø –∏—Å—Ç–æ—á–Ω–∏–∫–∞</label>
                        <select class="form-select" id="source_type" name="source_type">
                            {% for source in available_sources %}
                            <option value="{{ source.id }}" 
                                    data-description="{{ source.description }}" 
                                    data-languages="{{ source.supported_languages|join(',') }}"
                                    data-example="{{ source.example_url }}">
                                {{ source.name }}
                            </option>
                            {% endfor %}
                            <option value="novelbins">NovelBins (Legacy)</option>
                        </select>
                        <div class="form-text">
                            <span id="source-description">–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="auto_detect" name="auto_detect" value="true">
                            <label class="form-check-label" for="auto_detect">
                                –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫ –ø–æ URL
                            </label>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="max_chapters" class="form-label">–ú–∞–∫—Å–∏–º—É–º –≥–ª–∞–≤</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="max_chapters" name="max_chapters" value="100" min="1" max="1000">
                                </div>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="all_chapters" name="all_chapters" value="true">
                                    <label class="form-check-label" for="all_chapters">
                                        –í—Å–µ –≥–ª–∞–≤—ã (–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ)
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="request_delay" class="form-label">–ó–∞–¥–µ—Ä–∂–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ (—Å–µ–∫)</label>
                                <input type="number" class="form-control" id="request_delay" name="request_delay" value="1.0" min="0.1" max="10" step="0.1">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="translation_model" class="form-label">–ú–æ–¥–µ–ª—å –ø–µ—Ä–µ–≤–æ–¥–∞</label>
                                <select class="form-select" id="translation_model" name="translation_model">
                                    <option value="gemini-2.5-flash-preview-05-20">Gemini 2.5 Flash</option>
                                    <option value="gpt-4o">GPT-4o</option>
                                    <option value="claude-3-5-sonnet">Claude 3.5 Sonnet</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="translation_temperature" class="form-label">–¢–æ—á–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–≤–æ–¥–∞</label>
                                <input type="number" class="form-control" id="translation_temperature" name="translation_temperature" value="0.1" min="0" max="1" step="0.1">
                                <div class="form-text">–¢–æ—á–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–≤–æ–¥–∞ (0-1). 0 = –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å, 1 = –±–æ–ª–µ–µ —Å–≤–æ–±–æ–¥–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editing_quality_mode" class="form-label">–†–µ–∂–∏–º –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</label>
                                <select class="form-select" id="editing_quality_mode" name="editing_quality_mode">
                                    <option value="fast">–ë—ã—Å—Ç—Ä–æ (—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: 0.5)</option>
                                    <option value="balanced" selected>–ë–∞–ª–∞–Ω—Å (—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: 0.7)</option>
                                    <option value="quality">–ö–∞—á–µ—Å—Ç–≤–æ (—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: 0.9)</option>
                                </select>
                                <div class="form-text">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editing_temperature_display" class="form-label">–¢–µ–∫—É—â–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</label>
                                <input type="text" class="form-control" id="editing_temperature_display" readonly value="0.7">
                                <div class="form-text">–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞ –∫–∞—á–µ—Å—Ç–≤–∞</div>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    <h6 class="mb-3">üåê SOCKS –ø—Ä–æ–∫—Å–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</h6>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>–î–ª—è –∫–∏—Ç–∞–π—Å–∫–∏—Ö —Å–∞–π—Ç–æ–≤ (Qidian, WebNovel):</strong>
                        SOCKS –ø—Ä–æ–∫—Å–∏ –ø–æ–º–æ–∂–µ—Ç –æ–±–æ–π—Ç–∏ –≥–µ–æ–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏ WAF. –û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–µ–Ω.
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="proxy_enabled" name="proxy_enabled" value="true">
                                    <label class="form-check-label" for="proxy_enabled">
                                        <strong>–í–∫–ª—é—á–∏—Ç—å SOCKS –ø—Ä–æ–∫—Å–∏</strong>
                                    </label>
                                </div>
                                <div class="form-text">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ–∫—Å–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="socks_proxy" class="form-label">SOCKS –ø—Ä–æ–∫—Å–∏ (host:port)</label>
                                <input type="text" class="form-control" id="socks_proxy" name="socks_proxy" 
                                       placeholder="192.168.0.61:1080">
                                <div class="form-text">
                                    <strong>–ü—Ä–∏–º–µ—Ä:</strong> <code>192.168.0.61:1080</code>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('main.novels') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–µ–ª–ª—É
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const sourceTypeSelect = document.getElementById('source_type');
    const sourceUrlInput = document.getElementById('source_url');
    const detectBtn = document.getElementById('detect-source-btn');
    const detectionResult = document.getElementById('detection-result');
    const sourceDescription = document.getElementById('source-description');
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∏–ø–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
    sourceTypeSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const description = selectedOption.dataset.description || '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
        const languages = selectedOption.dataset.languages || '';
        const example = selectedOption.dataset.example || '';
        
        let text = description;
        if (languages) {
            text += ` (–Ø–∑—ã–∫–∏: ${languages})`;
        }
        if (example) {
            text += ` –ü—Ä–∏–º–µ—Ä: ${example}`;
        }
        
        sourceDescription.textContent = text;
    });
    
    // –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
    detectBtn.addEventListener('click', async function() {
        const url = sourceUrlInput.value.trim();
        
        if (!url) {
            showDetectionResult('–í–≤–µ–¥–∏—Ç–µ URL –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞', 'warning');
            return;
        }
        
        detectBtn.disabled = true;
        detectBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> –û–ø—Ä–µ–¥–µ–ª—è–µ–º...';
        
        try {
            const response = await fetch('/api/detect-source', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ url: url })
            });
            
            const data = await response.json();
            
            if (data.detected) {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫
                sourceTypeSelect.value = data.source;
                sourceTypeSelect.dispatchEvent(new Event('change'));
                
                showDetectionResult(
                    `‚úÖ –û–ø—Ä–µ–¥–µ–ª–µ–Ω –∏—Å—Ç–æ—á–Ω–∏–∫: <strong>${data.info.name}</strong><br>
                     <small>${data.info.description}</small>`, 
                    'success'
                );
            } else {
                showDetectionResult(
                    `‚ùå ${data.message || '–ò—Å—Ç–æ—á–Ω–∏–∫ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω'}`, 
                    'warning'
                );
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞:', error);
            showDetectionResult('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞', 'danger');
        } finally {
            detectBtn.disabled = false;
            detectBtn.innerHTML = '<i class="bi bi-search"></i> –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å';
        }
    });
    
    function showDetectionResult(message, type) {
        detectionResult.innerHTML = `<div class="alert alert-${type} alert-sm mb-0">${message}</div>`;
        detectionResult.style.display = 'block';
        
        // –°–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            detectionResult.style.display = 'none';
        }, 10000);
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
    sourceTypeSelect.dispatchEvent(new Event('change'));
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ–∫–±–æ–∫—Å–∞ "–≤—Å–µ –≥–ª–∞–≤—ã"
    const allChaptersCheckbox = document.getElementById('all_chapters');
    const maxChaptersInput = document.getElementById('max_chapters');
    
    if (allChaptersCheckbox && maxChaptersInput) {
        allChaptersCheckbox.addEventListener('change', function() {
            if (this.checked) {
                maxChaptersInput.disabled = true;
                maxChaptersInput.style.backgroundColor = '#e9ecef';
            } else {
                maxChaptersInput.disabled = false;
                maxChaptersInput.style.backgroundColor = '';
            }
        });
    }
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ä–µ–∂–∏–º–∞ –∫–∞—á–µ—Å—Ç–≤–∞
    const editingQualityMode = document.getElementById('editing_quality_mode');
    const editingTempDisplay = document.getElementById('editing_temperature_display');
    
    if (editingQualityMode && editingTempDisplay) {
        editingQualityMode.addEventListener('change', function() {
            const tempMap = {
                'fast': '0.5',
                'balanced': '0.7',
                'quality': '0.9'
            };
            editingTempDisplay.value = tempMap[this.value] || '0.7';
        });
    }
});
</script>
{% endblock %} 