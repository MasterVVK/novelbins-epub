{% extends "base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ AI –º–æ–¥–µ–ª—è–º–∏ - Novel Translator{% endblock %}
{% block page_title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ AI –º–æ–¥–µ–ª—è–º–∏{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <p class="text-muted mb-0">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –º–æ–¥–µ–ª–∏ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</p>
            </div>
            <div>
                <button class="btn btn-success" onclick="window.location.href='{{ url_for('main.new_ai_model') }}'">
                    <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –º–æ–¥–µ–ª—å
                </button>
                <button class="btn btn-info ms-2" onclick="testAllModels()">
                    <i class="bi bi-arrow-clockwise"></i> –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ
                </button>
            </div>
        </div>

        <!-- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º -->
        {% set providers = models | groupby('provider') %}

        {% for provider, provider_models in providers %}
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    {% if provider == 'gemini' %}
                        <i class="bi bi-google"></i> Google Gemini
                    {% elif provider == 'openai' %}
                        <i class="bi bi-cpu"></i> OpenAI
                    {% elif provider == 'anthropic' %}
                        <i class="bi bi-robot"></i> Anthropic
                    {% elif provider == 'ollama' %}
                        <i class="bi bi-pc-display"></i> Ollama (–õ–æ–∫–∞–ª—å–Ω—ã–µ)
                    {% else %}
                        <i class="bi bi-cloud"></i> {{ provider | title }}
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th width="25%">–ú–æ–¥–µ–ª—å</th>
                                <th width="15%">ID –º–æ–¥–µ–ª–∏</th>
                                <th width="20%">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</th>
                                <th width="15%">–¢–æ–∫–µ–Ω—ã</th>
                                <th width="10%">–°—Ç–∞—Ç—É—Å</th>
                                <th width="15%">–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for model in provider_models %}
                            <tr id="model-row-{{ model.id }}">
                                <td>
                                    <strong>{{ model.name }}</strong>
                                    {% if model.is_default %}
                                        <span class="badge bg-primary ms-1">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</span>
                                    {% endif %}
                                    {% if model.description %}
                                        <br><small class="text-muted">{{ model.description }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <code>{{ model.model_id }}</code>
                                    {% if model.api_type %}
                                        <br><small class="text-muted">{{ model.api_type }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="d-flex gap-3">
                                        <div title="–°–∫–æ—Ä–æ—Å—Ç—å">
                                            <i class="bi bi-speedometer2"></i>
                                            {{ '‚ö°' * model.speed_rating }}
                                        </div>
                                        <div title="–ö–∞—á–µ—Å—Ç–≤–æ">
                                            <i class="bi bi-star"></i>
                                            {{ '‚≠ê' * model.quality_rating }}
                                        </div>
                                        <div title="–°—Ç–æ–∏–º–æ—Å—Ç—å">
                                            <i class="bi bi-currency-dollar"></i>
                                            {{ 'üí∞' * (6 - model.cost_rating) }}
                                        </div>
                                    </div>
                                    {% if model.recommended_for %}
                                        <small class="text-success d-block mt-1">
                                            <i class="bi bi-check-circle"></i>
                                            {{ model.recommended_for | join(', ') }}
                                        </small>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>
                                        –í—Ö–æ–¥: {{ (model.max_input_tokens / 1000) | int }}k<br>
                                        –í—ã—Ö–æ–¥: {{ (model.max_output_tokens / 1000) | int }}k
                                    </small>
                                </td>
                                <td>
                                    <div class="d-flex flex-column align-items-start">
                                        {% if model.is_active %}
                                            <span class="badge bg-success mb-1">–ê–∫—Ç–∏–≤–Ω–∞</span>
                                        {% else %}
                                            <span class="badge bg-secondary mb-1">–ù–µ–∞–∫—Ç–∏–≤–Ω–∞</span>
                                        {% endif %}

                                        <span id="test-status-{{ model.id }}" class="badge
                                            {% if model.test_status == 'success' %}bg-info
                                            {% elif model.test_status == 'failed' %}bg-danger
                                            {% else %}bg-warning{% endif %}">
                                            {% if model.test_status == 'success' %}
                                                <i class="bi bi-check-circle"></i> –†–∞–±–æ—Ç–∞–µ—Ç
                                            {% elif model.test_status == 'failed' %}
                                                <i class="bi bi-x-circle"></i> –û—à–∏–±–∫–∞
                                            {% else %}
                                                <i class="bi bi-question-circle"></i> –ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞
                                            {% endif %}
                                        </span>

                                        {% if model.api_key_required %}
                                            {% if model.api_keys %}
                                                <small class="text-success mt-1">
                                                    <i class="bi bi-key-fill"></i> {{ model.api_keys | length }} –∫–ª—é—á–µ–π
                                                </small>
                                            {% elif model.api_key %}
                                                <small class="text-success mt-1">
                                                    <i class="bi bi-key-fill"></i> API –∫–ª—é—á
                                                </small>
                                            {% else %}
                                                <small class="text-danger mt-1">
                                                    <i class="bi bi-key"></i> –ù–µ—Ç –∫–ª—é—á–∞
                                                </small>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-primary" onclick="testModel({{ model.id }})"
                                                title="–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                            <i class="bi bi-play-circle"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary"
                                                onclick="window.location.href='{{ url_for('main.edit_ai_model', model_id=model.id) }}'"
                                                title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        {% if not model.is_default %}
                                            <button class="btn btn-outline-success" onclick="setAsDefault({{ model.id }})"
                                                    title="–°–¥–µ–ª–∞—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é">
                                                <i class="bi bi-star"></i>
                                            </button>
                                        {% endif %}
                                        {% if not model.is_default %}
                                            <button class="btn btn-outline-danger" onclick="deleteModel({{ model.id }})"
                                                    title="–£–¥–∞–ª–∏—Ç—å">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endfor %}

        {% if not models %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            –ù–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π. <a href="{{ url_for('main.new_ai_model') }}">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é –º–æ–¥–µ–ª—å</a>
        </div>
        {% endif %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–∞ -->
<div class="modal fade" id="testResultModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="testResultBody">
                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
async function testModel(modelId) {
    const statusBadge = document.getElementById(`test-status-${modelId}`);
    statusBadge.innerHTML = '<i class="bi bi-hourglass-split"></i> –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...';
    statusBadge.className = 'badge bg-info';

    try {
        const response = await fetch(`/api/ai-models/${modelId}/test`, {
            method: 'POST'
        });
        const result = await response.json();

        if (result.success) {
            statusBadge.innerHTML = '<i class="bi bi-check-circle"></i> –†–∞–±–æ—Ç–∞–µ—Ç';
            statusBadge.className = 'badge bg-success';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            showTestResult(true, result.response, result.model_info);
        } else {
            statusBadge.innerHTML = '<i class="bi bi-x-circle"></i> –û—à–∏–±–∫–∞';
            statusBadge.className = 'badge bg-danger';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
            showTestResult(false, result.error, result.available_models);
        }
    } catch (error) {
        statusBadge.innerHTML = '<i class="bi bi-x-circle"></i> –û—à–∏–±–∫–∞';
        statusBadge.className = 'badge bg-danger';
        showTestResult(false, error.message);
    }
}

function showTestResult(success, message, additionalInfo) {
    const modal = new bootstrap.Modal(document.getElementById('testResultModal'));
    const body = document.getElementById('testResultBody');

    if (success) {
        body.innerHTML = `
            <div class="alert alert-success">
                <i class="bi bi-check-circle"></i> –ú–æ–¥–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
            </div>
            <p><strong>–¢–µ—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç:</strong></p>
            <pre class="bg-light p-2 rounded">${message}</pre>
            ${additionalInfo ? `<p class="text-muted">–ú–æ–¥–µ–ª—å: ${additionalInfo.model}</p>` : ''}
        `;
    } else {
        body.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-x-circle"></i> –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            </div>
            <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏:</strong></p>
            <pre class="bg-light p-2 rounded text-danger">${message}</pre>
            ${additionalInfo ? `
                <p><strong>–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏ Ollama:</strong></p>
                <ul>${additionalInfo.map(m => `<li>${m}</li>`).join('')}</ul>
            ` : ''}
        `;
    }

    modal.show();
}

async function testAllModels() {
    const models = document.querySelectorAll('[id^="model-row-"]');
    for (const row of models) {
        const modelId = row.id.replace('model-row-', '');
        await testModel(modelId);
        await new Promise(resolve => setTimeout(resolve, 1000)); // –ü–∞—É–∑–∞ –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏
    }
}

async function setAsDefault(modelId) {
    if (!confirm('–°–¥–µ–ª–∞—Ç—å —ç—Ç—É –º–æ–¥–µ–ª—å –º–æ–¥–µ–ª—å—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?')) return;

    try {
        const response = await fetch(`/api/ai-models/${modelId}/set-default`, {
            method: 'POST'
        });

        if (response.ok) {
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –º–æ–¥–µ–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
    }
}

async function deleteModel(modelId) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –º–æ–¥–µ–ª—å? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;

    try {
        const response = await fetch(`/api/ai-models/${modelId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            location.reload();
        } else {
            const error = await response.json();
            alert('–û—à–∏–±–∫–∞: ' + error.message);
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
    }
}
</script>
{% endblock %}