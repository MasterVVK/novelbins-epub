# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–∞ –≤ web_app

## üîß **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —É–ø—É—â–µ–Ω–∏—è**

### 1. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–≤—É–∫–æ–≤—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤** ‚úÖ
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Ç–µ—Ä—è–Ω–∞ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–≤—É–∫–æ–≤—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ —Ç–∏–ø–∞ "Ahhhh" ‚Üí "–ê—Ö..."

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `preprocess_chapter_text()` –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞:
```python
def preprocess_chapter_text(text: str) -> str:
    """–ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –≥–ª–∞–≤—ã –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å —Ç–æ–∫–µ–Ω–∏–∑–∞—Ü–∏–µ–π"""
    
    # –°–ª–æ–≤–∞—Ä—å –∑–∞–º–µ–Ω –¥–ª—è –∑–≤—É–∫–æ–≤—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
    sound_effects = {
        r'W[oO]{3,}': 'Wooo...',
        r'A[hH]{3,}': 'Ahhh...',
        r'E[eE]{3,}': 'Eeee...',
        r'O[hH]{3,}': 'Ohhh...',
        # ... –∏ –¥—Ä—É–≥–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
    }
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º –∑–∞–º–µ–Ω—ã
    for pattern, replacement in sound_effects.items():
        text, count = re.subn(pattern, replacement, text, flags=re.IGNORECASE)
```

### 2. **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –Ω–µ—Ä–∞–±–æ—Ç–∞—é—â–∏—Ö –∫–ª—é—á–µ–π** ‚úÖ
**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–æ–∂–µ—Ç –∑–∞—Ü–∏–∫–ª–∏—Ç—å—Å—è –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –Ω–µ—Ä–∞–±–æ—Ç–∞—é—â–∏—Ö –∫–ª—é—á–µ–π

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ —É–º–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:
```python
def handle_full_cycle_failure(self):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏—Ç—É–∞—Ü–∏–∏, –∫–æ–≥–¥–∞ –≤—Å–µ –∫–ª—é—á–∏ –Ω–µ—Ä–∞–±–æ—Ç–∞—é—â–∏–µ"""
    self.full_cycles_without_success += 1
    
    if self.full_cycles_without_success >= 3:
        print(f"‚ùå 3 –ø–æ–ª–Ω—ã—Ö —Ü–∏–∫–ª–∞ –±–µ–∑ —É—Å–ø–µ—Ö–∞. –û–∂–∏–¥–∞–Ω–∏–µ 5 –º–∏–Ω—É—Ç...")
        time.sleep(300)  # 5 –º–∏–Ω—É—Ç
        self.reset_failed_keys()
        self.full_cycles_without_success = 0
    else:
        print(f"‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ 30 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π...")
        time.sleep(30)
        self.reset_failed_keys()
```

### 3. **Retry –ª–æ–≥–∏–∫–∞** ‚úÖ
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–µ—Ç–∞–ª—å–Ω–∞—è retry –ª–æ–≥–∏–∫–∞:
- **–°–µ—Ä–≤–µ—Ä–Ω—ã–µ –æ—à–∏–±–∫–∏ (5xx):** –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —Å —Ç–µ–º –∂–µ –∫–ª—é—á–æ–º —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
- **–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –æ—à–∏–±–∫–∏ (4xx):** –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –¥—Ä—É–≥–æ–π –∫–ª—é—á
- **–¢–∞–π–º–∞—É—Ç—ã:** –û–∂–∏–¥–∞–Ω–∏–µ 10 —Å–µ–∫—É–Ω–¥, —Å–º–µ–Ω–∞ –∫–ª—é—á–∞ –ø–æ—Å–ª–µ 3 —Ç–∞–π–º–∞—É—Ç–æ–≤
- **–°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏:** –û–∂–∏–¥–∞–Ω–∏–µ 5 —Å–µ–∫—É–Ω–¥

### 4. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤** ‚úÖ
**–ü—Ä–æ–±–ª–µ–º–∞:** –¢–µ—Ä—è–µ—Ç—Å—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–Ω–∞ –º–æ–¥–µ–ª—å `PromptHistory` –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:
- –°–∏—Å—Ç–µ–º–Ω—ã—Ö –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–æ–º–ø—Ç–æ–≤
- –û—Ç–≤–µ—Ç–æ–≤ API
- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (–∫–ª—é—á, –º–æ–¥–µ–ª—å, —Ç–æ–∫–µ–Ω—ã, –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)
- –°—Ç–∞—Ç—É—Å–∞ —É—Å–ø–µ—Ö–∞/–æ—à–∏–±–∫–∏

```python
class PromptHistory(db.Model):
    """–ú–æ–¥–µ–ª—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–æ–º–ø—Ç–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤"""
    chapter_id = Column(Integer, ForeignKey('chapters.id'))
    prompt_type = Column(String(50))  # translation, summary, terms_extraction
    system_prompt = Column(Text)
    user_prompt = Column(Text)
    response = Column(Text)
    api_key_index = Column(Integer)
    model_used = Column(String(100))
    success = Column(db.Boolean, default=True)
    error_message = Column(Text)
```

### 5. **–î–µ—Ç–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ API** ‚úÖ
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç —Å–ø–µ—Ü–∏—Ñ–∏–∫–∏ –¥–ª—è 503, quota –∏ –¥—Ä—É–≥–∏—Ö –æ—à–∏–±–æ–∫

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–µ—Ç–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞:
```python
elif response.status_code >= 500:
    # –°–µ—Ä–≤–µ—Ä–Ω—ã–µ –æ—à–∏–±–∫–∏ (500, 502, 503) - –ø—Ä–æ–±–ª–µ–º–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Google
    print(f"‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä–Ω–∞—è –æ—à–∏–±–∫–∞ Google ({response.status_code}). –û–∂–∏–¥–∞–Ω–∏–µ 30 —Å–µ–∫—É–Ω–¥...")
    time.sleep(30)
    
    # –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —Å —Ç–µ–º –∂–µ –∫–ª—é—á–æ–º
    retry_response = self.client.post(...)
    
elif response.status_code == 429:
    # Rate limit - –ø–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏ –∏–∑ –æ—Ç–≤–µ—Ç–∞
    try:
        error_data = response.json()
        if "error" in error_data:
            error_msg = error_data["error"].get("message", "")
            if "quota" in error_msg.lower():
                print(f"–¢–∏–ø –ª–∏–º–∏—Ç–∞: –∫–≤–æ—Ç–∞")
            elif "rate" in error_msg.lower():
                print(f"–¢–∏–ø –ª–∏–º–∏—Ç–∞: —á–∞—Å—Ç–æ—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤")
    except:
        pass
```

## üöÄ **–ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏**

–î–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```bash
cd web_app
python migrate_prompt_history.py
```

## üìä **–£–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞**

### **–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:**
- ‚ùå –ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏—Å—å
- ‚ùå –ó–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–µ –ø—Ä–∏ –Ω–µ—Ä–∞–±–æ—Ç–∞—é—â–∏—Ö –∫–ª—é—á–∞—Ö
- ‚ùå –ù–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- ‚ùå –ü–æ—Ç–µ—Ä—è –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–æ–º–ø—Ç–æ–≤
- ‚ùå –ë–∞–∑–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### **–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:**
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–≤—É–∫–æ–≤—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
- ‚úÖ –£–º–Ω–∞—è —Ä–æ—Ç–∞—Ü–∏—è –∫–ª—é—á–µ–π —Å –æ–∂–∏–¥–∞–Ω–∏–µ–º
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–∞—è retry –ª–æ–≥–∏–∫–∞
- ‚úÖ –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- ‚úÖ –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫

## üîç **–û—Ç–ª–∞–¥–∫–∞**

–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–æ–º–ø—Ç–æ–≤:

```python
from app.models import PromptHistory

# –ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è –≥–ª–∞–≤—ã
history = PromptHistory.get_chapter_history(chapter_id=123)

# –ò—Å—Ç–æ—Ä–∏—è —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–≤–æ–¥–æ–≤
translations = PromptHistory.get_chapter_history(chapter_id=123, prompt_type='translation')

# –ê–Ω–∞–ª–∏–∑ –æ—à–∏–±–æ–∫
failed_prompts = PromptHistory.query.filter_by(success=False).all()
```

## üìà **–†–µ–∑—É–ª—å—Ç–∞—Ç**

–í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ç–µ–ø–µ—Ä—å –∏–º–µ–µ—Ç **–ø–æ–ª–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å** –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫–∞ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ —É–ª—É—á—à–µ–Ω–∏—è–º–∏:

1. **–ú–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞**
2. **–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å**
3. **–°–∏—Å—Ç–µ–º–∞ –∑–∞–¥–∞—á**
4. **–†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
5. **–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏** 