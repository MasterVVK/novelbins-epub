# Улучшения системы перевода

## Обзор

Система перевода была значительно улучшена и теперь включает:

1. **Шаблоны промптов** - возможность создавать и управлять кастомными промптами для разных жанров
2. **Система глоссария** - автоматическое извлечение и управление терминами
3. **Улучшенный переводчик** - интеграция с корневыми скриптами
4. **API endpoints** - полный REST API для управления

## Новые возможности

### 1. Шаблоны промптов

#### Что это?
Шаблоны промптов позволяют создавать специализированные инструкции для перевода разных типов литературы.

#### Доступные шаблоны по умолчанию:
- **Сянься (Покрывая Небеса)** - для китайских веб-новелл жанра сянься
- **Уся (Боевые Искусства)** - для веб-новелл жанра уся
- **Современный Роман** - для современной литературы

#### Возможности:
- ✅ Создание новых шаблонов
- ✅ Копирование существующих шаблонов
- ✅ Редактирование промптов
- ✅ Установка шаблона по умолчанию
- ✅ Категоризация по жанрам

#### API endpoints:
```
GET    /api/prompt-templates/templates          # Список всех шаблонов
GET    /api/prompt-templates/templates/{id}     # Получение шаблона
POST   /api/prompt-templates/templates          # Создание шаблона
PUT    /api/prompt-templates/templates/{id}     # Обновление шаблона
DELETE /api/prompt-templates/templates/{id}     # Удаление шаблона
POST   /api/prompt-templates/templates/{id}/copy # Копирование шаблона
POST   /api/prompt-templates/templates/{id}/set-default # Установка по умолчанию
```

### 2. Система глоссария

#### Что это?
Автоматическая система извлечения и управления терминами для обеспечения консистентности перевода.

#### Категории терминов:
- **Персонажи** - имена и титулы персонажей
- **Локации** - места, города, священные земли
- **Термины** - общие термины и понятия
- **Техники** - боевые приемы и заклинания
- **Артефакты** - оружие, сокровища, реликвии

#### Возможности:
- ✅ Автоматическое извлечение новых терминов
- ✅ Ручное добавление терминов
- ✅ Поиск и фильтрация
- ✅ Статистика использования
- ✅ Импорт/экспорт глоссария
- ✅ Поиск похожих терминов

#### API endpoints:
```
GET    /api/glossary/novels/{id}/glossary       # Получение глоссария
POST   /api/glossary/novels/{id}/glossary/terms # Добавление термина
PUT    /api/glossary/glossary/terms/{id}        # Обновление термина
DELETE /api/glossary/glossary/terms/{id}        # Удаление термина
GET    /api/glossary/novels/{id}/glossary/search # Поиск терминов
GET    /api/glossary/novels/{id}/glossary/similar # Поиск похожих
GET    /api/glossary/novels/{id}/glossary/statistics # Статистика
```

### 3. Улучшенный переводчик

#### Новые возможности:
- ✅ Использование шаблонов промптов
- ✅ Автоматическое извлечение терминов
- ✅ Контекст из предыдущих глав
- ✅ Валидация качества перевода
- ✅ Разбивка длинных текстов
- ✅ Ротация API ключей
- ✅ Обработка ошибок

#### Процесс перевода:
1. **Загрузка шаблона** - получение промпта для новеллы
2. **Создание контекста** - резюме предыдущих глав + глоссарий
3. **Предобработка текста** - очистка и подготовка
4. **Разбивка на части** - для длинных глав
5. **Перевод частей** - с использованием промпта и контекста
6. **Извлечение терминов** - автоматическое добавление в глоссарий
7. **Валидация** - проверка качества перевода
8. **Сохранение** - запись в базу данных

## Установка и настройка

### 1. Инициализация базы данных

```bash
cd web_app
python init_db.py
```

### 2. Запуск приложения

```bash
# Из корня проекта
./start_web.sh

# Или из папки web_app
python run.py
```

### 3. Настройка API ключей

В настройках системы укажите:
- `GEMINI_API_KEYS` - ключи для Google Gemini (через запятую)
- `PROXY_URL` - прокси для API запросов (опционально)

## Использование

### 1. Создание новеллы

1. Перейдите в раздел "Новеллы" → "Добавить новеллу"
2. Заполните информацию о новелле
3. Выберите шаблон промпта (или оставьте по умолчанию)

### 2. Управление глоссарием

1. Откройте страницу новеллы
2. Перейдите в раздел "Глоссарий"
3. Добавляйте термины вручную или они будут извлекаться автоматически

### 3. Запуск перевода

1. На странице новеллы нажмите "Перевести"
2. Система автоматически:
   - Использует выбранный шаблон промпта
   - Загружает контекст из предыдущих глав
   - Применяет глоссарий
   - Извлекает новые термины

### 4. Управление шаблонами

1. Перейдите в "Настройки" → "Шаблоны промптов"
2. Создавайте, редактируйте и копируйте шаблоны
3. Устанавливайте шаблоны по умолчанию

## Структура файлов

```
web_app/
├── app/
│   ├── models/
│   │   ├── prompt_template.py    # Модель шаблонов промптов
│   │   └── glossary.py          # Обновленная модель глоссария
│   ├── services/
│   │   ├── translator_service.py # Улучшенный сервис перевода
│   │   ├── prompt_template_service.py # Сервис шаблонов
│   │   └── glossary_service.py  # Сервис глоссария
│   └── api/
│       ├── prompt_templates.py   # API для шаблонов
│       └── glossary.py          # API для глоссария
├── init_db.py                   # Инициализация БД
└── README_TRANSLATION_IMPROVEMENTS.md
```

## Интеграция с корневыми скриптами

Система интегрирована с корневыми скриптами:

- **Промпты** - основаны на `2_translator_improved.py`
- **Логика перевода** - адаптирована из корневых скриптов
- **Глоссарий** - совместим с системой из корневых скриптов

## Дальнейшие улучшения

### Планируемые функции:
1. **Сервис редактуры** - интеграция с `3_editor.py`
2. **Генератор EPUB** - интеграция с `4_epub_generator.py`
3. **Система уведомлений** - уведомления о завершении задач
4. **Аналитика** - статистика качества переводов
5. **Экспорт/импорт** - перенос данных между проектами

### Возможности для расширения:
1. **Поддержка других API** - OpenAI, Claude, etc.
2. **Многоязычность** - перевод на другие языки
3. **Машинное обучение** - улучшение качества на основе обратной связи
4. **Коллаборация** - совместная работа над переводами
5. **Версионирование** - история изменений переводов

## Поддержка

При возникновении проблем:

1. Проверьте логи в консоли
2. Убедитесь в корректности API ключей
3. Проверьте наличие шаблона промпта для новеллы
4. Инициализируйте базу данных заново при необходимости

## Примеры использования

### Создание кастомного шаблона

```python
from app.services.prompt_template_service import PromptTemplateService

template_data = {
    'name': 'Мой шаблон',
    'description': 'Кастомный шаблон для перевода',
    'category': 'custom',
    'translation_prompt': 'Ты переводчик...',
    'summary_prompt': 'Создай резюме...',
    'terms_extraction_prompt': 'Извлеки термины...',
    'temperature': 0.1,
    'max_tokens': 24000
}

template = PromptTemplateService.create_template(template_data)
```

### Добавление термина в глоссарий

```python
from app.services.glossary_service import GlossaryService

term = GlossaryService.add_term(
    novel_id=1,
    english_term='Ye Fan',
    russian_term='Е Фань',
    category='characters',
    description='Главный герой',
    chapter_number=1
)
```

### Запуск перевода

```python
from app.services.translator_service import TranslatorService

translator = TranslatorService()
chapter = Chapter.query.get(1)
success = translator.translate_chapter(chapter)
``` 